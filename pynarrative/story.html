<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>pynarrative.story API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pynarrative.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pynarrative</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Story">Story</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Story.__init__">Story</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.chart">chart</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.font">font</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.base_font_size">base_font_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.story_layers">story_layers</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.font_sizes">font_sizes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.colors">colors</a>
                        </li>
                        <li>
                                <a class="variable" href="#Story.config">config</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.add_title">add_title</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.add_context">add_context</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.add_next_step">add_next_step</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.add_annotation">add_annotation</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.em_to_px">em_to_px</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.create_title_layer">create_title_layer</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.create_text_layer">create_text_layer</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.configure_view">configure_view</a>
                        </li>
                        <li>
                                <a class="function" href="#Story.render">render</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#story">story</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pynarrative.html">pynarrative</a><wbr>.story    </h1>

                
                        <input id="mod-story-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-story-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">altair</span> <span class="k">as</span> <span class="nn">alt</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="k">class</span> <span class="nc">Story</span><span class="p">:</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">    Story class: Implements a structure for creating narrative views of data.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">    </span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">    This class extends the functionality of Altair to include narrative elements</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">    such as titles, contexts, call-to-action and annotations. It is designed to facilitate</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">    the creation of more engaging and informative data visualisations.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">base_font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">        Initialise a Story object.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">        Parameters:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">        - data: DataFrame or URL for graph data  (default: None)</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">        - width: Graph width in pixels (default: 600)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">        - height: Height of the graph in pixels (default: 400)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">        - font: Font to be used for all text elements (default: &#39;Arial&#39;)</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        - base_font_size: Basic font size in pixels (default: 16)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">        - **kwargs: Additional parameters to be passed to the constructor of alt.Chart</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>        <span class="c1"># Initialising the Altair Chart object with basic parameters</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">font</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span> <span class="o">=</span> <span class="n">base_font_size</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List for storing history layers</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>        
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="c1"># Dictionaries for the sizes and colours of various text elements</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="c1"># These values are multipliers for base_font_size</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>        <span class="c1"># The title will be twice as big as the basic font</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>   <span class="c1"># The subtitle will be 1.5 times bigger</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>    <span class="c1"># The context text will be 1.2 times larger</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>        <span class="c1"># Call-to-action text will be 1.3 times larger</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="mi">1</span>        <span class="c1"># The source text will have the basic size</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="p">}</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="c1"># Predefined colours for various text elements</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="p">}</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        Special method to delegate attributes not found to the Altair Chart object.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        This method is crucial for maintaining compatibility with Altair, allowing</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        to call Altair methods directly on the Story object.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">        Parameters:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        - name: Name of the required attribute</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        Returns:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        - Altair attribute if it exists, otherwise raises an AttributeError</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="c1"># Search for the attribute in Altair&#39;s Chart object</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="c1"># If the attribute is callable (i.e. it is a method), we create a wrapper</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                <span class="c1"># This wrapped function is created dynamically for each Altair method</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>                <span class="c1"># It is used to intercept Altair method calls and handle them correctly</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>                
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>                <span class="c1"># Let us call Altair&#39;s original method</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>                
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>                <span class="c1"># If the result is a new Altair Chart object</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">):</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>                    <span class="c1"># We update the chart attribute of our Story instance </span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chart</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>                    <span class="c1"># We return self (the Story instance) to allow method chaining</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>                    <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>                <span class="c1"># If the result is not a Chart, we return it as it is</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="c1"># We return the wrapped function instead of the original method</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="k">return</span> <span class="n">wrapped</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="c1"># If the attribute is not callable (it is a property), we return it directly</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">return</span> <span class="n">attr</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="k">def</span> <span class="nf">add_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtitle_color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        Adds a title layer (and optional subtitle) to the story.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        Parameters:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        - title: Main title text</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        - subtitle: Subtitle text (optional)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        - title_color: Custom colour for the title (optional)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        - subtitle_color: Custom colour for the subtitle (optional)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        returns:</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> 
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> 
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="n">subtitle</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>            <span class="s1">&#39;title_color&#39;</span><span class="p">:</span> <span class="n">title_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="s1">&#39;subtitle_color&#39;</span><span class="p">:</span> <span class="n">subtitle_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="p">})</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="nf">add_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        Adds a context layer to the story.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        Parameters:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">        - text: The context text to be added</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">        - position: The position of the text (default: ‘left’)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        - colour: Custom text colour (optional)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        returns:</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> 
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="p">})</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="nf">add_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="c1">#Basic parameters</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;What can we do next?&quot;</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="c1"># Parameters for NextStep </span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">vers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">button</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">stairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="c1"># General parameters for text (used as fallback)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="c1"># List of texts for steps</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="c1"># Parameters per button</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="n">button_width</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="n">button_height</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="n">button_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="n">button_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="n">button_corner_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">button_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">button_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_family</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">button_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># If None, use font_size</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="c1"># Parameters for line_steps</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">line_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">line_steps_rect_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">line_steps_space</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">line_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">line_steps_chart_height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">line_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">line_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="n">line_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="n">line_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="n">line_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="c1"># Parameters for stair_steps</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="n">stair_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="n">stair_steps_rect_height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">stair_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="n">stair_steps_chart_height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">stair_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="n">stair_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">stair_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">stair_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="n">stair_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="c1"># Title Parameters</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="n">title_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="n">title_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>     <span class="c1"># If None, use font_family</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">title_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       <span class="c1"># If None, use font_size * 1.4</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        Supports the use of NextStep with any parameter name via kwargs.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="c1"># Local import of NextStep to avoid circular imports</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="c1"># Search for an instance of NextStep in kwargs </span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="n">next_step_instance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">for</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param_value</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                <span class="k">break</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="c1"># Also check the nominal legacy parameters</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vers</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">stairs</span><span class="p">]:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                <span class="k">break</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="c1"># If a NextStep has been found, use it</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">next_step_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">next_step_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        </span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        Parameters</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        ---------</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">        text : str                                              Text for the basic version or for the button</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        position : str, default=‘bottom’                        Position of the element (‘bottom’, ‘top’, ‘left’, ‘right’)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        type : str, optional                                    Display type (‘line_steps’, ‘button’, ‘stair_steps’)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        title : str, default=&quot;What can we do next?’             Title for special visualisations</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        colour : str, optional                                  Text colour for the basic version</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a><span class="sd">        font_family : str, default=‘Arial’                      Default font</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        font_size : int, default=14                             Default font size</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        texts : list of str                                     List of texts for line_steps and stair_steps</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        url : str                                               URL for the button</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        </span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        Parameters for Button</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        ------------------</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        button_width : int, default=120                         Button width</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        button_height : int, default=40                         Height of the button</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        button_color : str, default=‘#80C11E’                   Background colour of the button</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        button_opacity : float, default=0.2                     Opacity of the button</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        button_corner_radius : int, default=5                   Corner radius of the button</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        button_text_color : str, default=‘black’                Button text colour</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        button_font_family : str, optional                      Font specific to the button</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        button_font_size : int, optional                        Font size for the button</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        </span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">        Parameters for Line Steps</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        ----------------------</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        line_steps_rect_width : int, default=10                 Rectangle width</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        line_steps_rect_height : int, default=10                Height of rectangles</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">        line_steps_space : int, default=5                       Space between rectangles</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        line_steps_chart_width : int, default=700               Total width of the chart</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">        line_steps_chart_height : int, default=100              Total chart height</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">        line_steps_color : str, default=‘#80C11E’               Colour of rectangles</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        line_steps_opacity : float, default=0.2                 Opacity of rectangles</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        line_steps_text_colour : str, default=‘black’           Text colour</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        line_steps_font_family : str, optional                  Font specific to line steps</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        line_steps_font_size : int, optional                    Font size for line steps</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        </span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        Parameters for Stair Steps</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        -----------------------</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">        stair_steps_rect_width : int, default=10                Width of steps</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">        stair_steps_rect_height : int, default=3                Height of steps</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">        stair_steps_chart_width : int, default=700              Total width of the chart</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">        stair_steps_chart_height : int, default=300             Total height of the chart</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">        stair_steps_color : str, default=‘#80C11E’              Colour of the steps</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        stair_steps_opacity : float, default=0.2                Opacity of the steps</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        stair_steps_text_colour : str, default=‘black’          Text colour</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        stair_steps_font_family : str,                          Font specific to stair steps</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">        stair_steps_font_size : int, optional                   Font size for stair steps</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">        </span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        Title parameters</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        ----------------------</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        title_color : str, default=‘black’                      Title colour</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        title_font_family : str, optional                       Specific font for the title</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        title_font_size : int, optional                         Font size for the title</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        </span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        Returns</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        -------</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        self : Story object                                     The current instance for method chaining</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1">#  Local import of NextStep to avoid circular imports</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="c1"># Management of NextStep objects</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">if</span> <span class="n">button</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">button</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘button’ parameter must be a NextStep of type ‘button’&quot;</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">button</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="k">elif</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘line’ parameter must be a NextStep of type ‘line_steps’&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">line</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">elif</span> <span class="n">stairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stairs</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stairs</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘stairs’ parameter must be a NextStep of type ‘stair_steps’&quot;</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">stairs</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">elif</span> <span class="n">vers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vers</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘vers’ must be an instance of NextStep&quot;</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">vers</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="c1"># Basic version (text only)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the basic version&quot;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> 
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;cta&#39;</span><span class="p">]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="p">})</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="c1"># Type validation</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;line_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">]</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tipo non valido. Usare uno tra: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="c1"># Chart creation by type</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the button type&quot;</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘url’ parameter is required for the button type&quot;</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="c1"># Button chart creation</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="p">}])</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="n">button_bg</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_color</span><span class="p">,</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">button_opacity</span><span class="p">,</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                <span class="n">cornerRadius</span><span class="o">=</span><span class="n">button_corner_radius</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                <span class="n">href</span><span class="o">=</span><span class="s1">&#39;url:N&#39;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">button_text</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">button_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">button_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_text_color</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>            <span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">button_bg</span><span class="p">,</span> <span class="n">button_text</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;It is necessary to provide a list of texts for line_steps&quot;</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">line_steps_space</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_steps_rect_height</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="p">})</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_color</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">line_steps_opacity</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">line_steps_chart_width</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">line_steps_chart_height</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>            <span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>            
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>            <span class="c1"># Add text labels</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">line_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">line_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                <span class="n">lineHeight</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_text_color</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text:N&#39;</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_half:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="n">y_half</span><span class="o">=</span><span class="s1">&#39;datum.y2/2&#39;</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_width</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">line_steps_space</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                    <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                    <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="p">})</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                <span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide a list of texts for stair_steps&quot;</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="p">})</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>            
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_color</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">stair_steps_opacity</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">stair_steps_rect_height</span><span class="p">])),</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">stair_steps_chart_width</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">stair_steps_chart_height</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="c1"># Add text labels</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">stair_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">stair_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_text_color</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_mid:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                <span class="n">y_mid</span><span class="o">=</span><span class="s1">&#39;(datum.y + datum.y2)/2&#39;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                <span class="n">line_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                    <span class="n">line_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>                        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                        <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                        <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                    <span class="p">})</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">line_data</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                <span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="c1"># Addition of title with customisable font</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                <span class="n">title</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">TitleParams</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                    <span class="n">fontSize</span><span class="o">=</span><span class="n">title_font_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">),</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                    <span class="n">font</span><span class="o">=</span><span class="n">title_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">title_color</span><span class="p">,</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                    <span class="n">offset</span><span class="o">=</span><span class="mi">10</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                <span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="c1"># Addition to layer</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">chart</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="p">})</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">def</span> <span class="nf">add_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_point</span><span class="p">,</span> <span class="n">y_point</span><span class="p">,</span> <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&quot;Point of interest&quot;</span><span class="p">,</span> 
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                                     <span class="n">arrow_direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">arrow_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">arrow_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>                                     <span class="n">label_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                                     <span class="n">show_point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>                                     <span class="n">arrow_dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">arrow_dy</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                                     <span class="n">label_dx</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">label_dy</span><span class="o">=-</span><span class="mi">37</span><span class="p">):</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        Create an arrow annotation on the graph.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">        </span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">        This method is essential for highlighting specific points in the graph and adding</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">        contextual explanations. It is particularly useful for data narration, allowing</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        to guide the observer&#39;s attention to relevant aspects of the visualisation.</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="sd">        Parameters:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a><span class="sd">        - x_point, y_point: Coordinates of the point to be annotated</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="sd">        - annotation_text: Text of the annotation (default: ‘Point of interest’)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a><span class="sd">        - arrow_direction: Direction of the arrow (default: ‘right’)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a><span class="sd">        - arrow_color, arrow_size: Arrow colour and size</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a><span class="sd">        - label_colour, label_size: Colour and size of the annotation text</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a><span class="sd">        - show_point: If True, shows a point at the annotation location</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="sd">        - point_color, point_size: Colour and size of the point</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        - arrow_dx, arrow_dy: Distances in pixels to be added to the arrow position (default:0, -45)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">        - label_dx, label_dy: Distances in pixels to be added to the label position (default:37, -37)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">        returns:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="c1"># Dictionary that maps arrow directions to corresponding Unicode symbols</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>        <span class="n">arrow_symbols</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;←&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;→&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span> <span class="s1">&#39;↓&#39;</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>            <span class="s1">&#39;upleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↖&#39;</span><span class="p">,</span> <span class="s1">&#39;upright&#39;</span><span class="p">:</span> <span class="s1">&#39;↗&#39;</span><span class="p">,</span> <span class="s1">&#39;downleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↙&#39;</span><span class="p">,</span> <span class="s1">&#39;downright&#39;</span><span class="p">:</span> <span class="s1">&#39;↘&#39;</span><span class="p">,</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="s1">&#39;leftup&#39;</span><span class="p">:</span> <span class="s1">&#39;↰&#39;</span><span class="p">,</span> <span class="s1">&#39;leftdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↲&#39;</span><span class="p">,</span> <span class="s1">&#39;rightup&#39;</span><span class="p">:</span> <span class="s1">&#39;↱&#39;</span><span class="p">,</span> <span class="s1">&#39;rightdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↳&#39;</span><span class="p">,</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>            <span class="s1">&#39;upleftcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↺&#39;</span><span class="p">,</span> <span class="s1">&#39;uprightcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↻&#39;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="p">}</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="c1"># Check that the direction of the arrow is valid</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        <span class="k">if</span> <span class="n">arrow_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrow_symbols</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid arrow direction. Use one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arrow_symbols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="c1"># Select the appropriate arrow symbol</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="n">arrow_symbol</span> <span class="o">=</span> <span class="n">arrow_symbols</span><span class="p">[</span><span class="n">arrow_direction</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="c1"># checks whether the encoding has already been defined</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">)</span><span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="c1"># If encoding is not defined use of default values</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="c1"># If encoding is defined, we extract the data types for the x and y axes</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="c1"># Explanation of data type extraction:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="c1"># 1. We first check whether the encoding has been defined. This is important because</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="c1"># the user may call this method before defining the encoding of the graph.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="c1"># (The encoding in Altair defines how the data is mapped to the visual properties of the graph).</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="c1"># 2. If encoding is not defined, we use ‘Q’ (Quantitative) as the default data type</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="c1"># for both axes. This allows the method to work even without a defined encoding.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="c1"># 3. If the encoding is defined, we proceed with the data type extraction as before:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="c1"># - self.chart.encoding.x.shorthand: accesses the shorthand of the x-axis</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="c1"># .shorthand: In Altair, ‘shorthand’ is a concise notation for specifying the encoding.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="c1"># Example of shorthand: ‘column:Q’ where ‘column’ is the name of the data column</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="c1"># and ‘Q’ is the data type (in this case, Quantitative).</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="c1"># - split(‘:’)[-1]: splits the shorthand at ‘:’ and takes the last element (the data type)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="c1"># Example: If shorthand is ‘price:Q’, split(‘:’) will return [‘price’, ‘Q’].</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="c1"># 4. The extracted data type will be one of:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="c1"># - ‘Q’: Quantitative (continuous numeric)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="c1"># - ‘O’: Ordinal (ordered categories)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="c1"># N&#39;: Nominal (unordered categories)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="c1"># T&#39;: Temporal (dates or times)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="c1"># Important: This operation is essential to ensure that the annotations</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="c1"># added to the graph are consistent with the original axis data types.</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="c1"># Without this match, annotations may be positioned</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="c1"># incorrectly or cause rendering errors.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="c1"># Create a DataFrame with a single point for the annotation</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="n">annotation_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_point</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">y_point</span><span class="p">]})</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="c1"># Internal function to create the correct encoding based on the data type</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="k">def</span> <span class="nf">create_encoding</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">            Creates the appropriate encoding for Altair based on the data type.</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">            This function is crucial to ensure that the annotation is</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">            consistent with the original chart data type.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>  <span class="c1"># Ordinale</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>  <span class="c1"># Nominale</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>  <span class="c1"># Temporale</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Quantitativo (default)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="c1"># Initialises the list of annotation layers</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="c1"># Adds full stop if required</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="n">show_point</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="n">point_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_point</span><span class="p">(</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="n">size</span><span class="o">=</span><span class="n">point_size</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>            <span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_layer</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="c1"># Adds the arrow</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="c1"># Utilizziamo mark_text per disegnare la freccia usando un carattere Unicode</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="n">arrow_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">arrow_symbol</span><span class="p">,</span> 
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">arrow_size</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>            <span class="n">dx</span><span class="o">=</span><span class="n">arrow_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position the arrow                   was 22</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="n">dy</span><span class="o">=</span><span class="n">arrow_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position the arrow                     was -22</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arrow_layer</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="c1"># Adds text label</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">label_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="n">dx</span><span class="o">=</span> <span class="n">label_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position text                     was 37</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="n">dy</span><span class="o">=</span> <span class="n">label_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position text                       was -37</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">label_color</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">annotation_text</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="c1"># Combine all layers into a single annotation</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="n">annotation</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="c1"># Adds annotation to history layers</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">annotation</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="p">})</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="c1"># Note on flexibility and robustness:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="c1"># This approach makes the add_annotation method more flexible,</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>        <span class="c1"># as it can automatically adapt to different types of graphs without</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>        <span class="c1"># requiring manual input on the axis data type. In addition, using</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="c1"># the Altair shorthand, the code automatically adapts even if the user</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>        <span class="c1"># has specified the encoding in different ways (e.g., using alt.X(‘column:Q’)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>        <span class="c1"># or alt.X(‘column’, type=‘quantitative’)).</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self to allow method chaining</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>    <span class="k">def</span> <span class="nf">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">em</span><span class="p">):</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="sd">        Converts a dimension from em to pixels.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">        This function is essential for maintaining visual consistency</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="sd">        between different textual elements and devices.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        Parameters:</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">        - em: Size in em</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">        Returns:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">        - Equivalent size in pixels (integer)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">em</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>    <span class="k">def</span> <span class="nf">_get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">is_source</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="sd">        Calculates the x and y co-ordinates for positioning text elements in the graph.</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a><span class="sd">        This method is crucial for the correct positioning of various elements</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="sd">        narrative elements such as context, call-to-action and sources.</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">        Parameters:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">        - position: String indicating the desired position (e.g. ‘left’, ‘right’, ‘top’, etc.).</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        - is_source: Flag for special handling of the source position (not currently used)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        Returns:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">        - Tuple (x, y) representing the coordinates in pixels</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="c1"># Dictionary mapping positions to coordinates (x, y)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="c1"># Co-ordinates are calculated from the size of the graph</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>        <span class="n">positions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixel from the left edge, centred vertically</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixel from the right edge, centred vertically</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>  <span class="c1"># Centred horizontally, 80 pixels from above</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>            <span class="s1">&#39;bottom&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">),</span>  <span class="c1"># Horizontally centred, 10 pixels from bottom</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>            <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Graph Centre</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>            <span class="s1">&#39;side-left&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixels to the left of the border, centred vertically</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>            <span class="s1">&#39;side-right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixels to the right of the border, centred vertically</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="p">}</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="c1"># If the required position is not in the dictionary, use a default position</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="c1"># In this case, horizontally centred and 20 pixels from the bottom</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="k">return</span> <span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>    <span class="k">def</span> <span class="nf">create_title_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="sd">        Creates the title layer (and subtitle if present).</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">        This method is responsible for visually creating the main title</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a><span class="sd">        and the optional subtitle of the graphic.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">        Parameters:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a><span class="sd">        - Layer: Dictionary containing the title information</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a><span class="sd">        Returns:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="sd">        - Altair Chart object representing the title layer</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>        <span class="n">title_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>            <span class="n">fontWeight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title_color&#39;</span><span class="p">]</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Position 20 pixels from above</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="p">)</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>        
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>            <span class="n">subtitle_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">],</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]),</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>                <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle_color&#39;</span><span class="p">]</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Position 50 pixels from the top (below the title)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>            <span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="k">return</span> <span class="n">title_chart</span> <span class="o">+</span> <span class="n">subtitle_chart</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>        <span class="k">return</span> <span class="n">title_chart</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>    <span class="k">def</span> <span class="nf">create_text_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        Creates a generic text layer (context, call-to-action, source).</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a><span class="sd">        This method is used to create text layers for various narrative purposes,</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a><span class="sd">        such as adding context, call-to-action or data source information.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a><span class="sd">        Parameters:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a><span class="sd">        - Layer: Dictionary containing the text information to be added</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a><span class="sd">        Returns:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a><span class="sd">        - Altair Chart object representing the text layer</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>        <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]),</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>            <span class="n">angle</span><span class="o">=</span><span class="mi">270</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">#  Rotate text if ‘vertical’ is True</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>        <span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>    <span class="k">def</span> <span class="nf">configure_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a><span class="sd">        Configure aspects of the graph view using Altair&#39;s configure_view method.</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a><span class="sd">        This method allows you to configure various aspects of the chart view, such as</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a><span class="sd">        the background colour, border style, internal spacing, etc.</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a><span class="sd">        Parameters:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a><span class="sd">        *args, **kwargs: Arguments to pass to the Altair configure_view method.</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a><span class="sd">        stores the view configuration for application during rendering.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a><span class="sd">        It renders all layers of the story in a single graphic.       </span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>        <span class="c1"># Let&#39;s start with the basic graph</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>        <span class="n">main_chart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>        
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>        <span class="c1"># We create separate lists to place special graphics</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>        <span class="n">top_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>        <span class="n">bottom_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>        <span class="n">left_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>        <span class="n">right_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>        <span class="n">overlay_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>        
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>        <span class="c1"># We organise the layers according to their position</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="p">:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>            <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">:</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>                <span class="c1"># We take the position from the layer</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>                    <span class="n">top_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>                    <span class="n">bottom_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>                    <span class="n">left_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>                    <span class="n">right_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_title_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">]:</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_text_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;shape_label&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">]:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>        <span class="c1"># Overlaying the layers on the main graph</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>        <span class="k">for</span> <span class="n">overlay</span> <span class="ow">in</span> <span class="n">overlay_charts</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>            <span class="n">main_chart</span> <span class="o">+=</span> <span class="n">overlay</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>        <span class="c1"># We build the final layout</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>        <span class="k">if</span> <span class="n">left_charts</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">left_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>        <span class="k">if</span> <span class="n">right_charts</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">right_charts</span><span class="p">))</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>        <span class="k">if</span> <span class="n">top_charts</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">top_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>        <span class="k">if</span> <span class="n">bottom_charts</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">bottom_charts</span><span class="p">))</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>        <span class="c1"># Apply configurations</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>        <span class="k">if</span> <span class="s1">&#39;view&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">main_chart</span><span class="o">.</span><span class="n">configure_view</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">])</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>        <span class="k">return</span> <span class="n">main_chart</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>    
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>    
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a><span class="k">def</span> <span class="nf">story</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a><span class="sd">    Utility function for creating a Story instance.</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a><span class="sd">    This function simplifies the creation of a Story object, allowing</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a><span class="sd">    to initialise it in a more concise and intuitive way.</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a><span class="sd">    Parameters:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a><span class="sd">    - data: DataFrame or URL for chart data (default: None)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a><span class="sd">    - **kwargs: Additional parameters to be passed to the Story constructor</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a><span class="sd">    Returns:</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a><span class="sd">    - An instance of the Story class</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>    <span class="k">return</span> <span class="n">Story</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Story">
                            <input id="Story-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Story</span>:

                <label class="view-source-button" for="Story-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story-5"><a href="#Story-5"><span class="linenos">  5</span></a><span class="k">class</span> <span class="nc">Story</span><span class="p">:</span>
</span><span id="Story-6"><a href="#Story-6"><span class="linenos">  6</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-7"><a href="#Story-7"><span class="linenos">  7</span></a><span class="sd">    Story class: Implements a structure for creating narrative views of data.</span>
</span><span id="Story-8"><a href="#Story-8"><span class="linenos">  8</span></a><span class="sd">    </span>
</span><span id="Story-9"><a href="#Story-9"><span class="linenos">  9</span></a><span class="sd">    This class extends the functionality of Altair to include narrative elements</span>
</span><span id="Story-10"><a href="#Story-10"><span class="linenos"> 10</span></a><span class="sd">    such as titles, contexts, call-to-action and annotations. It is designed to facilitate</span>
</span><span id="Story-11"><a href="#Story-11"><span class="linenos"> 11</span></a><span class="sd">    the creation of more engaging and informative data visualisations.</span>
</span><span id="Story-12"><a href="#Story-12"><span class="linenos"> 12</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Story-13"><a href="#Story-13"><span class="linenos"> 13</span></a>
</span><span id="Story-14"><a href="#Story-14"><span class="linenos"> 14</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">base_font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story-15"><a href="#Story-15"><span class="linenos"> 15</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-16"><a href="#Story-16"><span class="linenos"> 16</span></a><span class="sd">        Initialise a Story object.</span>
</span><span id="Story-17"><a href="#Story-17"><span class="linenos"> 17</span></a>
</span><span id="Story-18"><a href="#Story-18"><span class="linenos"> 18</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-19"><a href="#Story-19"><span class="linenos"> 19</span></a><span class="sd">        - data: DataFrame or URL for graph data  (default: None)</span>
</span><span id="Story-20"><a href="#Story-20"><span class="linenos"> 20</span></a><span class="sd">        - width: Graph width in pixels (default: 600)</span>
</span><span id="Story-21"><a href="#Story-21"><span class="linenos"> 21</span></a><span class="sd">        - height: Height of the graph in pixels (default: 400)</span>
</span><span id="Story-22"><a href="#Story-22"><span class="linenos"> 22</span></a><span class="sd">        - font: Font to be used for all text elements (default: &#39;Arial&#39;)</span>
</span><span id="Story-23"><a href="#Story-23"><span class="linenos"> 23</span></a><span class="sd">        - base_font_size: Basic font size in pixels (default: 16)</span>
</span><span id="Story-24"><a href="#Story-24"><span class="linenos"> 24</span></a><span class="sd">        - **kwargs: Additional parameters to be passed to the constructor of alt.Chart</span>
</span><span id="Story-25"><a href="#Story-25"><span class="linenos"> 25</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-26"><a href="#Story-26"><span class="linenos"> 26</span></a>        <span class="c1"># Initialising the Altair Chart object with basic parameters</span>
</span><span id="Story-27"><a href="#Story-27"><span class="linenos"> 27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Story-28"><a href="#Story-28"><span class="linenos"> 28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">font</span>
</span><span id="Story-29"><a href="#Story-29"><span class="linenos"> 29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span> <span class="o">=</span> <span class="n">base_font_size</span>
</span><span id="Story-30"><a href="#Story-30"><span class="linenos"> 30</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List for storing history layers</span>
</span><span id="Story-31"><a href="#Story-31"><span class="linenos"> 31</span></a>        
</span><span id="Story-32"><a href="#Story-32"><span class="linenos"> 32</span></a>        <span class="c1"># Dictionaries for the sizes and colours of various text elements</span>
</span><span id="Story-33"><a href="#Story-33"><span class="linenos"> 33</span></a>        <span class="c1"># These values are multipliers for base_font_size</span>
</span><span id="Story-34"><a href="#Story-34"><span class="linenos"> 34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story-35"><a href="#Story-35"><span class="linenos"> 35</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>        <span class="c1"># The title will be twice as big as the basic font</span>
</span><span id="Story-36"><a href="#Story-36"><span class="linenos"> 36</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>   <span class="c1"># The subtitle will be 1.5 times bigger</span>
</span><span id="Story-37"><a href="#Story-37"><span class="linenos"> 37</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>    <span class="c1"># The context text will be 1.2 times larger</span>
</span><span id="Story-38"><a href="#Story-38"><span class="linenos"> 38</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>        <span class="c1"># Call-to-action text will be 1.3 times larger</span>
</span><span id="Story-39"><a href="#Story-39"><span class="linenos"> 39</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="mi">1</span>        <span class="c1"># The source text will have the basic size</span>
</span><span id="Story-40"><a href="#Story-40"><span class="linenos"> 40</span></a>        <span class="p">}</span>
</span><span id="Story-41"><a href="#Story-41"><span class="linenos"> 41</span></a>        <span class="c1"># Predefined colours for various text elements</span>
</span><span id="Story-42"><a href="#Story-42"><span class="linenos"> 42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story-43"><a href="#Story-43"><span class="linenos"> 43</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-44"><a href="#Story-44"><span class="linenos"> 44</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="Story-45"><a href="#Story-45"><span class="linenos"> 45</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-46"><a href="#Story-46"><span class="linenos"> 46</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span id="Story-47"><a href="#Story-47"><span class="linenos"> 47</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="Story-48"><a href="#Story-48"><span class="linenos"> 48</span></a>        <span class="p">}</span>
</span><span id="Story-49"><a href="#Story-49"><span class="linenos"> 49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Story-50"><a href="#Story-50"><span class="linenos"> 50</span></a>
</span><span id="Story-51"><a href="#Story-51"><span class="linenos"> 51</span></a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="Story-52"><a href="#Story-52"><span class="linenos"> 52</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-53"><a href="#Story-53"><span class="linenos"> 53</span></a><span class="sd">        Special method to delegate attributes not found to the Altair Chart object.</span>
</span><span id="Story-54"><a href="#Story-54"><span class="linenos"> 54</span></a><span class="sd">        </span>
</span><span id="Story-55"><a href="#Story-55"><span class="linenos"> 55</span></a><span class="sd">        This method is crucial for maintaining compatibility with Altair, allowing</span>
</span><span id="Story-56"><a href="#Story-56"><span class="linenos"> 56</span></a><span class="sd">        to call Altair methods directly on the Story object.</span>
</span><span id="Story-57"><a href="#Story-57"><span class="linenos"> 57</span></a>
</span><span id="Story-58"><a href="#Story-58"><span class="linenos"> 58</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-59"><a href="#Story-59"><span class="linenos"> 59</span></a><span class="sd">        - name: Name of the required attribute</span>
</span><span id="Story-60"><a href="#Story-60"><span class="linenos"> 60</span></a>
</span><span id="Story-61"><a href="#Story-61"><span class="linenos"> 61</span></a><span class="sd">        Returns:</span>
</span><span id="Story-62"><a href="#Story-62"><span class="linenos"> 62</span></a><span class="sd">        - Altair attribute if it exists, otherwise raises an AttributeError</span>
</span><span id="Story-63"><a href="#Story-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-64"><a href="#Story-64"><span class="linenos"> 64</span></a>        <span class="c1"># Search for the attribute in Altair&#39;s Chart object</span>
</span><span id="Story-65"><a href="#Story-65"><span class="linenos"> 65</span></a>        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="Story-66"><a href="#Story-66"><span class="linenos"> 66</span></a>        
</span><span id="Story-67"><a href="#Story-67"><span class="linenos"> 67</span></a>        <span class="c1"># If the attribute is callable (i.e. it is a method), we create a wrapper</span>
</span><span id="Story-68"><a href="#Story-68"><span class="linenos"> 68</span></a>        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
</span><span id="Story-69"><a href="#Story-69"><span class="linenos"> 69</span></a>            <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story-70"><a href="#Story-70"><span class="linenos"> 70</span></a>                <span class="c1"># This wrapped function is created dynamically for each Altair method</span>
</span><span id="Story-71"><a href="#Story-71"><span class="linenos"> 71</span></a>                <span class="c1"># It is used to intercept Altair method calls and handle them correctly</span>
</span><span id="Story-72"><a href="#Story-72"><span class="linenos"> 72</span></a>                
</span><span id="Story-73"><a href="#Story-73"><span class="linenos"> 73</span></a>                <span class="c1"># Let us call Altair&#39;s original method</span>
</span><span id="Story-74"><a href="#Story-74"><span class="linenos"> 74</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">attr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Story-75"><a href="#Story-75"><span class="linenos"> 75</span></a>                
</span><span id="Story-76"><a href="#Story-76"><span class="linenos"> 76</span></a>                <span class="c1"># If the result is a new Altair Chart object</span>
</span><span id="Story-77"><a href="#Story-77"><span class="linenos"> 77</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">):</span>
</span><span id="Story-78"><a href="#Story-78"><span class="linenos"> 78</span></a>                    <span class="c1"># We update the chart attribute of our Story instance </span>
</span><span id="Story-79"><a href="#Story-79"><span class="linenos"> 79</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">chart</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="Story-80"><a href="#Story-80"><span class="linenos"> 80</span></a>                    <span class="c1"># We return self (the Story instance) to allow method chaining</span>
</span><span id="Story-81"><a href="#Story-81"><span class="linenos"> 81</span></a>                    <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-82"><a href="#Story-82"><span class="linenos"> 82</span></a>                <span class="c1"># If the result is not a Chart, we return it as it is</span>
</span><span id="Story-83"><a href="#Story-83"><span class="linenos"> 83</span></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="Story-84"><a href="#Story-84"><span class="linenos"> 84</span></a>            
</span><span id="Story-85"><a href="#Story-85"><span class="linenos"> 85</span></a>            <span class="c1"># We return the wrapped function instead of the original method</span>
</span><span id="Story-86"><a href="#Story-86"><span class="linenos"> 86</span></a>            <span class="k">return</span> <span class="n">wrapped</span>
</span><span id="Story-87"><a href="#Story-87"><span class="linenos"> 87</span></a>        
</span><span id="Story-88"><a href="#Story-88"><span class="linenos"> 88</span></a>        <span class="c1"># If the attribute is not callable (it is a property), we return it directly</span>
</span><span id="Story-89"><a href="#Story-89"><span class="linenos"> 89</span></a>        <span class="k">return</span> <span class="n">attr</span>
</span><span id="Story-90"><a href="#Story-90"><span class="linenos"> 90</span></a>
</span><span id="Story-91"><a href="#Story-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">add_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtitle_color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Story-92"><a href="#Story-92"><span class="linenos"> 92</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-93"><a href="#Story-93"><span class="linenos"> 93</span></a><span class="sd">        Adds a title layer (and optional subtitle) to the story.</span>
</span><span id="Story-94"><a href="#Story-94"><span class="linenos"> 94</span></a>
</span><span id="Story-95"><a href="#Story-95"><span class="linenos"> 95</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-96"><a href="#Story-96"><span class="linenos"> 96</span></a><span class="sd">        - title: Main title text</span>
</span><span id="Story-97"><a href="#Story-97"><span class="linenos"> 97</span></a><span class="sd">        - subtitle: Subtitle text (optional)</span>
</span><span id="Story-98"><a href="#Story-98"><span class="linenos"> 98</span></a><span class="sd">        - title_color: Custom colour for the title (optional)</span>
</span><span id="Story-99"><a href="#Story-99"><span class="linenos"> 99</span></a><span class="sd">        - subtitle_color: Custom colour for the subtitle (optional)</span>
</span><span id="Story-100"><a href="#Story-100"><span class="linenos">100</span></a>
</span><span id="Story-101"><a href="#Story-101"><span class="linenos">101</span></a><span class="sd">        returns:</span>
</span><span id="Story-102"><a href="#Story-102"><span class="linenos">102</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story-103"><a href="#Story-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-104"><a href="#Story-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-105"><a href="#Story-105"><span class="linenos">105</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> 
</span><span id="Story-106"><a href="#Story-106"><span class="linenos">106</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> 
</span><span id="Story-107"><a href="#Story-107"><span class="linenos">107</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="n">subtitle</span><span class="p">,</span>
</span><span id="Story-108"><a href="#Story-108"><span class="linenos">108</span></a>            <span class="s1">&#39;title_color&#39;</span><span class="p">:</span> <span class="n">title_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="Story-109"><a href="#Story-109"><span class="linenos">109</span></a>            <span class="s1">&#39;subtitle_color&#39;</span><span class="p">:</span> <span class="n">subtitle_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
</span><span id="Story-110"><a href="#Story-110"><span class="linenos">110</span></a>        <span class="p">})</span>
</span><span id="Story-111"><a href="#Story-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-112"><a href="#Story-112"><span class="linenos">112</span></a>
</span><span id="Story-113"><a href="#Story-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">add_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Story-114"><a href="#Story-114"><span class="linenos">114</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-115"><a href="#Story-115"><span class="linenos">115</span></a><span class="sd">        Adds a context layer to the story.</span>
</span><span id="Story-116"><a href="#Story-116"><span class="linenos">116</span></a>
</span><span id="Story-117"><a href="#Story-117"><span class="linenos">117</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-118"><a href="#Story-118"><span class="linenos">118</span></a><span class="sd">        - text: The context text to be added</span>
</span><span id="Story-119"><a href="#Story-119"><span class="linenos">119</span></a><span class="sd">        - position: The position of the text (default: ‘left’)</span>
</span><span id="Story-120"><a href="#Story-120"><span class="linenos">120</span></a><span class="sd">        - colour: Custom text colour (optional)</span>
</span><span id="Story-121"><a href="#Story-121"><span class="linenos">121</span></a>
</span><span id="Story-122"><a href="#Story-122"><span class="linenos">122</span></a><span class="sd">        returns:</span>
</span><span id="Story-123"><a href="#Story-123"><span class="linenos">123</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story-124"><a href="#Story-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-125"><a href="#Story-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-126"><a href="#Story-126"><span class="linenos">126</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> 
</span><span id="Story-127"><a href="#Story-127"><span class="linenos">127</span></a>            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="Story-128"><a href="#Story-128"><span class="linenos">128</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="Story-129"><a href="#Story-129"><span class="linenos">129</span></a>            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span>
</span><span id="Story-130"><a href="#Story-130"><span class="linenos">130</span></a>        <span class="p">})</span>
</span><span id="Story-131"><a href="#Story-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-132"><a href="#Story-132"><span class="linenos">132</span></a>
</span><span id="Story-133"><a href="#Story-133"><span class="linenos">133</span></a>
</span><span id="Story-134"><a href="#Story-134"><span class="linenos">134</span></a>    <span class="k">def</span> <span class="nf">add_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="Story-135"><a href="#Story-135"><span class="linenos">135</span></a>        <span class="c1">#Basic parameters</span>
</span><span id="Story-136"><a href="#Story-136"><span class="linenos">136</span></a>        <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-137"><a href="#Story-137"><span class="linenos">137</span></a>        <span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
</span><span id="Story-138"><a href="#Story-138"><span class="linenos">138</span></a>        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-139"><a href="#Story-139"><span class="linenos">139</span></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;What can we do next?&quot;</span><span class="p">,</span>
</span><span id="Story-140"><a href="#Story-140"><span class="linenos">140</span></a>        
</span><span id="Story-141"><a href="#Story-141"><span class="linenos">141</span></a>        <span class="c1"># Parameters for NextStep </span>
</span><span id="Story-142"><a href="#Story-142"><span class="linenos">142</span></a>        <span class="n">vers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-143"><a href="#Story-143"><span class="linenos">143</span></a>        <span class="n">button</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-144"><a href="#Story-144"><span class="linenos">144</span></a>        <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-145"><a href="#Story-145"><span class="linenos">145</span></a>        <span class="n">stairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       
</span><span id="Story-146"><a href="#Story-146"><span class="linenos">146</span></a>        
</span><span id="Story-147"><a href="#Story-147"><span class="linenos">147</span></a>        <span class="c1"># General parameters for text (used as fallback)</span>
</span><span id="Story-148"><a href="#Story-148"><span class="linenos">148</span></a>        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-149"><a href="#Story-149"><span class="linenos">149</span></a>        <span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span>
</span><span id="Story-150"><a href="#Story-150"><span class="linenos">150</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
</span><span id="Story-151"><a href="#Story-151"><span class="linenos">151</span></a>        
</span><span id="Story-152"><a href="#Story-152"><span class="linenos">152</span></a>        <span class="c1"># List of texts for steps</span>
</span><span id="Story-153"><a href="#Story-153"><span class="linenos">153</span></a>        <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-154"><a href="#Story-154"><span class="linenos">154</span></a>        
</span><span id="Story-155"><a href="#Story-155"><span class="linenos">155</span></a>        <span class="c1"># Parameters per button</span>
</span><span id="Story-156"><a href="#Story-156"><span class="linenos">156</span></a>        <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story-157"><a href="#Story-157"><span class="linenos">157</span></a>        <span class="n">button_width</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="Story-158"><a href="#Story-158"><span class="linenos">158</span></a>        <span class="n">button_height</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="Story-159"><a href="#Story-159"><span class="linenos">159</span></a>        <span class="n">button_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story-160"><a href="#Story-160"><span class="linenos">160</span></a>        <span class="n">button_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story-161"><a href="#Story-161"><span class="linenos">161</span></a>        <span class="n">button_corner_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Story-162"><a href="#Story-162"><span class="linenos">162</span></a>        <span class="n">button_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-163"><a href="#Story-163"><span class="linenos">163</span></a>        <span class="n">button_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_family</span>
</span><span id="Story-164"><a href="#Story-164"><span class="linenos">164</span></a>        <span class="n">button_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># If None, use font_size</span>
</span><span id="Story-165"><a href="#Story-165"><span class="linenos">165</span></a>        
</span><span id="Story-166"><a href="#Story-166"><span class="linenos">166</span></a>        <span class="c1"># Parameters for line_steps</span>
</span><span id="Story-167"><a href="#Story-167"><span class="linenos">167</span></a>        <span class="n">line_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story-168"><a href="#Story-168"><span class="linenos">168</span></a>        <span class="n">line_steps_rect_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story-169"><a href="#Story-169"><span class="linenos">169</span></a>        <span class="n">line_steps_space</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Story-170"><a href="#Story-170"><span class="linenos">170</span></a>        <span class="n">line_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="Story-171"><a href="#Story-171"><span class="linenos">171</span></a>        <span class="n">line_steps_chart_height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="Story-172"><a href="#Story-172"><span class="linenos">172</span></a>        <span class="n">line_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story-173"><a href="#Story-173"><span class="linenos">173</span></a>        <span class="n">line_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story-174"><a href="#Story-174"><span class="linenos">174</span></a>        <span class="n">line_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-175"><a href="#Story-175"><span class="linenos">175</span></a>        <span class="n">line_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="Story-176"><a href="#Story-176"><span class="linenos">176</span></a>        <span class="n">line_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="Story-177"><a href="#Story-177"><span class="linenos">177</span></a>        
</span><span id="Story-178"><a href="#Story-178"><span class="linenos">178</span></a>        <span class="c1"># Parameters for stair_steps</span>
</span><span id="Story-179"><a href="#Story-179"><span class="linenos">179</span></a>        <span class="n">stair_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story-180"><a href="#Story-180"><span class="linenos">180</span></a>        <span class="n">stair_steps_rect_height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="Story-181"><a href="#Story-181"><span class="linenos">181</span></a>        <span class="n">stair_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="Story-182"><a href="#Story-182"><span class="linenos">182</span></a>        <span class="n">stair_steps_chart_height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
</span><span id="Story-183"><a href="#Story-183"><span class="linenos">183</span></a>        <span class="n">stair_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story-184"><a href="#Story-184"><span class="linenos">184</span></a>        <span class="n">stair_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story-185"><a href="#Story-185"><span class="linenos">185</span></a>        <span class="n">stair_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-186"><a href="#Story-186"><span class="linenos">186</span></a>        <span class="n">stair_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="Story-187"><a href="#Story-187"><span class="linenos">187</span></a>        <span class="n">stair_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="Story-188"><a href="#Story-188"><span class="linenos">188</span></a>        
</span><span id="Story-189"><a href="#Story-189"><span class="linenos">189</span></a>        <span class="c1"># Title Parameters</span>
</span><span id="Story-190"><a href="#Story-190"><span class="linenos">190</span></a>        <span class="n">title_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story-191"><a href="#Story-191"><span class="linenos">191</span></a>        <span class="n">title_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>     <span class="c1"># If None, use font_family</span>
</span><span id="Story-192"><a href="#Story-192"><span class="linenos">192</span></a>        <span class="n">title_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       <span class="c1"># If None, use font_size * 1.4</span>
</span><span id="Story-193"><a href="#Story-193"><span class="linenos">193</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story-194"><a href="#Story-194"><span class="linenos">194</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-195"><a href="#Story-195"><span class="linenos">195</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="Story-196"><a href="#Story-196"><span class="linenos">196</span></a><span class="sd">        Supports the use of NextStep with any parameter name via kwargs.</span>
</span><span id="Story-197"><a href="#Story-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-198"><a href="#Story-198"><span class="linenos">198</span></a>        <span class="c1"># Local import of NextStep to avoid circular imports</span>
</span><span id="Story-199"><a href="#Story-199"><span class="linenos">199</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="Story-200"><a href="#Story-200"><span class="linenos">200</span></a>        
</span><span id="Story-201"><a href="#Story-201"><span class="linenos">201</span></a>        <span class="c1"># Search for an instance of NextStep in kwargs </span>
</span><span id="Story-202"><a href="#Story-202"><span class="linenos">202</span></a>        <span class="n">next_step_instance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Story-203"><a href="#Story-203"><span class="linenos">203</span></a>        <span class="k">for</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Story-204"><a href="#Story-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story-205"><a href="#Story-205"><span class="linenos">205</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param_value</span>
</span><span id="Story-206"><a href="#Story-206"><span class="linenos">206</span></a>                <span class="k">break</span>
</span><span id="Story-207"><a href="#Story-207"><span class="linenos">207</span></a>        
</span><span id="Story-208"><a href="#Story-208"><span class="linenos">208</span></a>        <span class="c1"># Also check the nominal legacy parameters</span>
</span><span id="Story-209"><a href="#Story-209"><span class="linenos">209</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vers</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">stairs</span><span class="p">]:</span>
</span><span id="Story-210"><a href="#Story-210"><span class="linenos">210</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story-211"><a href="#Story-211"><span class="linenos">211</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="Story-212"><a href="#Story-212"><span class="linenos">212</span></a>                <span class="k">break</span>
</span><span id="Story-213"><a href="#Story-213"><span class="linenos">213</span></a>        
</span><span id="Story-214"><a href="#Story-214"><span class="linenos">214</span></a>        <span class="c1"># If a NextStep has been found, use it</span>
</span><span id="Story-215"><a href="#Story-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">next_step_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-216"><a href="#Story-216"><span class="linenos">216</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">next_step_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story-217"><a href="#Story-217"><span class="linenos">217</span></a>
</span><span id="Story-218"><a href="#Story-218"><span class="linenos">218</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-219"><a href="#Story-219"><span class="linenos">219</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="Story-220"><a href="#Story-220"><span class="linenos">220</span></a><span class="sd">        </span>
</span><span id="Story-221"><a href="#Story-221"><span class="linenos">221</span></a><span class="sd">        Parameters</span>
</span><span id="Story-222"><a href="#Story-222"><span class="linenos">222</span></a><span class="sd">        ---------</span>
</span><span id="Story-223"><a href="#Story-223"><span class="linenos">223</span></a><span class="sd">        text : str                                              Text for the basic version or for the button</span>
</span><span id="Story-224"><a href="#Story-224"><span class="linenos">224</span></a><span class="sd">        position : str, default=‘bottom’                        Position of the element (‘bottom’, ‘top’, ‘left’, ‘right’)</span>
</span><span id="Story-225"><a href="#Story-225"><span class="linenos">225</span></a><span class="sd">        type : str, optional                                    Display type (‘line_steps’, ‘button’, ‘stair_steps’)</span>
</span><span id="Story-226"><a href="#Story-226"><span class="linenos">226</span></a><span class="sd">        title : str, default=&quot;What can we do next?’             Title for special visualisations</span>
</span><span id="Story-227"><a href="#Story-227"><span class="linenos">227</span></a><span class="sd">        colour : str, optional                                  Text colour for the basic version</span>
</span><span id="Story-228"><a href="#Story-228"><span class="linenos">228</span></a><span class="sd">        font_family : str, default=‘Arial’                      Default font</span>
</span><span id="Story-229"><a href="#Story-229"><span class="linenos">229</span></a><span class="sd">        font_size : int, default=14                             Default font size</span>
</span><span id="Story-230"><a href="#Story-230"><span class="linenos">230</span></a><span class="sd">        texts : list of str                                     List of texts for line_steps and stair_steps</span>
</span><span id="Story-231"><a href="#Story-231"><span class="linenos">231</span></a><span class="sd">        url : str                                               URL for the button</span>
</span><span id="Story-232"><a href="#Story-232"><span class="linenos">232</span></a><span class="sd">        </span>
</span><span id="Story-233"><a href="#Story-233"><span class="linenos">233</span></a><span class="sd">        Parameters for Button</span>
</span><span id="Story-234"><a href="#Story-234"><span class="linenos">234</span></a><span class="sd">        ------------------</span>
</span><span id="Story-235"><a href="#Story-235"><span class="linenos">235</span></a><span class="sd">        button_width : int, default=120                         Button width</span>
</span><span id="Story-236"><a href="#Story-236"><span class="linenos">236</span></a><span class="sd">        button_height : int, default=40                         Height of the button</span>
</span><span id="Story-237"><a href="#Story-237"><span class="linenos">237</span></a><span class="sd">        button_color : str, default=‘#80C11E’                   Background colour of the button</span>
</span><span id="Story-238"><a href="#Story-238"><span class="linenos">238</span></a><span class="sd">        button_opacity : float, default=0.2                     Opacity of the button</span>
</span><span id="Story-239"><a href="#Story-239"><span class="linenos">239</span></a><span class="sd">        button_corner_radius : int, default=5                   Corner radius of the button</span>
</span><span id="Story-240"><a href="#Story-240"><span class="linenos">240</span></a><span class="sd">        button_text_color : str, default=‘black’                Button text colour</span>
</span><span id="Story-241"><a href="#Story-241"><span class="linenos">241</span></a><span class="sd">        button_font_family : str, optional                      Font specific to the button</span>
</span><span id="Story-242"><a href="#Story-242"><span class="linenos">242</span></a><span class="sd">        button_font_size : int, optional                        Font size for the button</span>
</span><span id="Story-243"><a href="#Story-243"><span class="linenos">243</span></a><span class="sd">        </span>
</span><span id="Story-244"><a href="#Story-244"><span class="linenos">244</span></a><span class="sd">        Parameters for Line Steps</span>
</span><span id="Story-245"><a href="#Story-245"><span class="linenos">245</span></a><span class="sd">        ----------------------</span>
</span><span id="Story-246"><a href="#Story-246"><span class="linenos">246</span></a><span class="sd">        line_steps_rect_width : int, default=10                 Rectangle width</span>
</span><span id="Story-247"><a href="#Story-247"><span class="linenos">247</span></a><span class="sd">        line_steps_rect_height : int, default=10                Height of rectangles</span>
</span><span id="Story-248"><a href="#Story-248"><span class="linenos">248</span></a><span class="sd">        line_steps_space : int, default=5                       Space between rectangles</span>
</span><span id="Story-249"><a href="#Story-249"><span class="linenos">249</span></a><span class="sd">        line_steps_chart_width : int, default=700               Total width of the chart</span>
</span><span id="Story-250"><a href="#Story-250"><span class="linenos">250</span></a><span class="sd">        line_steps_chart_height : int, default=100              Total chart height</span>
</span><span id="Story-251"><a href="#Story-251"><span class="linenos">251</span></a><span class="sd">        line_steps_color : str, default=‘#80C11E’               Colour of rectangles</span>
</span><span id="Story-252"><a href="#Story-252"><span class="linenos">252</span></a><span class="sd">        line_steps_opacity : float, default=0.2                 Opacity of rectangles</span>
</span><span id="Story-253"><a href="#Story-253"><span class="linenos">253</span></a><span class="sd">        line_steps_text_colour : str, default=‘black’           Text colour</span>
</span><span id="Story-254"><a href="#Story-254"><span class="linenos">254</span></a><span class="sd">        line_steps_font_family : str, optional                  Font specific to line steps</span>
</span><span id="Story-255"><a href="#Story-255"><span class="linenos">255</span></a><span class="sd">        line_steps_font_size : int, optional                    Font size for line steps</span>
</span><span id="Story-256"><a href="#Story-256"><span class="linenos">256</span></a><span class="sd">        </span>
</span><span id="Story-257"><a href="#Story-257"><span class="linenos">257</span></a><span class="sd">        Parameters for Stair Steps</span>
</span><span id="Story-258"><a href="#Story-258"><span class="linenos">258</span></a><span class="sd">        -----------------------</span>
</span><span id="Story-259"><a href="#Story-259"><span class="linenos">259</span></a><span class="sd">        stair_steps_rect_width : int, default=10                Width of steps</span>
</span><span id="Story-260"><a href="#Story-260"><span class="linenos">260</span></a><span class="sd">        stair_steps_rect_height : int, default=3                Height of steps</span>
</span><span id="Story-261"><a href="#Story-261"><span class="linenos">261</span></a><span class="sd">        stair_steps_chart_width : int, default=700              Total width of the chart</span>
</span><span id="Story-262"><a href="#Story-262"><span class="linenos">262</span></a><span class="sd">        stair_steps_chart_height : int, default=300             Total height of the chart</span>
</span><span id="Story-263"><a href="#Story-263"><span class="linenos">263</span></a><span class="sd">        stair_steps_color : str, default=‘#80C11E’              Colour of the steps</span>
</span><span id="Story-264"><a href="#Story-264"><span class="linenos">264</span></a><span class="sd">        stair_steps_opacity : float, default=0.2                Opacity of the steps</span>
</span><span id="Story-265"><a href="#Story-265"><span class="linenos">265</span></a><span class="sd">        stair_steps_text_colour : str, default=‘black’          Text colour</span>
</span><span id="Story-266"><a href="#Story-266"><span class="linenos">266</span></a><span class="sd">        stair_steps_font_family : str,                          Font specific to stair steps</span>
</span><span id="Story-267"><a href="#Story-267"><span class="linenos">267</span></a><span class="sd">        stair_steps_font_size : int, optional                   Font size for stair steps</span>
</span><span id="Story-268"><a href="#Story-268"><span class="linenos">268</span></a><span class="sd">        </span>
</span><span id="Story-269"><a href="#Story-269"><span class="linenos">269</span></a><span class="sd">        Title parameters</span>
</span><span id="Story-270"><a href="#Story-270"><span class="linenos">270</span></a><span class="sd">        ----------------------</span>
</span><span id="Story-271"><a href="#Story-271"><span class="linenos">271</span></a><span class="sd">        title_color : str, default=‘black’                      Title colour</span>
</span><span id="Story-272"><a href="#Story-272"><span class="linenos">272</span></a><span class="sd">        title_font_family : str, optional                       Specific font for the title</span>
</span><span id="Story-273"><a href="#Story-273"><span class="linenos">273</span></a><span class="sd">        title_font_size : int, optional                         Font size for the title</span>
</span><span id="Story-274"><a href="#Story-274"><span class="linenos">274</span></a><span class="sd">        </span>
</span><span id="Story-275"><a href="#Story-275"><span class="linenos">275</span></a><span class="sd">        Returns</span>
</span><span id="Story-276"><a href="#Story-276"><span class="linenos">276</span></a><span class="sd">        -------</span>
</span><span id="Story-277"><a href="#Story-277"><span class="linenos">277</span></a><span class="sd">        self : Story object                                     The current instance for method chaining</span>
</span><span id="Story-278"><a href="#Story-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-279"><a href="#Story-279"><span class="linenos">279</span></a>        
</span><span id="Story-280"><a href="#Story-280"><span class="linenos">280</span></a>        <span class="c1">#  Local import of NextStep to avoid circular imports</span>
</span><span id="Story-281"><a href="#Story-281"><span class="linenos">281</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="Story-282"><a href="#Story-282"><span class="linenos">282</span></a>    
</span><span id="Story-283"><a href="#Story-283"><span class="linenos">283</span></a>        <span class="c1"># Management of NextStep objects</span>
</span><span id="Story-284"><a href="#Story-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="n">button</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-285"><a href="#Story-285"><span class="linenos">285</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">button</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="Story-286"><a href="#Story-286"><span class="linenos">286</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘button’ parameter must be a NextStep of type ‘button’&quot;</span><span class="p">)</span>
</span><span id="Story-287"><a href="#Story-287"><span class="linenos">287</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">button</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story-288"><a href="#Story-288"><span class="linenos">288</span></a>        
</span><span id="Story-289"><a href="#Story-289"><span class="linenos">289</span></a>        <span class="k">elif</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-290"><a href="#Story-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="Story-291"><a href="#Story-291"><span class="linenos">291</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘line’ parameter must be a NextStep of type ‘line_steps’&quot;</span><span class="p">)</span>
</span><span id="Story-292"><a href="#Story-292"><span class="linenos">292</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">line</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story-293"><a href="#Story-293"><span class="linenos">293</span></a>        
</span><span id="Story-294"><a href="#Story-294"><span class="linenos">294</span></a>        <span class="k">elif</span> <span class="n">stairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-295"><a href="#Story-295"><span class="linenos">295</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stairs</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stairs</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="Story-296"><a href="#Story-296"><span class="linenos">296</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘stairs’ parameter must be a NextStep of type ‘stair_steps’&quot;</span><span class="p">)</span>
</span><span id="Story-297"><a href="#Story-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">stairs</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story-298"><a href="#Story-298"><span class="linenos">298</span></a>        
</span><span id="Story-299"><a href="#Story-299"><span class="linenos">299</span></a>        <span class="k">elif</span> <span class="n">vers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-300"><a href="#Story-300"><span class="linenos">300</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vers</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story-301"><a href="#Story-301"><span class="linenos">301</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘vers’ must be an instance of NextStep&quot;</span><span class="p">)</span>
</span><span id="Story-302"><a href="#Story-302"><span class="linenos">302</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">vers</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story-303"><a href="#Story-303"><span class="linenos">303</span></a>        
</span><span id="Story-304"><a href="#Story-304"><span class="linenos">304</span></a>        <span class="c1"># Basic version (text only)</span>
</span><span id="Story-305"><a href="#Story-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-306"><a href="#Story-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-307"><a href="#Story-307"><span class="linenos">307</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the basic version&quot;</span><span class="p">)</span>
</span><span id="Story-308"><a href="#Story-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-309"><a href="#Story-309"><span class="linenos">309</span></a>                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> 
</span><span id="Story-310"><a href="#Story-310"><span class="linenos">310</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="Story-311"><a href="#Story-311"><span class="linenos">311</span></a>                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="Story-312"><a href="#Story-312"><span class="linenos">312</span></a>                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;cta&#39;</span><span class="p">]</span>
</span><span id="Story-313"><a href="#Story-313"><span class="linenos">313</span></a>            <span class="p">})</span>
</span><span id="Story-314"><a href="#Story-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-315"><a href="#Story-315"><span class="linenos">315</span></a>
</span><span id="Story-316"><a href="#Story-316"><span class="linenos">316</span></a>        <span class="c1"># Type validation</span>
</span><span id="Story-317"><a href="#Story-317"><span class="linenos">317</span></a>        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;line_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">]</span>
</span><span id="Story-318"><a href="#Story-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
</span><span id="Story-319"><a href="#Story-319"><span class="linenos">319</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tipo non valido. Usare uno tra: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Story-320"><a href="#Story-320"><span class="linenos">320</span></a>
</span><span id="Story-321"><a href="#Story-321"><span class="linenos">321</span></a>        <span class="c1"># Chart creation by type</span>
</span><span id="Story-322"><a href="#Story-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="Story-323"><a href="#Story-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-324"><a href="#Story-324"><span class="linenos">324</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the button type&quot;</span><span class="p">)</span>
</span><span id="Story-325"><a href="#Story-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story-326"><a href="#Story-326"><span class="linenos">326</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘url’ parameter is required for the button type&quot;</span><span class="p">)</span>
</span><span id="Story-327"><a href="#Story-327"><span class="linenos">327</span></a>            
</span><span id="Story-328"><a href="#Story-328"><span class="linenos">328</span></a>            <span class="c1"># Button chart creation</span>
</span><span id="Story-329"><a href="#Story-329"><span class="linenos">329</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
</span><span id="Story-330"><a href="#Story-330"><span class="linenos">330</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
</span><span id="Story-331"><a href="#Story-331"><span class="linenos">331</span></a>                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="Story-332"><a href="#Story-332"><span class="linenos">332</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Story-333"><a href="#Story-333"><span class="linenos">333</span></a>                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Story-334"><a href="#Story-334"><span class="linenos">334</span></a>            <span class="p">}])</span>
</span><span id="Story-335"><a href="#Story-335"><span class="linenos">335</span></a>            
</span><span id="Story-336"><a href="#Story-336"><span class="linenos">336</span></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-337"><a href="#Story-337"><span class="linenos">337</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-338"><a href="#Story-338"><span class="linenos">338</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Story-339"><a href="#Story-339"><span class="linenos">339</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story-340"><a href="#Story-340"><span class="linenos">340</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="Story-341"><a href="#Story-341"><span class="linenos">341</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="Story-342"><a href="#Story-342"><span class="linenos">342</span></a>            <span class="p">)</span>
</span><span id="Story-343"><a href="#Story-343"><span class="linenos">343</span></a>            
</span><span id="Story-344"><a href="#Story-344"><span class="linenos">344</span></a>            <span class="n">button_bg</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story-345"><a href="#Story-345"><span class="linenos">345</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_color</span><span class="p">,</span>
</span><span id="Story-346"><a href="#Story-346"><span class="linenos">346</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">button_opacity</span><span class="p">,</span>
</span><span id="Story-347"><a href="#Story-347"><span class="linenos">347</span></a>                <span class="n">cornerRadius</span><span class="o">=</span><span class="n">button_corner_radius</span><span class="p">,</span>
</span><span id="Story-348"><a href="#Story-348"><span class="linenos">348</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="Story-349"><a href="#Story-349"><span class="linenos">349</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="Story-350"><a href="#Story-350"><span class="linenos">350</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-351"><a href="#Story-351"><span class="linenos">351</span></a>                <span class="n">href</span><span class="o">=</span><span class="s1">&#39;url:N&#39;</span>
</span><span id="Story-352"><a href="#Story-352"><span class="linenos">352</span></a>            <span class="p">)</span>
</span><span id="Story-353"><a href="#Story-353"><span class="linenos">353</span></a>            
</span><span id="Story-354"><a href="#Story-354"><span class="linenos">354</span></a>            <span class="n">button_text</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-355"><a href="#Story-355"><span class="linenos">355</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">button_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story-356"><a href="#Story-356"><span class="linenos">356</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">button_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story-357"><a href="#Story-357"><span class="linenos">357</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story-358"><a href="#Story-358"><span class="linenos">358</span></a>                <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="Story-359"><a href="#Story-359"><span class="linenos">359</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_text_color</span>
</span><span id="Story-360"><a href="#Story-360"><span class="linenos">360</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-361"><a href="#Story-361"><span class="linenos">361</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
</span><span id="Story-362"><a href="#Story-362"><span class="linenos">362</span></a>            <span class="p">)</span>
</span><span id="Story-363"><a href="#Story-363"><span class="linenos">363</span></a>            
</span><span id="Story-364"><a href="#Story-364"><span class="linenos">364</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">button_bg</span><span class="p">,</span> <span class="n">button_text</span><span class="p">)</span>
</span><span id="Story-365"><a href="#Story-365"><span class="linenos">365</span></a>            
</span><span id="Story-366"><a href="#Story-366"><span class="linenos">366</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="Story-367"><a href="#Story-367"><span class="linenos">367</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Story-368"><a href="#Story-368"><span class="linenos">368</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;It is necessary to provide a list of texts for line_steps&quot;</span><span class="p">)</span>
</span><span id="Story-369"><a href="#Story-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="Story-370"><a href="#Story-370"><span class="linenos">370</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="Story-371"><a href="#Story-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story-372"><a href="#Story-372"><span class="linenos">372</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="Story-373"><a href="#Story-373"><span class="linenos">373</span></a>                
</span><span id="Story-374"><a href="#Story-374"><span class="linenos">374</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="Story-375"><a href="#Story-375"><span class="linenos">375</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="Story-376"><a href="#Story-376"><span class="linenos">376</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-377"><a href="#Story-377"><span class="linenos">377</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-378"><a href="#Story-378"><span class="linenos">378</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">line_steps_space</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-379"><a href="#Story-379"><span class="linenos">379</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_steps_rect_height</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-380"><a href="#Story-380"><span class="linenos">380</span></a>            
</span><span id="Story-381"><a href="#Story-381"><span class="linenos">381</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story-382"><a href="#Story-382"><span class="linenos">382</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="Story-383"><a href="#Story-383"><span class="linenos">383</span></a>            <span class="p">})</span>
</span><span id="Story-384"><a href="#Story-384"><span class="linenos">384</span></a>            
</span><span id="Story-385"><a href="#Story-385"><span class="linenos">385</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="Story-386"><a href="#Story-386"><span class="linenos">386</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story-387"><a href="#Story-387"><span class="linenos">387</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_color</span><span class="p">,</span>
</span><span id="Story-388"><a href="#Story-388"><span class="linenos">388</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">line_steps_opacity</span>
</span><span id="Story-389"><a href="#Story-389"><span class="linenos">389</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-390"><a href="#Story-390"><span class="linenos">390</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-391"><a href="#Story-391"><span class="linenos">391</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-392"><a href="#Story-392"><span class="linenos">392</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story-393"><a href="#Story-393"><span class="linenos">393</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story-394"><a href="#Story-394"><span class="linenos">394</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story-395"><a href="#Story-395"><span class="linenos">395</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">line_steps_chart_width</span><span class="p">,</span>
</span><span id="Story-396"><a href="#Story-396"><span class="linenos">396</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">line_steps_chart_height</span>
</span><span id="Story-397"><a href="#Story-397"><span class="linenos">397</span></a>            <span class="p">)</span>
</span><span id="Story-398"><a href="#Story-398"><span class="linenos">398</span></a>            
</span><span id="Story-399"><a href="#Story-399"><span class="linenos">399</span></a>            <span class="c1"># Add text labels</span>
</span><span id="Story-400"><a href="#Story-400"><span class="linenos">400</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-401"><a href="#Story-401"><span class="linenos">401</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">line_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story-402"><a href="#Story-402"><span class="linenos">402</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">line_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story-403"><a href="#Story-403"><span class="linenos">403</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story-404"><a href="#Story-404"><span class="linenos">404</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story-405"><a href="#Story-405"><span class="linenos">405</span></a>                <span class="n">lineHeight</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
</span><span id="Story-406"><a href="#Story-406"><span class="linenos">406</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_text_color</span>
</span><span id="Story-407"><a href="#Story-407"><span class="linenos">407</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-408"><a href="#Story-408"><span class="linenos">408</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text:N&#39;</span><span class="p">,</span>
</span><span id="Story-409"><a href="#Story-409"><span class="linenos">409</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-410"><a href="#Story-410"><span class="linenos">410</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_half:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-411"><a href="#Story-411"><span class="linenos">411</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="Story-412"><a href="#Story-412"><span class="linenos">412</span></a>                <span class="n">y_half</span><span class="o">=</span><span class="s1">&#39;datum.y2/2&#39;</span>
</span><span id="Story-413"><a href="#Story-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="Story-414"><a href="#Story-414"><span class="linenos">414</span></a>            
</span><span id="Story-415"><a href="#Story-415"><span class="linenos">415</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story-416"><a href="#Story-416"><span class="linenos">416</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story-417"><a href="#Story-417"><span class="linenos">417</span></a>                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_width</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">line_steps_space</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="Story-418"><a href="#Story-418"><span class="linenos">418</span></a>                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="Story-419"><a href="#Story-419"><span class="linenos">419</span></a>                    <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="Story-420"><a href="#Story-420"><span class="linenos">420</span></a>                    <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="Story-421"><a href="#Story-421"><span class="linenos">421</span></a>                <span class="p">})</span>
</span><span id="Story-422"><a href="#Story-422"><span class="linenos">422</span></a>                
</span><span id="Story-423"><a href="#Story-423"><span class="linenos">423</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="Story-424"><a href="#Story-424"><span class="linenos">424</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Story-425"><a href="#Story-425"><span class="linenos">425</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Story-426"><a href="#Story-426"><span class="linenos">426</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-427"><a href="#Story-427"><span class="linenos">427</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-428"><a href="#Story-428"><span class="linenos">428</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-429"><a href="#Story-429"><span class="linenos">429</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story-430"><a href="#Story-430"><span class="linenos">430</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story-431"><a href="#Story-431"><span class="linenos">431</span></a>                <span class="p">)</span>
</span><span id="Story-432"><a href="#Story-432"><span class="linenos">432</span></a>                
</span><span id="Story-433"><a href="#Story-433"><span class="linenos">433</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story-434"><a href="#Story-434"><span class="linenos">434</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Story-435"><a href="#Story-435"><span class="linenos">435</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story-436"><a href="#Story-436"><span class="linenos">436</span></a>                
</span><span id="Story-437"><a href="#Story-437"><span class="linenos">437</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="Story-438"><a href="#Story-438"><span class="linenos">438</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Story-439"><a href="#Story-439"><span class="linenos">439</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide a list of texts for stair_steps&quot;</span><span class="p">)</span>
</span><span id="Story-440"><a href="#Story-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="Story-441"><a href="#Story-441"><span class="linenos">441</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="Story-442"><a href="#Story-442"><span class="linenos">442</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story-443"><a href="#Story-443"><span class="linenos">443</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="Story-444"><a href="#Story-444"><span class="linenos">444</span></a>                
</span><span id="Story-445"><a href="#Story-445"><span class="linenos">445</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="Story-446"><a href="#Story-446"><span class="linenos">446</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="Story-447"><a href="#Story-447"><span class="linenos">447</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-448"><a href="#Story-448"><span class="linenos">448</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-449"><a href="#Story-449"><span class="linenos">449</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-450"><a href="#Story-450"><span class="linenos">450</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story-451"><a href="#Story-451"><span class="linenos">451</span></a>            
</span><span id="Story-452"><a href="#Story-452"><span class="linenos">452</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story-453"><a href="#Story-453"><span class="linenos">453</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="Story-454"><a href="#Story-454"><span class="linenos">454</span></a>            <span class="p">})</span>
</span><span id="Story-455"><a href="#Story-455"><span class="linenos">455</span></a>            
</span><span id="Story-456"><a href="#Story-456"><span class="linenos">456</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="Story-457"><a href="#Story-457"><span class="linenos">457</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story-458"><a href="#Story-458"><span class="linenos">458</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_color</span><span class="p">,</span>
</span><span id="Story-459"><a href="#Story-459"><span class="linenos">459</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">stair_steps_opacity</span>
</span><span id="Story-460"><a href="#Story-460"><span class="linenos">460</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-461"><a href="#Story-461"><span class="linenos">461</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-462"><a href="#Story-462"><span class="linenos">462</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">stair_steps_rect_height</span><span class="p">])),</span>
</span><span id="Story-463"><a href="#Story-463"><span class="linenos">463</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story-464"><a href="#Story-464"><span class="linenos">464</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story-465"><a href="#Story-465"><span class="linenos">465</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story-466"><a href="#Story-466"><span class="linenos">466</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">stair_steps_chart_width</span><span class="p">,</span>
</span><span id="Story-467"><a href="#Story-467"><span class="linenos">467</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">stair_steps_chart_height</span>
</span><span id="Story-468"><a href="#Story-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="Story-469"><a href="#Story-469"><span class="linenos">469</span></a>            
</span><span id="Story-470"><a href="#Story-470"><span class="linenos">470</span></a>            <span class="c1"># Add text labels</span>
</span><span id="Story-471"><a href="#Story-471"><span class="linenos">471</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-472"><a href="#Story-472"><span class="linenos">472</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">stair_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story-473"><a href="#Story-473"><span class="linenos">473</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">stair_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story-474"><a href="#Story-474"><span class="linenos">474</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story-475"><a href="#Story-475"><span class="linenos">475</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story-476"><a href="#Story-476"><span class="linenos">476</span></a>                <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="Story-477"><a href="#Story-477"><span class="linenos">477</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_text_color</span>
</span><span id="Story-478"><a href="#Story-478"><span class="linenos">478</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-479"><a href="#Story-479"><span class="linenos">479</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span>
</span><span id="Story-480"><a href="#Story-480"><span class="linenos">480</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-481"><a href="#Story-481"><span class="linenos">481</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_mid:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-482"><a href="#Story-482"><span class="linenos">482</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="Story-483"><a href="#Story-483"><span class="linenos">483</span></a>                <span class="n">y_mid</span><span class="o">=</span><span class="s1">&#39;(datum.y + datum.y2)/2&#39;</span>
</span><span id="Story-484"><a href="#Story-484"><span class="linenos">484</span></a>            <span class="p">)</span>
</span><span id="Story-485"><a href="#Story-485"><span class="linenos">485</span></a>            
</span><span id="Story-486"><a href="#Story-486"><span class="linenos">486</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story-487"><a href="#Story-487"><span class="linenos">487</span></a>                <span class="n">line_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-488"><a href="#Story-488"><span class="linenos">488</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Story-489"><a href="#Story-489"><span class="linenos">489</span></a>                    <span class="n">line_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-490"><a href="#Story-490"><span class="linenos">490</span></a>                        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="Story-491"><a href="#Story-491"><span class="linenos">491</span></a>                        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="Story-492"><a href="#Story-492"><span class="linenos">492</span></a>                        <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Story-493"><a href="#Story-493"><span class="linenos">493</span></a>                        <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story-494"><a href="#Story-494"><span class="linenos">494</span></a>                    <span class="p">})</span>
</span><span id="Story-495"><a href="#Story-495"><span class="linenos">495</span></a>                
</span><span id="Story-496"><a href="#Story-496"><span class="linenos">496</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">line_data</span><span class="p">)</span>
</span><span id="Story-497"><a href="#Story-497"><span class="linenos">497</span></a>                
</span><span id="Story-498"><a href="#Story-498"><span class="linenos">498</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="Story-499"><a href="#Story-499"><span class="linenos">499</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Story-500"><a href="#Story-500"><span class="linenos">500</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Story-501"><a href="#Story-501"><span class="linenos">501</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-502"><a href="#Story-502"><span class="linenos">502</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-503"><a href="#Story-503"><span class="linenos">503</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story-504"><a href="#Story-504"><span class="linenos">504</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story-505"><a href="#Story-505"><span class="linenos">505</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story-506"><a href="#Story-506"><span class="linenos">506</span></a>                <span class="p">)</span>
</span><span id="Story-507"><a href="#Story-507"><span class="linenos">507</span></a>                
</span><span id="Story-508"><a href="#Story-508"><span class="linenos">508</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story-509"><a href="#Story-509"><span class="linenos">509</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Story-510"><a href="#Story-510"><span class="linenos">510</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story-511"><a href="#Story-511"><span class="linenos">511</span></a>
</span><span id="Story-512"><a href="#Story-512"><span class="linenos">512</span></a>        <span class="c1"># Addition of title with customisable font</span>
</span><span id="Story-513"><a href="#Story-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
</span><span id="Story-514"><a href="#Story-514"><span class="linenos">514</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story-515"><a href="#Story-515"><span class="linenos">515</span></a>                <span class="n">title</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">TitleParams</span><span class="p">(</span>
</span><span id="Story-516"><a href="#Story-516"><span class="linenos">516</span></a>                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
</span><span id="Story-517"><a href="#Story-517"><span class="linenos">517</span></a>                    <span class="n">fontSize</span><span class="o">=</span><span class="n">title_font_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">),</span>
</span><span id="Story-518"><a href="#Story-518"><span class="linenos">518</span></a>                    <span class="n">font</span><span class="o">=</span><span class="n">title_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story-519"><a href="#Story-519"><span class="linenos">519</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">title_color</span><span class="p">,</span>
</span><span id="Story-520"><a href="#Story-520"><span class="linenos">520</span></a>                    <span class="n">offset</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Story-521"><a href="#Story-521"><span class="linenos">521</span></a>                <span class="p">)</span>
</span><span id="Story-522"><a href="#Story-522"><span class="linenos">522</span></a>            <span class="p">)</span>
</span><span id="Story-523"><a href="#Story-523"><span class="linenos">523</span></a>
</span><span id="Story-524"><a href="#Story-524"><span class="linenos">524</span></a>        <span class="c1"># Addition to layer</span>
</span><span id="Story-525"><a href="#Story-525"><span class="linenos">525</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-526"><a href="#Story-526"><span class="linenos">526</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">,</span>
</span><span id="Story-527"><a href="#Story-527"><span class="linenos">527</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">chart</span><span class="p">,</span>
</span><span id="Story-528"><a href="#Story-528"><span class="linenos">528</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>
</span><span id="Story-529"><a href="#Story-529"><span class="linenos">529</span></a>        <span class="p">})</span>
</span><span id="Story-530"><a href="#Story-530"><span class="linenos">530</span></a>        
</span><span id="Story-531"><a href="#Story-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-532"><a href="#Story-532"><span class="linenos">532</span></a>
</span><span id="Story-533"><a href="#Story-533"><span class="linenos">533</span></a>    <span class="k">def</span> <span class="nf">add_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_point</span><span class="p">,</span> <span class="n">y_point</span><span class="p">,</span> <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&quot;Point of interest&quot;</span><span class="p">,</span> 
</span><span id="Story-534"><a href="#Story-534"><span class="linenos">534</span></a>                                     <span class="n">arrow_direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">arrow_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">arrow_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="Story-535"><a href="#Story-535"><span class="linenos">535</span></a>                                     <span class="n">label_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="Story-536"><a href="#Story-536"><span class="linenos">536</span></a>                                     <span class="n">show_point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="Story-537"><a href="#Story-537"><span class="linenos">537</span></a>                                     <span class="n">arrow_dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">arrow_dy</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span>
</span><span id="Story-538"><a href="#Story-538"><span class="linenos">538</span></a>                                     <span class="n">label_dx</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">label_dy</span><span class="o">=-</span><span class="mi">37</span><span class="p">):</span>
</span><span id="Story-539"><a href="#Story-539"><span class="linenos">539</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-540"><a href="#Story-540"><span class="linenos">540</span></a><span class="sd">        Create an arrow annotation on the graph.</span>
</span><span id="Story-541"><a href="#Story-541"><span class="linenos">541</span></a><span class="sd">        </span>
</span><span id="Story-542"><a href="#Story-542"><span class="linenos">542</span></a><span class="sd">        This method is essential for highlighting specific points in the graph and adding</span>
</span><span id="Story-543"><a href="#Story-543"><span class="linenos">543</span></a><span class="sd">        contextual explanations. It is particularly useful for data narration, allowing</span>
</span><span id="Story-544"><a href="#Story-544"><span class="linenos">544</span></a><span class="sd">        to guide the observer&#39;s attention to relevant aspects of the visualisation.</span>
</span><span id="Story-545"><a href="#Story-545"><span class="linenos">545</span></a>
</span><span id="Story-546"><a href="#Story-546"><span class="linenos">546</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-547"><a href="#Story-547"><span class="linenos">547</span></a><span class="sd">        - x_point, y_point: Coordinates of the point to be annotated</span>
</span><span id="Story-548"><a href="#Story-548"><span class="linenos">548</span></a><span class="sd">        - annotation_text: Text of the annotation (default: ‘Point of interest’)</span>
</span><span id="Story-549"><a href="#Story-549"><span class="linenos">549</span></a><span class="sd">        - arrow_direction: Direction of the arrow (default: ‘right’)</span>
</span><span id="Story-550"><a href="#Story-550"><span class="linenos">550</span></a><span class="sd">        - arrow_color, arrow_size: Arrow colour and size</span>
</span><span id="Story-551"><a href="#Story-551"><span class="linenos">551</span></a><span class="sd">        - label_colour, label_size: Colour and size of the annotation text</span>
</span><span id="Story-552"><a href="#Story-552"><span class="linenos">552</span></a><span class="sd">        - show_point: If True, shows a point at the annotation location</span>
</span><span id="Story-553"><a href="#Story-553"><span class="linenos">553</span></a><span class="sd">        - point_color, point_size: Colour and size of the point</span>
</span><span id="Story-554"><a href="#Story-554"><span class="linenos">554</span></a><span class="sd">        - arrow_dx, arrow_dy: Distances in pixels to be added to the arrow position (default:0, -45)</span>
</span><span id="Story-555"><a href="#Story-555"><span class="linenos">555</span></a><span class="sd">        - label_dx, label_dy: Distances in pixels to be added to the label position (default:37, -37)</span>
</span><span id="Story-556"><a href="#Story-556"><span class="linenos">556</span></a>
</span><span id="Story-557"><a href="#Story-557"><span class="linenos">557</span></a><span class="sd">        returns:</span>
</span><span id="Story-558"><a href="#Story-558"><span class="linenos">558</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story-559"><a href="#Story-559"><span class="linenos">559</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-560"><a href="#Story-560"><span class="linenos">560</span></a>        
</span><span id="Story-561"><a href="#Story-561"><span class="linenos">561</span></a>        <span class="c1"># Dictionary that maps arrow directions to corresponding Unicode symbols</span>
</span><span id="Story-562"><a href="#Story-562"><span class="linenos">562</span></a>        <span class="n">arrow_symbols</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story-563"><a href="#Story-563"><span class="linenos">563</span></a>            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;←&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;→&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span> <span class="s1">&#39;↓&#39;</span><span class="p">,</span>
</span><span id="Story-564"><a href="#Story-564"><span class="linenos">564</span></a>            <span class="s1">&#39;upleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↖&#39;</span><span class="p">,</span> <span class="s1">&#39;upright&#39;</span><span class="p">:</span> <span class="s1">&#39;↗&#39;</span><span class="p">,</span> <span class="s1">&#39;downleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↙&#39;</span><span class="p">,</span> <span class="s1">&#39;downright&#39;</span><span class="p">:</span> <span class="s1">&#39;↘&#39;</span><span class="p">,</span>
</span><span id="Story-565"><a href="#Story-565"><span class="linenos">565</span></a>            <span class="s1">&#39;leftup&#39;</span><span class="p">:</span> <span class="s1">&#39;↰&#39;</span><span class="p">,</span> <span class="s1">&#39;leftdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↲&#39;</span><span class="p">,</span> <span class="s1">&#39;rightup&#39;</span><span class="p">:</span> <span class="s1">&#39;↱&#39;</span><span class="p">,</span> <span class="s1">&#39;rightdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↳&#39;</span><span class="p">,</span>
</span><span id="Story-566"><a href="#Story-566"><span class="linenos">566</span></a>            <span class="s1">&#39;upleftcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↺&#39;</span><span class="p">,</span> <span class="s1">&#39;uprightcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↻&#39;</span>
</span><span id="Story-567"><a href="#Story-567"><span class="linenos">567</span></a>        <span class="p">}</span>
</span><span id="Story-568"><a href="#Story-568"><span class="linenos">568</span></a>
</span><span id="Story-569"><a href="#Story-569"><span class="linenos">569</span></a>        <span class="c1"># Check that the direction of the arrow is valid</span>
</span><span id="Story-570"><a href="#Story-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="n">arrow_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrow_symbols</span><span class="p">:</span>
</span><span id="Story-571"><a href="#Story-571"><span class="linenos">571</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid arrow direction. Use one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arrow_symbols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Story-572"><a href="#Story-572"><span class="linenos">572</span></a>
</span><span id="Story-573"><a href="#Story-573"><span class="linenos">573</span></a>        <span class="c1"># Select the appropriate arrow symbol</span>
</span><span id="Story-574"><a href="#Story-574"><span class="linenos">574</span></a>        <span class="n">arrow_symbol</span> <span class="o">=</span> <span class="n">arrow_symbols</span><span class="p">[</span><span class="n">arrow_direction</span><span class="p">]</span>
</span><span id="Story-575"><a href="#Story-575"><span class="linenos">575</span></a>        
</span><span id="Story-576"><a href="#Story-576"><span class="linenos">576</span></a>        <span class="c1"># checks whether the encoding has already been defined</span>
</span><span id="Story-577"><a href="#Story-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">)</span><span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
</span><span id="Story-578"><a href="#Story-578"><span class="linenos">578</span></a>            <span class="c1"># If encoding is not defined use of default values</span>
</span><span id="Story-579"><a href="#Story-579"><span class="linenos">579</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="Story-580"><a href="#Story-580"><span class="linenos">580</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="Story-581"><a href="#Story-581"><span class="linenos">581</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Story-582"><a href="#Story-582"><span class="linenos">582</span></a>            <span class="c1"># If encoding is defined, we extract the data types for the x and y axes</span>
</span><span id="Story-583"><a href="#Story-583"><span class="linenos">583</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story-584"><a href="#Story-584"><span class="linenos">584</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story-585"><a href="#Story-585"><span class="linenos">585</span></a>
</span><span id="Story-586"><a href="#Story-586"><span class="linenos">586</span></a>        <span class="c1"># Explanation of data type extraction:</span>
</span><span id="Story-587"><a href="#Story-587"><span class="linenos">587</span></a>        <span class="c1"># 1. We first check whether the encoding has been defined. This is important because</span>
</span><span id="Story-588"><a href="#Story-588"><span class="linenos">588</span></a>        <span class="c1"># the user may call this method before defining the encoding of the graph.</span>
</span><span id="Story-589"><a href="#Story-589"><span class="linenos">589</span></a>        <span class="c1"># (The encoding in Altair defines how the data is mapped to the visual properties of the graph).</span>
</span><span id="Story-590"><a href="#Story-590"><span class="linenos">590</span></a>        <span class="c1"># 2. If encoding is not defined, we use ‘Q’ (Quantitative) as the default data type</span>
</span><span id="Story-591"><a href="#Story-591"><span class="linenos">591</span></a>        <span class="c1"># for both axes. This allows the method to work even without a defined encoding.</span>
</span><span id="Story-592"><a href="#Story-592"><span class="linenos">592</span></a>        <span class="c1"># 3. If the encoding is defined, we proceed with the data type extraction as before:</span>
</span><span id="Story-593"><a href="#Story-593"><span class="linenos">593</span></a>        <span class="c1"># - self.chart.encoding.x.shorthand: accesses the shorthand of the x-axis</span>
</span><span id="Story-594"><a href="#Story-594"><span class="linenos">594</span></a>        <span class="c1"># .shorthand: In Altair, ‘shorthand’ is a concise notation for specifying the encoding.</span>
</span><span id="Story-595"><a href="#Story-595"><span class="linenos">595</span></a>        <span class="c1"># Example of shorthand: ‘column:Q’ where ‘column’ is the name of the data column</span>
</span><span id="Story-596"><a href="#Story-596"><span class="linenos">596</span></a>        <span class="c1"># and ‘Q’ is the data type (in this case, Quantitative).</span>
</span><span id="Story-597"><a href="#Story-597"><span class="linenos">597</span></a>        <span class="c1"># - split(‘:’)[-1]: splits the shorthand at ‘:’ and takes the last element (the data type)</span>
</span><span id="Story-598"><a href="#Story-598"><span class="linenos">598</span></a>        <span class="c1"># Example: If shorthand is ‘price:Q’, split(‘:’) will return [‘price’, ‘Q’].</span>
</span><span id="Story-599"><a href="#Story-599"><span class="linenos">599</span></a>        <span class="c1"># 4. The extracted data type will be one of:</span>
</span><span id="Story-600"><a href="#Story-600"><span class="linenos">600</span></a>        <span class="c1"># - ‘Q’: Quantitative (continuous numeric)</span>
</span><span id="Story-601"><a href="#Story-601"><span class="linenos">601</span></a>        <span class="c1"># - ‘O’: Ordinal (ordered categories)</span>
</span><span id="Story-602"><a href="#Story-602"><span class="linenos">602</span></a>        <span class="c1"># N&#39;: Nominal (unordered categories)</span>
</span><span id="Story-603"><a href="#Story-603"><span class="linenos">603</span></a>        <span class="c1"># T&#39;: Temporal (dates or times)</span>
</span><span id="Story-604"><a href="#Story-604"><span class="linenos">604</span></a>        
</span><span id="Story-605"><a href="#Story-605"><span class="linenos">605</span></a>        <span class="c1"># Important: This operation is essential to ensure that the annotations</span>
</span><span id="Story-606"><a href="#Story-606"><span class="linenos">606</span></a>        <span class="c1"># added to the graph are consistent with the original axis data types.</span>
</span><span id="Story-607"><a href="#Story-607"><span class="linenos">607</span></a>        <span class="c1"># Without this match, annotations may be positioned</span>
</span><span id="Story-608"><a href="#Story-608"><span class="linenos">608</span></a>        <span class="c1"># incorrectly or cause rendering errors.</span>
</span><span id="Story-609"><a href="#Story-609"><span class="linenos">609</span></a>
</span><span id="Story-610"><a href="#Story-610"><span class="linenos">610</span></a>        <span class="c1"># Create a DataFrame with a single point for the annotation</span>
</span><span id="Story-611"><a href="#Story-611"><span class="linenos">611</span></a>        <span class="n">annotation_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_point</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">y_point</span><span class="p">]})</span>
</span><span id="Story-612"><a href="#Story-612"><span class="linenos">612</span></a>        
</span><span id="Story-613"><a href="#Story-613"><span class="linenos">613</span></a>        <span class="c1"># Internal function to create the correct encoding based on the data type</span>
</span><span id="Story-614"><a href="#Story-614"><span class="linenos">614</span></a>        <span class="k">def</span> <span class="nf">create_encoding</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="Story-615"><a href="#Story-615"><span class="linenos">615</span></a>            <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-616"><a href="#Story-616"><span class="linenos">616</span></a><span class="sd">            Creates the appropriate encoding for Altair based on the data type.</span>
</span><span id="Story-617"><a href="#Story-617"><span class="linenos">617</span></a><span class="sd">            This function is crucial to ensure that the annotation is</span>
</span><span id="Story-618"><a href="#Story-618"><span class="linenos">618</span></a><span class="sd">            consistent with the original chart data type.</span>
</span><span id="Story-619"><a href="#Story-619"><span class="linenos">619</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Story-620"><a href="#Story-620"><span class="linenos">620</span></a>            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>  <span class="c1"># Ordinale</span>
</span><span id="Story-621"><a href="#Story-621"><span class="linenos">621</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span>
</span><span id="Story-622"><a href="#Story-622"><span class="linenos">622</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>  <span class="c1"># Nominale</span>
</span><span id="Story-623"><a href="#Story-623"><span class="linenos">623</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span>
</span><span id="Story-624"><a href="#Story-624"><span class="linenos">624</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>  <span class="c1"># Temporale</span>
</span><span id="Story-625"><a href="#Story-625"><span class="linenos">625</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span>
</span><span id="Story-626"><a href="#Story-626"><span class="linenos">626</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Quantitativo (default)</span>
</span><span id="Story-627"><a href="#Story-627"><span class="linenos">627</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span>
</span><span id="Story-628"><a href="#Story-628"><span class="linenos">628</span></a>
</span><span id="Story-629"><a href="#Story-629"><span class="linenos">629</span></a>        <span class="c1"># Initialises the list of annotation layers</span>
</span><span id="Story-630"><a href="#Story-630"><span class="linenos">630</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-631"><a href="#Story-631"><span class="linenos">631</span></a>
</span><span id="Story-632"><a href="#Story-632"><span class="linenos">632</span></a>        <span class="c1"># Adds full stop if required</span>
</span><span id="Story-633"><a href="#Story-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="n">show_point</span><span class="p">:</span>
</span><span id="Story-634"><a href="#Story-634"><span class="linenos">634</span></a>            <span class="n">point_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_point</span><span class="p">(</span>
</span><span id="Story-635"><a href="#Story-635"><span class="linenos">635</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
</span><span id="Story-636"><a href="#Story-636"><span class="linenos">636</span></a>                <span class="n">size</span><span class="o">=</span><span class="n">point_size</span>
</span><span id="Story-637"><a href="#Story-637"><span class="linenos">637</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-638"><a href="#Story-638"><span class="linenos">638</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story-639"><a href="#Story-639"><span class="linenos">639</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story-640"><a href="#Story-640"><span class="linenos">640</span></a>            <span class="p">)</span>
</span><span id="Story-641"><a href="#Story-641"><span class="linenos">641</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_layer</span><span class="p">)</span>
</span><span id="Story-642"><a href="#Story-642"><span class="linenos">642</span></a>
</span><span id="Story-643"><a href="#Story-643"><span class="linenos">643</span></a>        <span class="c1"># Adds the arrow</span>
</span><span id="Story-644"><a href="#Story-644"><span class="linenos">644</span></a>        <span class="c1"># Utilizziamo mark_text per disegnare la freccia usando un carattere Unicode</span>
</span><span id="Story-645"><a href="#Story-645"><span class="linenos">645</span></a>        <span class="n">arrow_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-646"><a href="#Story-646"><span class="linenos">646</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">arrow_symbol</span><span class="p">,</span> 
</span><span id="Story-647"><a href="#Story-647"><span class="linenos">647</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">arrow_size</span><span class="p">,</span>
</span><span id="Story-648"><a href="#Story-648"><span class="linenos">648</span></a>            <span class="n">dx</span><span class="o">=</span><span class="n">arrow_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position the arrow                   was 22</span>
</span><span id="Story-649"><a href="#Story-649"><span class="linenos">649</span></a>            <span class="n">dy</span><span class="o">=</span><span class="n">arrow_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position the arrow                     was -22</span>
</span><span id="Story-650"><a href="#Story-650"><span class="linenos">650</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span>
</span><span id="Story-651"><a href="#Story-651"><span class="linenos">651</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-652"><a href="#Story-652"><span class="linenos">652</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story-653"><a href="#Story-653"><span class="linenos">653</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story-654"><a href="#Story-654"><span class="linenos">654</span></a>        <span class="p">)</span>
</span><span id="Story-655"><a href="#Story-655"><span class="linenos">655</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arrow_layer</span><span class="p">)</span>
</span><span id="Story-656"><a href="#Story-656"><span class="linenos">656</span></a>
</span><span id="Story-657"><a href="#Story-657"><span class="linenos">657</span></a>        <span class="c1"># Adds text label</span>
</span><span id="Story-658"><a href="#Story-658"><span class="linenos">658</span></a>        <span class="n">label_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-659"><a href="#Story-659"><span class="linenos">659</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story-660"><a href="#Story-660"><span class="linenos">660</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
</span><span id="Story-661"><a href="#Story-661"><span class="linenos">661</span></a>            <span class="n">dx</span><span class="o">=</span> <span class="n">label_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position text                     was 37</span>
</span><span id="Story-662"><a href="#Story-662"><span class="linenos">662</span></a>            <span class="n">dy</span><span class="o">=</span> <span class="n">label_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position text                       was -37</span>
</span><span id="Story-663"><a href="#Story-663"><span class="linenos">663</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="Story-664"><a href="#Story-664"><span class="linenos">664</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">label_color</span><span class="p">,</span>
</span><span id="Story-665"><a href="#Story-665"><span class="linenos">665</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">annotation_text</span>
</span><span id="Story-666"><a href="#Story-666"><span class="linenos">666</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-667"><a href="#Story-667"><span class="linenos">667</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story-668"><a href="#Story-668"><span class="linenos">668</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story-669"><a href="#Story-669"><span class="linenos">669</span></a>        <span class="p">)</span>
</span><span id="Story-670"><a href="#Story-670"><span class="linenos">670</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
</span><span id="Story-671"><a href="#Story-671"><span class="linenos">671</span></a>
</span><span id="Story-672"><a href="#Story-672"><span class="linenos">672</span></a>        <span class="c1"># Combine all layers into a single annotation</span>
</span><span id="Story-673"><a href="#Story-673"><span class="linenos">673</span></a>        <span class="n">annotation</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="Story-674"><a href="#Story-674"><span class="linenos">674</span></a>
</span><span id="Story-675"><a href="#Story-675"><span class="linenos">675</span></a>        <span class="c1"># Adds annotation to history layers</span>
</span><span id="Story-676"><a href="#Story-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story-677"><a href="#Story-677"><span class="linenos">677</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
</span><span id="Story-678"><a href="#Story-678"><span class="linenos">678</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">annotation</span>
</span><span id="Story-679"><a href="#Story-679"><span class="linenos">679</span></a>        <span class="p">})</span>
</span><span id="Story-680"><a href="#Story-680"><span class="linenos">680</span></a>
</span><span id="Story-681"><a href="#Story-681"><span class="linenos">681</span></a>        <span class="c1"># Note on flexibility and robustness:</span>
</span><span id="Story-682"><a href="#Story-682"><span class="linenos">682</span></a>        <span class="c1"># This approach makes the add_annotation method more flexible,</span>
</span><span id="Story-683"><a href="#Story-683"><span class="linenos">683</span></a>        <span class="c1"># as it can automatically adapt to different types of graphs without</span>
</span><span id="Story-684"><a href="#Story-684"><span class="linenos">684</span></a>        <span class="c1"># requiring manual input on the axis data type. In addition, using</span>
</span><span id="Story-685"><a href="#Story-685"><span class="linenos">685</span></a>        <span class="c1"># the Altair shorthand, the code automatically adapts even if the user</span>
</span><span id="Story-686"><a href="#Story-686"><span class="linenos">686</span></a>        <span class="c1"># has specified the encoding in different ways (e.g., using alt.X(‘column:Q’)</span>
</span><span id="Story-687"><a href="#Story-687"><span class="linenos">687</span></a>        <span class="c1"># or alt.X(‘column’, type=‘quantitative’)).</span>
</span><span id="Story-688"><a href="#Story-688"><span class="linenos">688</span></a>
</span><span id="Story-689"><a href="#Story-689"><span class="linenos">689</span></a>
</span><span id="Story-690"><a href="#Story-690"><span class="linenos">690</span></a>        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self to allow method chaining</span>
</span><span id="Story-691"><a href="#Story-691"><span class="linenos">691</span></a>
</span><span id="Story-692"><a href="#Story-692"><span class="linenos">692</span></a>    <span class="k">def</span> <span class="nf">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">em</span><span class="p">):</span>
</span><span id="Story-693"><a href="#Story-693"><span class="linenos">693</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-694"><a href="#Story-694"><span class="linenos">694</span></a><span class="sd">        Converts a dimension from em to pixels.</span>
</span><span id="Story-695"><a href="#Story-695"><span class="linenos">695</span></a>
</span><span id="Story-696"><a href="#Story-696"><span class="linenos">696</span></a><span class="sd">        This function is essential for maintaining visual consistency</span>
</span><span id="Story-697"><a href="#Story-697"><span class="linenos">697</span></a><span class="sd">        between different textual elements and devices.</span>
</span><span id="Story-698"><a href="#Story-698"><span class="linenos">698</span></a>
</span><span id="Story-699"><a href="#Story-699"><span class="linenos">699</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-700"><a href="#Story-700"><span class="linenos">700</span></a><span class="sd">        - em: Size in em</span>
</span><span id="Story-701"><a href="#Story-701"><span class="linenos">701</span></a>
</span><span id="Story-702"><a href="#Story-702"><span class="linenos">702</span></a><span class="sd">        Returns:</span>
</span><span id="Story-703"><a href="#Story-703"><span class="linenos">703</span></a><span class="sd">        - Equivalent size in pixels (integer)</span>
</span><span id="Story-704"><a href="#Story-704"><span class="linenos">704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-705"><a href="#Story-705"><span class="linenos">705</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">em</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span><span class="p">)</span>
</span><span id="Story-706"><a href="#Story-706"><span class="linenos">706</span></a>
</span><span id="Story-707"><a href="#Story-707"><span class="linenos">707</span></a>    <span class="k">def</span> <span class="nf">_get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">is_source</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Story-708"><a href="#Story-708"><span class="linenos">708</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-709"><a href="#Story-709"><span class="linenos">709</span></a><span class="sd">        Calculates the x and y co-ordinates for positioning text elements in the graph.</span>
</span><span id="Story-710"><a href="#Story-710"><span class="linenos">710</span></a>
</span><span id="Story-711"><a href="#Story-711"><span class="linenos">711</span></a><span class="sd">        This method is crucial for the correct positioning of various elements</span>
</span><span id="Story-712"><a href="#Story-712"><span class="linenos">712</span></a><span class="sd">        narrative elements such as context, call-to-action and sources.</span>
</span><span id="Story-713"><a href="#Story-713"><span class="linenos">713</span></a>
</span><span id="Story-714"><a href="#Story-714"><span class="linenos">714</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-715"><a href="#Story-715"><span class="linenos">715</span></a><span class="sd">        - position: String indicating the desired position (e.g. ‘left’, ‘right’, ‘top’, etc.).</span>
</span><span id="Story-716"><a href="#Story-716"><span class="linenos">716</span></a><span class="sd">        - is_source: Flag for special handling of the source position (not currently used)</span>
</span><span id="Story-717"><a href="#Story-717"><span class="linenos">717</span></a>
</span><span id="Story-718"><a href="#Story-718"><span class="linenos">718</span></a><span class="sd">        Returns:</span>
</span><span id="Story-719"><a href="#Story-719"><span class="linenos">719</span></a><span class="sd">        - Tuple (x, y) representing the coordinates in pixels</span>
</span><span id="Story-720"><a href="#Story-720"><span class="linenos">720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-721"><a href="#Story-721"><span class="linenos">721</span></a>        <span class="c1"># Dictionary mapping positions to coordinates (x, y)</span>
</span><span id="Story-722"><a href="#Story-722"><span class="linenos">722</span></a>        <span class="c1"># Co-ordinates are calculated from the size of the graph</span>
</span><span id="Story-723"><a href="#Story-723"><span class="linenos">723</span></a>        <span class="n">positions</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story-724"><a href="#Story-724"><span class="linenos">724</span></a>            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixel from the left edge, centred vertically</span>
</span><span id="Story-725"><a href="#Story-725"><span class="linenos">725</span></a>            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixel from the right edge, centred vertically</span>
</span><span id="Story-726"><a href="#Story-726"><span class="linenos">726</span></a>            <span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>  <span class="c1"># Centred horizontally, 80 pixels from above</span>
</span><span id="Story-727"><a href="#Story-727"><span class="linenos">727</span></a>            <span class="s1">&#39;bottom&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">10</span><span class="p">),</span>  <span class="c1"># Horizontally centred, 10 pixels from bottom</span>
</span><span id="Story-728"><a href="#Story-728"><span class="linenos">728</span></a>            <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Graph Centre</span>
</span><span id="Story-729"><a href="#Story-729"><span class="linenos">729</span></a>            <span class="s1">&#39;side-left&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixels to the left of the border, centred vertically</span>
</span><span id="Story-730"><a href="#Story-730"><span class="linenos">730</span></a>            <span class="s1">&#39;side-right&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># 10 pixels to the right of the border, centred vertically</span>
</span><span id="Story-731"><a href="#Story-731"><span class="linenos">731</span></a>        <span class="p">}</span>
</span><span id="Story-732"><a href="#Story-732"><span class="linenos">732</span></a>        
</span><span id="Story-733"><a href="#Story-733"><span class="linenos">733</span></a>        <span class="c1"># If the required position is not in the dictionary, use a default position</span>
</span><span id="Story-734"><a href="#Story-734"><span class="linenos">734</span></a>        <span class="c1"># In this case, horizontally centred and 20 pixels from the bottom</span>
</span><span id="Story-735"><a href="#Story-735"><span class="linenos">735</span></a>        <span class="k">return</span> <span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span>
</span><span id="Story-736"><a href="#Story-736"><span class="linenos">736</span></a>
</span><span id="Story-737"><a href="#Story-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">create_title_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="Story-738"><a href="#Story-738"><span class="linenos">738</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-739"><a href="#Story-739"><span class="linenos">739</span></a><span class="sd">        Creates the title layer (and subtitle if present).</span>
</span><span id="Story-740"><a href="#Story-740"><span class="linenos">740</span></a>
</span><span id="Story-741"><a href="#Story-741"><span class="linenos">741</span></a><span class="sd">        This method is responsible for visually creating the main title</span>
</span><span id="Story-742"><a href="#Story-742"><span class="linenos">742</span></a><span class="sd">        and the optional subtitle of the graphic.</span>
</span><span id="Story-743"><a href="#Story-743"><span class="linenos">743</span></a>
</span><span id="Story-744"><a href="#Story-744"><span class="linenos">744</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-745"><a href="#Story-745"><span class="linenos">745</span></a><span class="sd">        - Layer: Dictionary containing the title information</span>
</span><span id="Story-746"><a href="#Story-746"><span class="linenos">746</span></a>
</span><span id="Story-747"><a href="#Story-747"><span class="linenos">747</span></a><span class="sd">        Returns:</span>
</span><span id="Story-748"><a href="#Story-748"><span class="linenos">748</span></a><span class="sd">        - Altair Chart object representing the title layer</span>
</span><span id="Story-749"><a href="#Story-749"><span class="linenos">749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-750"><a href="#Story-750"><span class="linenos">750</span></a>        <span class="n">title_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-751"><a href="#Story-751"><span class="linenos">751</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="Story-752"><a href="#Story-752"><span class="linenos">752</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
</span><span id="Story-753"><a href="#Story-753"><span class="linenos">753</span></a>            <span class="n">fontWeight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
</span><span id="Story-754"><a href="#Story-754"><span class="linenos">754</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story-755"><a href="#Story-755"><span class="linenos">755</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story-756"><a href="#Story-756"><span class="linenos">756</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title_color&#39;</span><span class="p">]</span>
</span><span id="Story-757"><a href="#Story-757"><span class="linenos">757</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-758"><a href="#Story-758"><span class="linenos">758</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="Story-759"><a href="#Story-759"><span class="linenos">759</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Position 20 pixels from above</span>
</span><span id="Story-760"><a href="#Story-760"><span class="linenos">760</span></a>        <span class="p">)</span>
</span><span id="Story-761"><a href="#Story-761"><span class="linenos">761</span></a>        
</span><span id="Story-762"><a href="#Story-762"><span class="linenos">762</span></a>        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]:</span>
</span><span id="Story-763"><a href="#Story-763"><span class="linenos">763</span></a>            <span class="n">subtitle_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-764"><a href="#Story-764"><span class="linenos">764</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">],</span>
</span><span id="Story-765"><a href="#Story-765"><span class="linenos">765</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]),</span>
</span><span id="Story-766"><a href="#Story-766"><span class="linenos">766</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story-767"><a href="#Story-767"><span class="linenos">767</span></a>                <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story-768"><a href="#Story-768"><span class="linenos">768</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle_color&#39;</span><span class="p">]</span>
</span><span id="Story-769"><a href="#Story-769"><span class="linenos">769</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-770"><a href="#Story-770"><span class="linenos">770</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="Story-771"><a href="#Story-771"><span class="linenos">771</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Position 50 pixels from the top (below the title)</span>
</span><span id="Story-772"><a href="#Story-772"><span class="linenos">772</span></a>            <span class="p">)</span>
</span><span id="Story-773"><a href="#Story-773"><span class="linenos">773</span></a>            <span class="k">return</span> <span class="n">title_chart</span> <span class="o">+</span> <span class="n">subtitle_chart</span>
</span><span id="Story-774"><a href="#Story-774"><span class="linenos">774</span></a>        <span class="k">return</span> <span class="n">title_chart</span>
</span><span id="Story-775"><a href="#Story-775"><span class="linenos">775</span></a>
</span><span id="Story-776"><a href="#Story-776"><span class="linenos">776</span></a>    <span class="k">def</span> <span class="nf">create_text_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="Story-777"><a href="#Story-777"><span class="linenos">777</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-778"><a href="#Story-778"><span class="linenos">778</span></a><span class="sd">        Creates a generic text layer (context, call-to-action, source).</span>
</span><span id="Story-779"><a href="#Story-779"><span class="linenos">779</span></a>
</span><span id="Story-780"><a href="#Story-780"><span class="linenos">780</span></a><span class="sd">        This method is used to create text layers for various narrative purposes,</span>
</span><span id="Story-781"><a href="#Story-781"><span class="linenos">781</span></a><span class="sd">        such as adding context, call-to-action or data source information.</span>
</span><span id="Story-782"><a href="#Story-782"><span class="linenos">782</span></a>
</span><span id="Story-783"><a href="#Story-783"><span class="linenos">783</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-784"><a href="#Story-784"><span class="linenos">784</span></a><span class="sd">        - Layer: Dictionary containing the text information to be added</span>
</span><span id="Story-785"><a href="#Story-785"><span class="linenos">785</span></a>
</span><span id="Story-786"><a href="#Story-786"><span class="linenos">786</span></a><span class="sd">        Returns:</span>
</span><span id="Story-787"><a href="#Story-787"><span class="linenos">787</span></a><span class="sd">        - Altair Chart object representing the text layer</span>
</span><span id="Story-788"><a href="#Story-788"><span class="linenos">788</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-789"><a href="#Story-789"><span class="linenos">789</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span>
</span><span id="Story-790"><a href="#Story-790"><span class="linenos">790</span></a>        <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story-791"><a href="#Story-791"><span class="linenos">791</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>
</span><span id="Story-792"><a href="#Story-792"><span class="linenos">792</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]),</span>
</span><span id="Story-793"><a href="#Story-793"><span class="linenos">793</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story-794"><a href="#Story-794"><span class="linenos">794</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="Story-795"><a href="#Story-795"><span class="linenos">795</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story-796"><a href="#Story-796"><span class="linenos">796</span></a>            <span class="n">angle</span><span class="o">=</span><span class="mi">270</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">#  Rotate text if ‘vertical’ is True</span>
</span><span id="Story-797"><a href="#Story-797"><span class="linenos">797</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span id="Story-798"><a href="#Story-798"><span class="linenos">798</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story-799"><a href="#Story-799"><span class="linenos">799</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
</span><span id="Story-800"><a href="#Story-800"><span class="linenos">800</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Story-801"><a href="#Story-801"><span class="linenos">801</span></a>        <span class="p">)</span>
</span><span id="Story-802"><a href="#Story-802"><span class="linenos">802</span></a>
</span><span id="Story-803"><a href="#Story-803"><span class="linenos">803</span></a>    <span class="k">def</span> <span class="nf">configure_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story-804"><a href="#Story-804"><span class="linenos">804</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-805"><a href="#Story-805"><span class="linenos">805</span></a><span class="sd">        Configure aspects of the graph view using Altair&#39;s configure_view method.</span>
</span><span id="Story-806"><a href="#Story-806"><span class="linenos">806</span></a>
</span><span id="Story-807"><a href="#Story-807"><span class="linenos">807</span></a><span class="sd">        This method allows you to configure various aspects of the chart view, such as</span>
</span><span id="Story-808"><a href="#Story-808"><span class="linenos">808</span></a><span class="sd">        the background colour, border style, internal spacing, etc.</span>
</span><span id="Story-809"><a href="#Story-809"><span class="linenos">809</span></a>
</span><span id="Story-810"><a href="#Story-810"><span class="linenos">810</span></a><span class="sd">        Parameters:</span>
</span><span id="Story-811"><a href="#Story-811"><span class="linenos">811</span></a><span class="sd">        *args, **kwargs: Arguments to pass to the Altair configure_view method.</span>
</span><span id="Story-812"><a href="#Story-812"><span class="linenos">812</span></a>
</span><span id="Story-813"><a href="#Story-813"><span class="linenos">813</span></a><span class="sd">        stores the view configuration for application during rendering.</span>
</span><span id="Story-814"><a href="#Story-814"><span class="linenos">814</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-815"><a href="#Story-815"><span class="linenos">815</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="Story-816"><a href="#Story-816"><span class="linenos">816</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story-817"><a href="#Story-817"><span class="linenos">817</span></a>
</span><span id="Story-818"><a href="#Story-818"><span class="linenos">818</span></a>
</span><span id="Story-819"><a href="#Story-819"><span class="linenos">819</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Story-820"><a href="#Story-820"><span class="linenos">820</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story-821"><a href="#Story-821"><span class="linenos">821</span></a><span class="sd">        It renders all layers of the story in a single graphic.       </span>
</span><span id="Story-822"><a href="#Story-822"><span class="linenos">822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story-823"><a href="#Story-823"><span class="linenos">823</span></a>        <span class="c1"># Let&#39;s start with the basic graph</span>
</span><span id="Story-824"><a href="#Story-824"><span class="linenos">824</span></a>        <span class="n">main_chart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span>
</span><span id="Story-825"><a href="#Story-825"><span class="linenos">825</span></a>        
</span><span id="Story-826"><a href="#Story-826"><span class="linenos">826</span></a>        <span class="c1"># We create separate lists to place special graphics</span>
</span><span id="Story-827"><a href="#Story-827"><span class="linenos">827</span></a>        <span class="n">top_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-828"><a href="#Story-828"><span class="linenos">828</span></a>        <span class="n">bottom_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-829"><a href="#Story-829"><span class="linenos">829</span></a>        <span class="n">left_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-830"><a href="#Story-830"><span class="linenos">830</span></a>        <span class="n">right_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-831"><a href="#Story-831"><span class="linenos">831</span></a>        <span class="n">overlay_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story-832"><a href="#Story-832"><span class="linenos">832</span></a>        
</span><span id="Story-833"><a href="#Story-833"><span class="linenos">833</span></a>        <span class="c1"># We organise the layers according to their position</span>
</span><span id="Story-834"><a href="#Story-834"><span class="linenos">834</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="p">:</span>
</span><span id="Story-835"><a href="#Story-835"><span class="linenos">835</span></a>            <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">:</span>
</span><span id="Story-836"><a href="#Story-836"><span class="linenos">836</span></a>                <span class="c1"># We take the position from the layer</span>
</span><span id="Story-837"><a href="#Story-837"><span class="linenos">837</span></a>                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
</span><span id="Story-838"><a href="#Story-838"><span class="linenos">838</span></a>                    <span class="n">top_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story-839"><a href="#Story-839"><span class="linenos">839</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
</span><span id="Story-840"><a href="#Story-840"><span class="linenos">840</span></a>                    <span class="n">bottom_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story-841"><a href="#Story-841"><span class="linenos">841</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="Story-842"><a href="#Story-842"><span class="linenos">842</span></a>                    <span class="n">left_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story-843"><a href="#Story-843"><span class="linenos">843</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="Story-844"><a href="#Story-844"><span class="linenos">844</span></a>                    <span class="n">right_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story-845"><a href="#Story-845"><span class="linenos">845</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span>
</span><span id="Story-846"><a href="#Story-846"><span class="linenos">846</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_title_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="Story-847"><a href="#Story-847"><span class="linenos">847</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">]:</span>
</span><span id="Story-848"><a href="#Story-848"><span class="linenos">848</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_text_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="Story-849"><a href="#Story-849"><span class="linenos">849</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;shape_label&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">]:</span>
</span><span id="Story-850"><a href="#Story-850"><span class="linenos">850</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story-851"><a href="#Story-851"><span class="linenos">851</span></a>
</span><span id="Story-852"><a href="#Story-852"><span class="linenos">852</span></a>        <span class="c1"># Overlaying the layers on the main graph</span>
</span><span id="Story-853"><a href="#Story-853"><span class="linenos">853</span></a>        <span class="k">for</span> <span class="n">overlay</span> <span class="ow">in</span> <span class="n">overlay_charts</span><span class="p">:</span>
</span><span id="Story-854"><a href="#Story-854"><span class="linenos">854</span></a>            <span class="n">main_chart</span> <span class="o">+=</span> <span class="n">overlay</span>
</span><span id="Story-855"><a href="#Story-855"><span class="linenos">855</span></a>
</span><span id="Story-856"><a href="#Story-856"><span class="linenos">856</span></a>        <span class="c1"># We build the final layout</span>
</span><span id="Story-857"><a href="#Story-857"><span class="linenos">857</span></a>        <span class="k">if</span> <span class="n">left_charts</span><span class="p">:</span>
</span><span id="Story-858"><a href="#Story-858"><span class="linenos">858</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">left_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="Story-859"><a href="#Story-859"><span class="linenos">859</span></a>        <span class="k">if</span> <span class="n">right_charts</span><span class="p">:</span>
</span><span id="Story-860"><a href="#Story-860"><span class="linenos">860</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">right_charts</span><span class="p">))</span>
</span><span id="Story-861"><a href="#Story-861"><span class="linenos">861</span></a>        <span class="k">if</span> <span class="n">top_charts</span><span class="p">:</span>
</span><span id="Story-862"><a href="#Story-862"><span class="linenos">862</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">top_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="Story-863"><a href="#Story-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="n">bottom_charts</span><span class="p">:</span>
</span><span id="Story-864"><a href="#Story-864"><span class="linenos">864</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">bottom_charts</span><span class="p">))</span>
</span><span id="Story-865"><a href="#Story-865"><span class="linenos">865</span></a>
</span><span id="Story-866"><a href="#Story-866"><span class="linenos">866</span></a>        <span class="c1"># Apply configurations</span>
</span><span id="Story-867"><a href="#Story-867"><span class="linenos">867</span></a>        <span class="k">if</span> <span class="s1">&#39;view&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Story-868"><a href="#Story-868"><span class="linenos">868</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">main_chart</span><span class="o">.</span><span class="n">configure_view</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">])</span>
</span><span id="Story-869"><a href="#Story-869"><span class="linenos">869</span></a>
</span><span id="Story-870"><a href="#Story-870"><span class="linenos">870</span></a>        <span class="k">return</span> <span class="n">main_chart</span>
</span></pre></div>


            <div class="docstring"><p>Story class: Implements a structure for creating narrative views of data.</p>

<p>This class extends the functionality of Altair to include narrative elements
such as titles, contexts, call-to-action and annotations. It is designed to facilitate
the creation of more engaging and informative data visualisations.</p>
</div>


                            <div id="Story.__init__" class="classattr">
                                        <input id="Story.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Story</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">width</span><span class="o">=</span><span class="mi">600</span>,</span><span class="param">	<span class="n">height</span><span class="o">=</span><span class="mi">400</span>,</span><span class="param">	<span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span>,</span><span class="param">	<span class="n">base_font_size</span><span class="o">=</span><span class="mi">16</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Story.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.__init__-14"><a href="#Story.__init__-14"><span class="linenos">14</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">base_font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story.__init__-15"><a href="#Story.__init__-15"><span class="linenos">15</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.__init__-16"><a href="#Story.__init__-16"><span class="linenos">16</span></a><span class="sd">        Initialise a Story object.</span>
</span><span id="Story.__init__-17"><a href="#Story.__init__-17"><span class="linenos">17</span></a>
</span><span id="Story.__init__-18"><a href="#Story.__init__-18"><span class="linenos">18</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.__init__-19"><a href="#Story.__init__-19"><span class="linenos">19</span></a><span class="sd">        - data: DataFrame or URL for graph data  (default: None)</span>
</span><span id="Story.__init__-20"><a href="#Story.__init__-20"><span class="linenos">20</span></a><span class="sd">        - width: Graph width in pixels (default: 600)</span>
</span><span id="Story.__init__-21"><a href="#Story.__init__-21"><span class="linenos">21</span></a><span class="sd">        - height: Height of the graph in pixels (default: 400)</span>
</span><span id="Story.__init__-22"><a href="#Story.__init__-22"><span class="linenos">22</span></a><span class="sd">        - font: Font to be used for all text elements (default: &#39;Arial&#39;)</span>
</span><span id="Story.__init__-23"><a href="#Story.__init__-23"><span class="linenos">23</span></a><span class="sd">        - base_font_size: Basic font size in pixels (default: 16)</span>
</span><span id="Story.__init__-24"><a href="#Story.__init__-24"><span class="linenos">24</span></a><span class="sd">        - **kwargs: Additional parameters to be passed to the constructor of alt.Chart</span>
</span><span id="Story.__init__-25"><a href="#Story.__init__-25"><span class="linenos">25</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.__init__-26"><a href="#Story.__init__-26"><span class="linenos">26</span></a>        <span class="c1"># Initialising the Altair Chart object with basic parameters</span>
</span><span id="Story.__init__-27"><a href="#Story.__init__-27"><span class="linenos">27</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Story.__init__-28"><a href="#Story.__init__-28"><span class="linenos">28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">font</span>
</span><span id="Story.__init__-29"><a href="#Story.__init__-29"><span class="linenos">29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span> <span class="o">=</span> <span class="n">base_font_size</span>
</span><span id="Story.__init__-30"><a href="#Story.__init__-30"><span class="linenos">30</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List for storing history layers</span>
</span><span id="Story.__init__-31"><a href="#Story.__init__-31"><span class="linenos">31</span></a>        
</span><span id="Story.__init__-32"><a href="#Story.__init__-32"><span class="linenos">32</span></a>        <span class="c1"># Dictionaries for the sizes and colours of various text elements</span>
</span><span id="Story.__init__-33"><a href="#Story.__init__-33"><span class="linenos">33</span></a>        <span class="c1"># These values are multipliers for base_font_size</span>
</span><span id="Story.__init__-34"><a href="#Story.__init__-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story.__init__-35"><a href="#Story.__init__-35"><span class="linenos">35</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>        <span class="c1"># The title will be twice as big as the basic font</span>
</span><span id="Story.__init__-36"><a href="#Story.__init__-36"><span class="linenos">36</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>   <span class="c1"># The subtitle will be 1.5 times bigger</span>
</span><span id="Story.__init__-37"><a href="#Story.__init__-37"><span class="linenos">37</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>    <span class="c1"># The context text will be 1.2 times larger</span>
</span><span id="Story.__init__-38"><a href="#Story.__init__-38"><span class="linenos">38</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>        <span class="c1"># Call-to-action text will be 1.3 times larger</span>
</span><span id="Story.__init__-39"><a href="#Story.__init__-39"><span class="linenos">39</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="mi">1</span>        <span class="c1"># The source text will have the basic size</span>
</span><span id="Story.__init__-40"><a href="#Story.__init__-40"><span class="linenos">40</span></a>        <span class="p">}</span>
</span><span id="Story.__init__-41"><a href="#Story.__init__-41"><span class="linenos">41</span></a>        <span class="c1"># Predefined colours for various text elements</span>
</span><span id="Story.__init__-42"><a href="#Story.__init__-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story.__init__-43"><a href="#Story.__init__-43"><span class="linenos">43</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.__init__-44"><a href="#Story.__init__-44"><span class="linenos">44</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
</span><span id="Story.__init__-45"><a href="#Story.__init__-45"><span class="linenos">45</span></a>            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.__init__-46"><a href="#Story.__init__-46"><span class="linenos">46</span></a>            <span class="s1">&#39;cta&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
</span><span id="Story.__init__-47"><a href="#Story.__init__-47"><span class="linenos">47</span></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span>
</span><span id="Story.__init__-48"><a href="#Story.__init__-48"><span class="linenos">48</span></a>        <span class="p">}</span>
</span><span id="Story.__init__-49"><a href="#Story.__init__-49"><span class="linenos">49</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
</span></pre></div>


            <div class="docstring"><p>Initialise a Story object.</p>

<p>Parameters:</p>

<ul>
<li>data: DataFrame or URL for graph data  (default: None)</li>
<li>width: Graph width in pixels (default: 600)</li>
<li>height: Height of the graph in pixels (default: 400)</li>
<li>font: Font to be used for all text elements (default: 'Arial')</li>
<li>base_font_size: Basic font size in pixels (default: 16)</li>
<li>**kwargs: Additional parameters to be passed to the constructor of alt.Chart</li>
</ul>
</div>


                            </div>
                            <div id="Story.chart" class="classattr">
                                <div class="attr variable">
            <span class="name">chart</span>

        
    </div>
    <a class="headerlink" href="#Story.chart"></a>
    
    

                            </div>
                            <div id="Story.font" class="classattr">
                                <div class="attr variable">
            <span class="name">font</span>

        
    </div>
    <a class="headerlink" href="#Story.font"></a>
    
    

                            </div>
                            <div id="Story.base_font_size" class="classattr">
                                <div class="attr variable">
            <span class="name">base_font_size</span>

        
    </div>
    <a class="headerlink" href="#Story.base_font_size"></a>
    
    

                            </div>
                            <div id="Story.story_layers" class="classattr">
                                <div class="attr variable">
            <span class="name">story_layers</span>

        
    </div>
    <a class="headerlink" href="#Story.story_layers"></a>
    
    

                            </div>
                            <div id="Story.font_sizes" class="classattr">
                                <div class="attr variable">
            <span class="name">font_sizes</span>

        
    </div>
    <a class="headerlink" href="#Story.font_sizes"></a>
    
    

                            </div>
                            <div id="Story.colors" class="classattr">
                                <div class="attr variable">
            <span class="name">colors</span>

        
    </div>
    <a class="headerlink" href="#Story.colors"></a>
    
    

                            </div>
                            <div id="Story.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#Story.config"></a>
    
    

                            </div>
                            <div id="Story.add_title" class="classattr">
                                        <input id="Story.add_title-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_title</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">title</span>, </span><span class="param"><span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">title_color</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">subtitle_color</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.add_title-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.add_title"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.add_title-91"><a href="#Story.add_title-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">add_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtitle_color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Story.add_title-92"><a href="#Story.add_title-92"><span class="linenos"> 92</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_title-93"><a href="#Story.add_title-93"><span class="linenos"> 93</span></a><span class="sd">        Adds a title layer (and optional subtitle) to the story.</span>
</span><span id="Story.add_title-94"><a href="#Story.add_title-94"><span class="linenos"> 94</span></a>
</span><span id="Story.add_title-95"><a href="#Story.add_title-95"><span class="linenos"> 95</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.add_title-96"><a href="#Story.add_title-96"><span class="linenos"> 96</span></a><span class="sd">        - title: Main title text</span>
</span><span id="Story.add_title-97"><a href="#Story.add_title-97"><span class="linenos"> 97</span></a><span class="sd">        - subtitle: Subtitle text (optional)</span>
</span><span id="Story.add_title-98"><a href="#Story.add_title-98"><span class="linenos"> 98</span></a><span class="sd">        - title_color: Custom colour for the title (optional)</span>
</span><span id="Story.add_title-99"><a href="#Story.add_title-99"><span class="linenos"> 99</span></a><span class="sd">        - subtitle_color: Custom colour for the subtitle (optional)</span>
</span><span id="Story.add_title-100"><a href="#Story.add_title-100"><span class="linenos">100</span></a>
</span><span id="Story.add_title-101"><a href="#Story.add_title-101"><span class="linenos">101</span></a><span class="sd">        returns:</span>
</span><span id="Story.add_title-102"><a href="#Story.add_title-102"><span class="linenos">102</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story.add_title-103"><a href="#Story.add_title-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.add_title-104"><a href="#Story.add_title-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_title-105"><a href="#Story.add_title-105"><span class="linenos">105</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> 
</span><span id="Story.add_title-106"><a href="#Story.add_title-106"><span class="linenos">106</span></a>            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> 
</span><span id="Story.add_title-107"><a href="#Story.add_title-107"><span class="linenos">107</span></a>            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="n">subtitle</span><span class="p">,</span>
</span><span id="Story.add_title-108"><a href="#Story.add_title-108"><span class="linenos">108</span></a>            <span class="s1">&#39;title_color&#39;</span><span class="p">:</span> <span class="n">title_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="Story.add_title-109"><a href="#Story.add_title-109"><span class="linenos">109</span></a>            <span class="s1">&#39;subtitle_color&#39;</span><span class="p">:</span> <span class="n">subtitle_color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
</span><span id="Story.add_title-110"><a href="#Story.add_title-110"><span class="linenos">110</span></a>        <span class="p">})</span>
</span><span id="Story.add_title-111"><a href="#Story.add_title-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Adds a title layer (and optional subtitle) to the story.</p>

<p>Parameters:</p>

<ul>
<li>title: Main title text</li>
<li>subtitle: Subtitle text (optional)</li>
<li>title_color: Custom colour for the title (optional)</li>
<li>subtitle_color: Custom colour for the subtitle (optional)</li>
</ul>

<p>returns:</p>

<ul>
<li>self, to allow method chaining</li>
</ul>
</div>


                            </div>
                            <div id="Story.add_context" class="classattr">
                                        <input id="Story.add_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">text</span>, </span><span class="param"><span class="n">position</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>, </span><span class="param"><span class="n">color</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.add_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.add_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.add_context-113"><a href="#Story.add_context-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">add_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Story.add_context-114"><a href="#Story.add_context-114"><span class="linenos">114</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_context-115"><a href="#Story.add_context-115"><span class="linenos">115</span></a><span class="sd">        Adds a context layer to the story.</span>
</span><span id="Story.add_context-116"><a href="#Story.add_context-116"><span class="linenos">116</span></a>
</span><span id="Story.add_context-117"><a href="#Story.add_context-117"><span class="linenos">117</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.add_context-118"><a href="#Story.add_context-118"><span class="linenos">118</span></a><span class="sd">        - text: The context text to be added</span>
</span><span id="Story.add_context-119"><a href="#Story.add_context-119"><span class="linenos">119</span></a><span class="sd">        - position: The position of the text (default: ‘left’)</span>
</span><span id="Story.add_context-120"><a href="#Story.add_context-120"><span class="linenos">120</span></a><span class="sd">        - colour: Custom text colour (optional)</span>
</span><span id="Story.add_context-121"><a href="#Story.add_context-121"><span class="linenos">121</span></a>
</span><span id="Story.add_context-122"><a href="#Story.add_context-122"><span class="linenos">122</span></a><span class="sd">        returns:</span>
</span><span id="Story.add_context-123"><a href="#Story.add_context-123"><span class="linenos">123</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story.add_context-124"><a href="#Story.add_context-124"><span class="linenos">124</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.add_context-125"><a href="#Story.add_context-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_context-126"><a href="#Story.add_context-126"><span class="linenos">126</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> 
</span><span id="Story.add_context-127"><a href="#Story.add_context-127"><span class="linenos">127</span></a>            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="Story.add_context-128"><a href="#Story.add_context-128"><span class="linenos">128</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="Story.add_context-129"><a href="#Story.add_context-129"><span class="linenos">129</span></a>            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span>
</span><span id="Story.add_context-130"><a href="#Story.add_context-130"><span class="linenos">130</span></a>        <span class="p">})</span>
</span><span id="Story.add_context-131"><a href="#Story.add_context-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Adds a context layer to the story.</p>

<p>Parameters:</p>

<ul>
<li>text: The context text to be added</li>
<li>position: The position of the text (default: ‘left’)</li>
<li>colour: Custom text colour (optional)</li>
</ul>

<p>returns:</p>

<ul>
<li>self, to allow method chaining</li>
</ul>
</div>


                            </div>
                            <div id="Story.add_next_step" class="classattr">
                                        <input id="Story.add_next_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_next_step</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">text</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span>,</span><span class="param">	<span class="nb">type</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">title</span><span class="o">=</span><span class="s1">&#39;What can we do next?&#39;</span>,</span><span class="param">	<span class="n">vers</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">button</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">line</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stairs</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">color</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span>,</span><span class="param">	<span class="n">font_size</span><span class="o">=</span><span class="mi">14</span>,</span><span class="param">	<span class="n">texts</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">url</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">button_width</span><span class="o">=</span><span class="mi">120</span>,</span><span class="param">	<span class="n">button_height</span><span class="o">=</span><span class="mi">40</span>,</span><span class="param">	<span class="n">button_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span>,</span><span class="param">	<span class="n">button_opacity</span><span class="o">=</span><span class="mf">0.2</span>,</span><span class="param">	<span class="n">button_corner_radius</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">button_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">button_font_family</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">button_font_size</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">line_steps_rect_width</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">line_steps_rect_height</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">line_steps_space</span><span class="o">=</span><span class="mi">5</span>,</span><span class="param">	<span class="n">line_steps_chart_width</span><span class="o">=</span><span class="mi">700</span>,</span><span class="param">	<span class="n">line_steps_chart_height</span><span class="o">=</span><span class="mi">100</span>,</span><span class="param">	<span class="n">line_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span>,</span><span class="param">	<span class="n">line_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span>,</span><span class="param">	<span class="n">line_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">line_steps_font_family</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">line_steps_font_size</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stair_steps_rect_width</span><span class="o">=</span><span class="mi">10</span>,</span><span class="param">	<span class="n">stair_steps_rect_height</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">stair_steps_chart_width</span><span class="o">=</span><span class="mi">700</span>,</span><span class="param">	<span class="n">stair_steps_chart_height</span><span class="o">=</span><span class="mi">300</span>,</span><span class="param">	<span class="n">stair_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span>,</span><span class="param">	<span class="n">stair_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span>,</span><span class="param">	<span class="n">stair_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">stair_steps_font_family</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">stair_steps_font_size</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">title_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">title_font_family</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">title_font_size</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.add_next_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.add_next_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.add_next_step-134"><a href="#Story.add_next_step-134"><span class="linenos">134</span></a>    <span class="k">def</span> <span class="nf">add_next_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="Story.add_next_step-135"><a href="#Story.add_next_step-135"><span class="linenos">135</span></a>        <span class="c1">#Basic parameters</span>
</span><span id="Story.add_next_step-136"><a href="#Story.add_next_step-136"><span class="linenos">136</span></a>        <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-137"><a href="#Story.add_next_step-137"><span class="linenos">137</span></a>        <span class="n">position</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-138"><a href="#Story.add_next_step-138"><span class="linenos">138</span></a>        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-139"><a href="#Story.add_next_step-139"><span class="linenos">139</span></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;What can we do next?&quot;</span><span class="p">,</span>
</span><span id="Story.add_next_step-140"><a href="#Story.add_next_step-140"><span class="linenos">140</span></a>        
</span><span id="Story.add_next_step-141"><a href="#Story.add_next_step-141"><span class="linenos">141</span></a>        <span class="c1"># Parameters for NextStep </span>
</span><span id="Story.add_next_step-142"><a href="#Story.add_next_step-142"><span class="linenos">142</span></a>        <span class="n">vers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-143"><a href="#Story.add_next_step-143"><span class="linenos">143</span></a>        <span class="n">button</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-144"><a href="#Story.add_next_step-144"><span class="linenos">144</span></a>        <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-145"><a href="#Story.add_next_step-145"><span class="linenos">145</span></a>        <span class="n">stairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       
</span><span id="Story.add_next_step-146"><a href="#Story.add_next_step-146"><span class="linenos">146</span></a>        
</span><span id="Story.add_next_step-147"><a href="#Story.add_next_step-147"><span class="linenos">147</span></a>        <span class="c1"># General parameters for text (used as fallback)</span>
</span><span id="Story.add_next_step-148"><a href="#Story.add_next_step-148"><span class="linenos">148</span></a>        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-149"><a href="#Story.add_next_step-149"><span class="linenos">149</span></a>        <span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-150"><a href="#Story.add_next_step-150"><span class="linenos">150</span></a>        <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
</span><span id="Story.add_next_step-151"><a href="#Story.add_next_step-151"><span class="linenos">151</span></a>        
</span><span id="Story.add_next_step-152"><a href="#Story.add_next_step-152"><span class="linenos">152</span></a>        <span class="c1"># List of texts for steps</span>
</span><span id="Story.add_next_step-153"><a href="#Story.add_next_step-153"><span class="linenos">153</span></a>        <span class="n">texts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-154"><a href="#Story.add_next_step-154"><span class="linenos">154</span></a>        
</span><span id="Story.add_next_step-155"><a href="#Story.add_next_step-155"><span class="linenos">155</span></a>        <span class="c1"># Parameters per button</span>
</span><span id="Story.add_next_step-156"><a href="#Story.add_next_step-156"><span class="linenos">156</span></a>        <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Story.add_next_step-157"><a href="#Story.add_next_step-157"><span class="linenos">157</span></a>        <span class="n">button_width</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
</span><span id="Story.add_next_step-158"><a href="#Story.add_next_step-158"><span class="linenos">158</span></a>        <span class="n">button_height</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="Story.add_next_step-159"><a href="#Story.add_next_step-159"><span class="linenos">159</span></a>        <span class="n">button_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-160"><a href="#Story.add_next_step-160"><span class="linenos">160</span></a>        <span class="n">button_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story.add_next_step-161"><a href="#Story.add_next_step-161"><span class="linenos">161</span></a>        <span class="n">button_corner_radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Story.add_next_step-162"><a href="#Story.add_next_step-162"><span class="linenos">162</span></a>        <span class="n">button_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-163"><a href="#Story.add_next_step-163"><span class="linenos">163</span></a>        <span class="n">button_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_family</span>
</span><span id="Story.add_next_step-164"><a href="#Story.add_next_step-164"><span class="linenos">164</span></a>        <span class="n">button_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># If None, use font_size</span>
</span><span id="Story.add_next_step-165"><a href="#Story.add_next_step-165"><span class="linenos">165</span></a>        
</span><span id="Story.add_next_step-166"><a href="#Story.add_next_step-166"><span class="linenos">166</span></a>        <span class="c1"># Parameters for line_steps</span>
</span><span id="Story.add_next_step-167"><a href="#Story.add_next_step-167"><span class="linenos">167</span></a>        <span class="n">line_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story.add_next_step-168"><a href="#Story.add_next_step-168"><span class="linenos">168</span></a>        <span class="n">line_steps_rect_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story.add_next_step-169"><a href="#Story.add_next_step-169"><span class="linenos">169</span></a>        <span class="n">line_steps_space</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="Story.add_next_step-170"><a href="#Story.add_next_step-170"><span class="linenos">170</span></a>        <span class="n">line_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="Story.add_next_step-171"><a href="#Story.add_next_step-171"><span class="linenos">171</span></a>        <span class="n">line_steps_chart_height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="Story.add_next_step-172"><a href="#Story.add_next_step-172"><span class="linenos">172</span></a>        <span class="n">line_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-173"><a href="#Story.add_next_step-173"><span class="linenos">173</span></a>        <span class="n">line_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story.add_next_step-174"><a href="#Story.add_next_step-174"><span class="linenos">174</span></a>        <span class="n">line_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-175"><a href="#Story.add_next_step-175"><span class="linenos">175</span></a>        <span class="n">line_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="Story.add_next_step-176"><a href="#Story.add_next_step-176"><span class="linenos">176</span></a>        <span class="n">line_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="Story.add_next_step-177"><a href="#Story.add_next_step-177"><span class="linenos">177</span></a>        
</span><span id="Story.add_next_step-178"><a href="#Story.add_next_step-178"><span class="linenos">178</span></a>        <span class="c1"># Parameters for stair_steps</span>
</span><span id="Story.add_next_step-179"><a href="#Story.add_next_step-179"><span class="linenos">179</span></a>        <span class="n">stair_steps_rect_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story.add_next_step-180"><a href="#Story.add_next_step-180"><span class="linenos">180</span></a>        <span class="n">stair_steps_rect_height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="Story.add_next_step-181"><a href="#Story.add_next_step-181"><span class="linenos">181</span></a>        <span class="n">stair_steps_chart_width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
</span><span id="Story.add_next_step-182"><a href="#Story.add_next_step-182"><span class="linenos">182</span></a>        <span class="n">stair_steps_chart_height</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
</span><span id="Story.add_next_step-183"><a href="#Story.add_next_step-183"><span class="linenos">183</span></a>        <span class="n">stair_steps_color</span><span class="o">=</span><span class="s1">&#39;#80C11E&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-184"><a href="#Story.add_next_step-184"><span class="linenos">184</span></a>        <span class="n">stair_steps_opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="Story.add_next_step-185"><a href="#Story.add_next_step-185"><span class="linenos">185</span></a>        <span class="n">stair_steps_text_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-186"><a href="#Story.add_next_step-186"><span class="linenos">186</span></a>        <span class="n">stair_steps_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If None, use font_family</span>
</span><span id="Story.add_next_step-187"><a href="#Story.add_next_step-187"><span class="linenos">187</span></a>        <span class="n">stair_steps_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># If None, use font_size</span>
</span><span id="Story.add_next_step-188"><a href="#Story.add_next_step-188"><span class="linenos">188</span></a>        
</span><span id="Story.add_next_step-189"><a href="#Story.add_next_step-189"><span class="linenos">189</span></a>        <span class="c1"># Title Parameters</span>
</span><span id="Story.add_next_step-190"><a href="#Story.add_next_step-190"><span class="linenos">190</span></a>        <span class="n">title_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-191"><a href="#Story.add_next_step-191"><span class="linenos">191</span></a>        <span class="n">title_font_family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>     <span class="c1"># If None, use font_family</span>
</span><span id="Story.add_next_step-192"><a href="#Story.add_next_step-192"><span class="linenos">192</span></a>        <span class="n">title_font_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       <span class="c1"># If None, use font_size * 1.4</span>
</span><span id="Story.add_next_step-193"><a href="#Story.add_next_step-193"><span class="linenos">193</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story.add_next_step-194"><a href="#Story.add_next_step-194"><span class="linenos">194</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_next_step-195"><a href="#Story.add_next_step-195"><span class="linenos">195</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="Story.add_next_step-196"><a href="#Story.add_next_step-196"><span class="linenos">196</span></a><span class="sd">        Supports the use of NextStep with any parameter name via kwargs.</span>
</span><span id="Story.add_next_step-197"><a href="#Story.add_next_step-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.add_next_step-198"><a href="#Story.add_next_step-198"><span class="linenos">198</span></a>        <span class="c1"># Local import of NextStep to avoid circular imports</span>
</span><span id="Story.add_next_step-199"><a href="#Story.add_next_step-199"><span class="linenos">199</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="Story.add_next_step-200"><a href="#Story.add_next_step-200"><span class="linenos">200</span></a>        
</span><span id="Story.add_next_step-201"><a href="#Story.add_next_step-201"><span class="linenos">201</span></a>        <span class="c1"># Search for an instance of NextStep in kwargs </span>
</span><span id="Story.add_next_step-202"><a href="#Story.add_next_step-202"><span class="linenos">202</span></a>        <span class="n">next_step_instance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Story.add_next_step-203"><a href="#Story.add_next_step-203"><span class="linenos">203</span></a>        <span class="k">for</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Story.add_next_step-204"><a href="#Story.add_next_step-204"><span class="linenos">204</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story.add_next_step-205"><a href="#Story.add_next_step-205"><span class="linenos">205</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param_value</span>
</span><span id="Story.add_next_step-206"><a href="#Story.add_next_step-206"><span class="linenos">206</span></a>                <span class="k">break</span>
</span><span id="Story.add_next_step-207"><a href="#Story.add_next_step-207"><span class="linenos">207</span></a>        
</span><span id="Story.add_next_step-208"><a href="#Story.add_next_step-208"><span class="linenos">208</span></a>        <span class="c1"># Also check the nominal legacy parameters</span>
</span><span id="Story.add_next_step-209"><a href="#Story.add_next_step-209"><span class="linenos">209</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vers</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">stairs</span><span class="p">]:</span>
</span><span id="Story.add_next_step-210"><a href="#Story.add_next_step-210"><span class="linenos">210</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story.add_next_step-211"><a href="#Story.add_next_step-211"><span class="linenos">211</span></a>                <span class="n">next_step_instance</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="Story.add_next_step-212"><a href="#Story.add_next_step-212"><span class="linenos">212</span></a>                <span class="k">break</span>
</span><span id="Story.add_next_step-213"><a href="#Story.add_next_step-213"><span class="linenos">213</span></a>        
</span><span id="Story.add_next_step-214"><a href="#Story.add_next_step-214"><span class="linenos">214</span></a>        <span class="c1"># If a NextStep has been found, use it</span>
</span><span id="Story.add_next_step-215"><a href="#Story.add_next_step-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">next_step_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-216"><a href="#Story.add_next_step-216"><span class="linenos">216</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">next_step_instance</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story.add_next_step-217"><a href="#Story.add_next_step-217"><span class="linenos">217</span></a>
</span><span id="Story.add_next_step-218"><a href="#Story.add_next_step-218"><span class="linenos">218</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_next_step-219"><a href="#Story.add_next_step-219"><span class="linenos">219</span></a><span class="sd">        Adds a next-step element to the visualisation with multiple customisation options.</span>
</span><span id="Story.add_next_step-220"><a href="#Story.add_next_step-220"><span class="linenos">220</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-221"><a href="#Story.add_next_step-221"><span class="linenos">221</span></a><span class="sd">        Parameters</span>
</span><span id="Story.add_next_step-222"><a href="#Story.add_next_step-222"><span class="linenos">222</span></a><span class="sd">        ---------</span>
</span><span id="Story.add_next_step-223"><a href="#Story.add_next_step-223"><span class="linenos">223</span></a><span class="sd">        text : str                                              Text for the basic version or for the button</span>
</span><span id="Story.add_next_step-224"><a href="#Story.add_next_step-224"><span class="linenos">224</span></a><span class="sd">        position : str, default=‘bottom’                        Position of the element (‘bottom’, ‘top’, ‘left’, ‘right’)</span>
</span><span id="Story.add_next_step-225"><a href="#Story.add_next_step-225"><span class="linenos">225</span></a><span class="sd">        type : str, optional                                    Display type (‘line_steps’, ‘button’, ‘stair_steps’)</span>
</span><span id="Story.add_next_step-226"><a href="#Story.add_next_step-226"><span class="linenos">226</span></a><span class="sd">        title : str, default=&quot;What can we do next?’             Title for special visualisations</span>
</span><span id="Story.add_next_step-227"><a href="#Story.add_next_step-227"><span class="linenos">227</span></a><span class="sd">        colour : str, optional                                  Text colour for the basic version</span>
</span><span id="Story.add_next_step-228"><a href="#Story.add_next_step-228"><span class="linenos">228</span></a><span class="sd">        font_family : str, default=‘Arial’                      Default font</span>
</span><span id="Story.add_next_step-229"><a href="#Story.add_next_step-229"><span class="linenos">229</span></a><span class="sd">        font_size : int, default=14                             Default font size</span>
</span><span id="Story.add_next_step-230"><a href="#Story.add_next_step-230"><span class="linenos">230</span></a><span class="sd">        texts : list of str                                     List of texts for line_steps and stair_steps</span>
</span><span id="Story.add_next_step-231"><a href="#Story.add_next_step-231"><span class="linenos">231</span></a><span class="sd">        url : str                                               URL for the button</span>
</span><span id="Story.add_next_step-232"><a href="#Story.add_next_step-232"><span class="linenos">232</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-233"><a href="#Story.add_next_step-233"><span class="linenos">233</span></a><span class="sd">        Parameters for Button</span>
</span><span id="Story.add_next_step-234"><a href="#Story.add_next_step-234"><span class="linenos">234</span></a><span class="sd">        ------------------</span>
</span><span id="Story.add_next_step-235"><a href="#Story.add_next_step-235"><span class="linenos">235</span></a><span class="sd">        button_width : int, default=120                         Button width</span>
</span><span id="Story.add_next_step-236"><a href="#Story.add_next_step-236"><span class="linenos">236</span></a><span class="sd">        button_height : int, default=40                         Height of the button</span>
</span><span id="Story.add_next_step-237"><a href="#Story.add_next_step-237"><span class="linenos">237</span></a><span class="sd">        button_color : str, default=‘#80C11E’                   Background colour of the button</span>
</span><span id="Story.add_next_step-238"><a href="#Story.add_next_step-238"><span class="linenos">238</span></a><span class="sd">        button_opacity : float, default=0.2                     Opacity of the button</span>
</span><span id="Story.add_next_step-239"><a href="#Story.add_next_step-239"><span class="linenos">239</span></a><span class="sd">        button_corner_radius : int, default=5                   Corner radius of the button</span>
</span><span id="Story.add_next_step-240"><a href="#Story.add_next_step-240"><span class="linenos">240</span></a><span class="sd">        button_text_color : str, default=‘black’                Button text colour</span>
</span><span id="Story.add_next_step-241"><a href="#Story.add_next_step-241"><span class="linenos">241</span></a><span class="sd">        button_font_family : str, optional                      Font specific to the button</span>
</span><span id="Story.add_next_step-242"><a href="#Story.add_next_step-242"><span class="linenos">242</span></a><span class="sd">        button_font_size : int, optional                        Font size for the button</span>
</span><span id="Story.add_next_step-243"><a href="#Story.add_next_step-243"><span class="linenos">243</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-244"><a href="#Story.add_next_step-244"><span class="linenos">244</span></a><span class="sd">        Parameters for Line Steps</span>
</span><span id="Story.add_next_step-245"><a href="#Story.add_next_step-245"><span class="linenos">245</span></a><span class="sd">        ----------------------</span>
</span><span id="Story.add_next_step-246"><a href="#Story.add_next_step-246"><span class="linenos">246</span></a><span class="sd">        line_steps_rect_width : int, default=10                 Rectangle width</span>
</span><span id="Story.add_next_step-247"><a href="#Story.add_next_step-247"><span class="linenos">247</span></a><span class="sd">        line_steps_rect_height : int, default=10                Height of rectangles</span>
</span><span id="Story.add_next_step-248"><a href="#Story.add_next_step-248"><span class="linenos">248</span></a><span class="sd">        line_steps_space : int, default=5                       Space between rectangles</span>
</span><span id="Story.add_next_step-249"><a href="#Story.add_next_step-249"><span class="linenos">249</span></a><span class="sd">        line_steps_chart_width : int, default=700               Total width of the chart</span>
</span><span id="Story.add_next_step-250"><a href="#Story.add_next_step-250"><span class="linenos">250</span></a><span class="sd">        line_steps_chart_height : int, default=100              Total chart height</span>
</span><span id="Story.add_next_step-251"><a href="#Story.add_next_step-251"><span class="linenos">251</span></a><span class="sd">        line_steps_color : str, default=‘#80C11E’               Colour of rectangles</span>
</span><span id="Story.add_next_step-252"><a href="#Story.add_next_step-252"><span class="linenos">252</span></a><span class="sd">        line_steps_opacity : float, default=0.2                 Opacity of rectangles</span>
</span><span id="Story.add_next_step-253"><a href="#Story.add_next_step-253"><span class="linenos">253</span></a><span class="sd">        line_steps_text_colour : str, default=‘black’           Text colour</span>
</span><span id="Story.add_next_step-254"><a href="#Story.add_next_step-254"><span class="linenos">254</span></a><span class="sd">        line_steps_font_family : str, optional                  Font specific to line steps</span>
</span><span id="Story.add_next_step-255"><a href="#Story.add_next_step-255"><span class="linenos">255</span></a><span class="sd">        line_steps_font_size : int, optional                    Font size for line steps</span>
</span><span id="Story.add_next_step-256"><a href="#Story.add_next_step-256"><span class="linenos">256</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-257"><a href="#Story.add_next_step-257"><span class="linenos">257</span></a><span class="sd">        Parameters for Stair Steps</span>
</span><span id="Story.add_next_step-258"><a href="#Story.add_next_step-258"><span class="linenos">258</span></a><span class="sd">        -----------------------</span>
</span><span id="Story.add_next_step-259"><a href="#Story.add_next_step-259"><span class="linenos">259</span></a><span class="sd">        stair_steps_rect_width : int, default=10                Width of steps</span>
</span><span id="Story.add_next_step-260"><a href="#Story.add_next_step-260"><span class="linenos">260</span></a><span class="sd">        stair_steps_rect_height : int, default=3                Height of steps</span>
</span><span id="Story.add_next_step-261"><a href="#Story.add_next_step-261"><span class="linenos">261</span></a><span class="sd">        stair_steps_chart_width : int, default=700              Total width of the chart</span>
</span><span id="Story.add_next_step-262"><a href="#Story.add_next_step-262"><span class="linenos">262</span></a><span class="sd">        stair_steps_chart_height : int, default=300             Total height of the chart</span>
</span><span id="Story.add_next_step-263"><a href="#Story.add_next_step-263"><span class="linenos">263</span></a><span class="sd">        stair_steps_color : str, default=‘#80C11E’              Colour of the steps</span>
</span><span id="Story.add_next_step-264"><a href="#Story.add_next_step-264"><span class="linenos">264</span></a><span class="sd">        stair_steps_opacity : float, default=0.2                Opacity of the steps</span>
</span><span id="Story.add_next_step-265"><a href="#Story.add_next_step-265"><span class="linenos">265</span></a><span class="sd">        stair_steps_text_colour : str, default=‘black’          Text colour</span>
</span><span id="Story.add_next_step-266"><a href="#Story.add_next_step-266"><span class="linenos">266</span></a><span class="sd">        stair_steps_font_family : str,                          Font specific to stair steps</span>
</span><span id="Story.add_next_step-267"><a href="#Story.add_next_step-267"><span class="linenos">267</span></a><span class="sd">        stair_steps_font_size : int, optional                   Font size for stair steps</span>
</span><span id="Story.add_next_step-268"><a href="#Story.add_next_step-268"><span class="linenos">268</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-269"><a href="#Story.add_next_step-269"><span class="linenos">269</span></a><span class="sd">        Title parameters</span>
</span><span id="Story.add_next_step-270"><a href="#Story.add_next_step-270"><span class="linenos">270</span></a><span class="sd">        ----------------------</span>
</span><span id="Story.add_next_step-271"><a href="#Story.add_next_step-271"><span class="linenos">271</span></a><span class="sd">        title_color : str, default=‘black’                      Title colour</span>
</span><span id="Story.add_next_step-272"><a href="#Story.add_next_step-272"><span class="linenos">272</span></a><span class="sd">        title_font_family : str, optional                       Specific font for the title</span>
</span><span id="Story.add_next_step-273"><a href="#Story.add_next_step-273"><span class="linenos">273</span></a><span class="sd">        title_font_size : int, optional                         Font size for the title</span>
</span><span id="Story.add_next_step-274"><a href="#Story.add_next_step-274"><span class="linenos">274</span></a><span class="sd">        </span>
</span><span id="Story.add_next_step-275"><a href="#Story.add_next_step-275"><span class="linenos">275</span></a><span class="sd">        Returns</span>
</span><span id="Story.add_next_step-276"><a href="#Story.add_next_step-276"><span class="linenos">276</span></a><span class="sd">        -------</span>
</span><span id="Story.add_next_step-277"><a href="#Story.add_next_step-277"><span class="linenos">277</span></a><span class="sd">        self : Story object                                     The current instance for method chaining</span>
</span><span id="Story.add_next_step-278"><a href="#Story.add_next_step-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.add_next_step-279"><a href="#Story.add_next_step-279"><span class="linenos">279</span></a>        
</span><span id="Story.add_next_step-280"><a href="#Story.add_next_step-280"><span class="linenos">280</span></a>        <span class="c1">#  Local import of NextStep to avoid circular imports</span>
</span><span id="Story.add_next_step-281"><a href="#Story.add_next_step-281"><span class="linenos">281</span></a>        <span class="kn">from</span> <span class="nn">.nextstep</span> <span class="kn">import</span> <span class="n">NextStep</span>
</span><span id="Story.add_next_step-282"><a href="#Story.add_next_step-282"><span class="linenos">282</span></a>    
</span><span id="Story.add_next_step-283"><a href="#Story.add_next_step-283"><span class="linenos">283</span></a>        <span class="c1"># Management of NextStep objects</span>
</span><span id="Story.add_next_step-284"><a href="#Story.add_next_step-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="n">button</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-285"><a href="#Story.add_next_step-285"><span class="linenos">285</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">button</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-286"><a href="#Story.add_next_step-286"><span class="linenos">286</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘button’ parameter must be a NextStep of type ‘button’&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-287"><a href="#Story.add_next_step-287"><span class="linenos">287</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">button</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story.add_next_step-288"><a href="#Story.add_next_step-288"><span class="linenos">288</span></a>        
</span><span id="Story.add_next_step-289"><a href="#Story.add_next_step-289"><span class="linenos">289</span></a>        <span class="k">elif</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-290"><a href="#Story.add_next_step-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-291"><a href="#Story.add_next_step-291"><span class="linenos">291</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘line’ parameter must be a NextStep of type ‘line_steps’&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-292"><a href="#Story.add_next_step-292"><span class="linenos">292</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">line</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story.add_next_step-293"><a href="#Story.add_next_step-293"><span class="linenos">293</span></a>        
</span><span id="Story.add_next_step-294"><a href="#Story.add_next_step-294"><span class="linenos">294</span></a>        <span class="k">elif</span> <span class="n">stairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-295"><a href="#Story.add_next_step-295"><span class="linenos">295</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stairs</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">stairs</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-296"><a href="#Story.add_next_step-296"><span class="linenos">296</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘stairs’ parameter must be a NextStep of type ‘stair_steps’&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-297"><a href="#Story.add_next_step-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">stairs</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story.add_next_step-298"><a href="#Story.add_next_step-298"><span class="linenos">298</span></a>        
</span><span id="Story.add_next_step-299"><a href="#Story.add_next_step-299"><span class="linenos">299</span></a>        <span class="k">elif</span> <span class="n">vers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-300"><a href="#Story.add_next_step-300"><span class="linenos">300</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vers</span><span class="p">,</span> <span class="n">NextStep</span><span class="p">):</span>
</span><span id="Story.add_next_step-301"><a href="#Story.add_next_step-301"><span class="linenos">301</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘vers’ must be an instance of NextStep&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-302"><a href="#Story.add_next_step-302"><span class="linenos">302</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_next_step</span><span class="p">(</span><span class="o">**</span><span class="n">vers</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="Story.add_next_step-303"><a href="#Story.add_next_step-303"><span class="linenos">303</span></a>        
</span><span id="Story.add_next_step-304"><a href="#Story.add_next_step-304"><span class="linenos">304</span></a>        <span class="c1"># Basic version (text only)</span>
</span><span id="Story.add_next_step-305"><a href="#Story.add_next_step-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-306"><a href="#Story.add_next_step-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-307"><a href="#Story.add_next_step-307"><span class="linenos">307</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the basic version&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-308"><a href="#Story.add_next_step-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_next_step-309"><a href="#Story.add_next_step-309"><span class="linenos">309</span></a>                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> 
</span><span id="Story.add_next_step-310"><a href="#Story.add_next_step-310"><span class="linenos">310</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> 
</span><span id="Story.add_next_step-311"><a href="#Story.add_next_step-311"><span class="linenos">311</span></a>                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
</span><span id="Story.add_next_step-312"><a href="#Story.add_next_step-312"><span class="linenos">312</span></a>                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;cta&#39;</span><span class="p">]</span>
</span><span id="Story.add_next_step-313"><a href="#Story.add_next_step-313"><span class="linenos">313</span></a>            <span class="p">})</span>
</span><span id="Story.add_next_step-314"><a href="#Story.add_next_step-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="Story.add_next_step-315"><a href="#Story.add_next_step-315"><span class="linenos">315</span></a>
</span><span id="Story.add_next_step-316"><a href="#Story.add_next_step-316"><span class="linenos">316</span></a>        <span class="c1"># Type validation</span>
</span><span id="Story.add_next_step-317"><a href="#Story.add_next_step-317"><span class="linenos">317</span></a>        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;line_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">]</span>
</span><span id="Story.add_next_step-318"><a href="#Story.add_next_step-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
</span><span id="Story.add_next_step-319"><a href="#Story.add_next_step-319"><span class="linenos">319</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tipo non valido. Usare uno tra: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-320"><a href="#Story.add_next_step-320"><span class="linenos">320</span></a>
</span><span id="Story.add_next_step-321"><a href="#Story.add_next_step-321"><span class="linenos">321</span></a>        <span class="c1"># Chart creation by type</span>
</span><span id="Story.add_next_step-322"><a href="#Story.add_next_step-322"><span class="linenos">322</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-323"><a href="#Story.add_next_step-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-324"><a href="#Story.add_next_step-324"><span class="linenos">324</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The parameter ‘text’ is required for the button type&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-325"><a href="#Story.add_next_step-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Story.add_next_step-326"><a href="#Story.add_next_step-326"><span class="linenos">326</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The ‘url’ parameter is required for the button type&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-327"><a href="#Story.add_next_step-327"><span class="linenos">327</span></a>            
</span><span id="Story.add_next_step-328"><a href="#Story.add_next_step-328"><span class="linenos">328</span></a>            <span class="c1"># Button chart creation</span>
</span><span id="Story.add_next_step-329"><a href="#Story.add_next_step-329"><span class="linenos">329</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
</span><span id="Story.add_next_step-330"><a href="#Story.add_next_step-330"><span class="linenos">330</span></a>                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
</span><span id="Story.add_next_step-331"><a href="#Story.add_next_step-331"><span class="linenos">331</span></a>                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="Story.add_next_step-332"><a href="#Story.add_next_step-332"><span class="linenos">332</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Story.add_next_step-333"><a href="#Story.add_next_step-333"><span class="linenos">333</span></a>                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Story.add_next_step-334"><a href="#Story.add_next_step-334"><span class="linenos">334</span></a>            <span class="p">}])</span>
</span><span id="Story.add_next_step-335"><a href="#Story.add_next_step-335"><span class="linenos">335</span></a>            
</span><span id="Story.add_next_step-336"><a href="#Story.add_next_step-336"><span class="linenos">336</span></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-337"><a href="#Story.add_next_step-337"><span class="linenos">337</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-338"><a href="#Story.add_next_step-338"><span class="linenos">338</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Story.add_next_step-339"><a href="#Story.add_next_step-339"><span class="linenos">339</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story.add_next_step-340"><a href="#Story.add_next_step-340"><span class="linenos">340</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="Story.add_next_step-341"><a href="#Story.add_next_step-341"><span class="linenos">341</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="Story.add_next_step-342"><a href="#Story.add_next_step-342"><span class="linenos">342</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-343"><a href="#Story.add_next_step-343"><span class="linenos">343</span></a>            
</span><span id="Story.add_next_step-344"><a href="#Story.add_next_step-344"><span class="linenos">344</span></a>            <span class="n">button_bg</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story.add_next_step-345"><a href="#Story.add_next_step-345"><span class="linenos">345</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_color</span><span class="p">,</span>
</span><span id="Story.add_next_step-346"><a href="#Story.add_next_step-346"><span class="linenos">346</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">button_opacity</span><span class="p">,</span>
</span><span id="Story.add_next_step-347"><a href="#Story.add_next_step-347"><span class="linenos">347</span></a>                <span class="n">cornerRadius</span><span class="o">=</span><span class="n">button_corner_radius</span><span class="p">,</span>
</span><span id="Story.add_next_step-348"><a href="#Story.add_next_step-348"><span class="linenos">348</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">button_width</span><span class="p">,</span>
</span><span id="Story.add_next_step-349"><a href="#Story.add_next_step-349"><span class="linenos">349</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">button_height</span>
</span><span id="Story.add_next_step-350"><a href="#Story.add_next_step-350"><span class="linenos">350</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-351"><a href="#Story.add_next_step-351"><span class="linenos">351</span></a>                <span class="n">href</span><span class="o">=</span><span class="s1">&#39;url:N&#39;</span>
</span><span id="Story.add_next_step-352"><a href="#Story.add_next_step-352"><span class="linenos">352</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-353"><a href="#Story.add_next_step-353"><span class="linenos">353</span></a>            
</span><span id="Story.add_next_step-354"><a href="#Story.add_next_step-354"><span class="linenos">354</span></a>            <span class="n">button_text</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.add_next_step-355"><a href="#Story.add_next_step-355"><span class="linenos">355</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">button_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story.add_next_step-356"><a href="#Story.add_next_step-356"><span class="linenos">356</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">button_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story.add_next_step-357"><a href="#Story.add_next_step-357"><span class="linenos">357</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-358"><a href="#Story.add_next_step-358"><span class="linenos">358</span></a>                <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-359"><a href="#Story.add_next_step-359"><span class="linenos">359</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">button_text_color</span>
</span><span id="Story.add_next_step-360"><a href="#Story.add_next_step-360"><span class="linenos">360</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-361"><a href="#Story.add_next_step-361"><span class="linenos">361</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
</span><span id="Story.add_next_step-362"><a href="#Story.add_next_step-362"><span class="linenos">362</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-363"><a href="#Story.add_next_step-363"><span class="linenos">363</span></a>            
</span><span id="Story.add_next_step-364"><a href="#Story.add_next_step-364"><span class="linenos">364</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">button_bg</span><span class="p">,</span> <span class="n">button_text</span><span class="p">)</span>
</span><span id="Story.add_next_step-365"><a href="#Story.add_next_step-365"><span class="linenos">365</span></a>            
</span><span id="Story.add_next_step-366"><a href="#Story.add_next_step-366"><span class="linenos">366</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;line_steps&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-367"><a href="#Story.add_next_step-367"><span class="linenos">367</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Story.add_next_step-368"><a href="#Story.add_next_step-368"><span class="linenos">368</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;It is necessary to provide a list of texts for line_steps&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-369"><a href="#Story.add_next_step-369"><span class="linenos">369</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="Story.add_next_step-370"><a href="#Story.add_next_step-370"><span class="linenos">370</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-371"><a href="#Story.add_next_step-371"><span class="linenos">371</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story.add_next_step-372"><a href="#Story.add_next_step-372"><span class="linenos">372</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-373"><a href="#Story.add_next_step-373"><span class="linenos">373</span></a>                
</span><span id="Story.add_next_step-374"><a href="#Story.add_next_step-374"><span class="linenos">374</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="Story.add_next_step-375"><a href="#Story.add_next_step-375"><span class="linenos">375</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="Story.add_next_step-376"><a href="#Story.add_next_step-376"><span class="linenos">376</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-377"><a href="#Story.add_next_step-377"><span class="linenos">377</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-378"><a href="#Story.add_next_step-378"><span class="linenos">378</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">line_steps_space</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-379"><a href="#Story.add_next_step-379"><span class="linenos">379</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_steps_rect_height</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-380"><a href="#Story.add_next_step-380"><span class="linenos">380</span></a>            
</span><span id="Story.add_next_step-381"><a href="#Story.add_next_step-381"><span class="linenos">381</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story.add_next_step-382"><a href="#Story.add_next_step-382"><span class="linenos">382</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="Story.add_next_step-383"><a href="#Story.add_next_step-383"><span class="linenos">383</span></a>            <span class="p">})</span>
</span><span id="Story.add_next_step-384"><a href="#Story.add_next_step-384"><span class="linenos">384</span></a>            
</span><span id="Story.add_next_step-385"><a href="#Story.add_next_step-385"><span class="linenos">385</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="Story.add_next_step-386"><a href="#Story.add_next_step-386"><span class="linenos">386</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story.add_next_step-387"><a href="#Story.add_next_step-387"><span class="linenos">387</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_color</span><span class="p">,</span>
</span><span id="Story.add_next_step-388"><a href="#Story.add_next_step-388"><span class="linenos">388</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">line_steps_opacity</span>
</span><span id="Story.add_next_step-389"><a href="#Story.add_next_step-389"><span class="linenos">389</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-390"><a href="#Story.add_next_step-390"><span class="linenos">390</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-391"><a href="#Story.add_next_step-391"><span class="linenos">391</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-392"><a href="#Story.add_next_step-392"><span class="linenos">392</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-393"><a href="#Story.add_next_step-393"><span class="linenos">393</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story.add_next_step-394"><a href="#Story.add_next_step-394"><span class="linenos">394</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story.add_next_step-395"><a href="#Story.add_next_step-395"><span class="linenos">395</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">line_steps_chart_width</span><span class="p">,</span>
</span><span id="Story.add_next_step-396"><a href="#Story.add_next_step-396"><span class="linenos">396</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">line_steps_chart_height</span>
</span><span id="Story.add_next_step-397"><a href="#Story.add_next_step-397"><span class="linenos">397</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-398"><a href="#Story.add_next_step-398"><span class="linenos">398</span></a>            
</span><span id="Story.add_next_step-399"><a href="#Story.add_next_step-399"><span class="linenos">399</span></a>            <span class="c1"># Add text labels</span>
</span><span id="Story.add_next_step-400"><a href="#Story.add_next_step-400"><span class="linenos">400</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.add_next_step-401"><a href="#Story.add_next_step-401"><span class="linenos">401</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">line_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story.add_next_step-402"><a href="#Story.add_next_step-402"><span class="linenos">402</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">line_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story.add_next_step-403"><a href="#Story.add_next_step-403"><span class="linenos">403</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-404"><a href="#Story.add_next_step-404"><span class="linenos">404</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story.add_next_step-405"><a href="#Story.add_next_step-405"><span class="linenos">405</span></a>                <span class="n">lineHeight</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
</span><span id="Story.add_next_step-406"><a href="#Story.add_next_step-406"><span class="linenos">406</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">line_steps_text_color</span>
</span><span id="Story.add_next_step-407"><a href="#Story.add_next_step-407"><span class="linenos">407</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-408"><a href="#Story.add_next_step-408"><span class="linenos">408</span></a>                <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text:N&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-409"><a href="#Story.add_next_step-409"><span class="linenos">409</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-410"><a href="#Story.add_next_step-410"><span class="linenos">410</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_half:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-411"><a href="#Story.add_next_step-411"><span class="linenos">411</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="Story.add_next_step-412"><a href="#Story.add_next_step-412"><span class="linenos">412</span></a>                <span class="n">y_half</span><span class="o">=</span><span class="s1">&#39;datum.y2/2&#39;</span>
</span><span id="Story.add_next_step-413"><a href="#Story.add_next_step-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-414"><a href="#Story.add_next_step-414"><span class="linenos">414</span></a>            
</span><span id="Story.add_next_step-415"><a href="#Story.add_next_step-415"><span class="linenos">415</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story.add_next_step-416"><a href="#Story.add_next_step-416"><span class="linenos">416</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story.add_next_step-417"><a href="#Story.add_next_step-417"><span class="linenos">417</span></a>                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_width</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">line_steps_space</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="Story.add_next_step-418"><a href="#Story.add_next_step-418"><span class="linenos">418</span></a>                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span>
</span><span id="Story.add_next_step-419"><a href="#Story.add_next_step-419"><span class="linenos">419</span></a>                    <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">line_steps_rect_width</span><span class="o">+</span><span class="n">line_steps_space</span><span class="p">)</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)],</span>
</span><span id="Story.add_next_step-420"><a href="#Story.add_next_step-420"><span class="linenos">420</span></a>                    <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">line_steps_rect_height</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="Story.add_next_step-421"><a href="#Story.add_next_step-421"><span class="linenos">421</span></a>                <span class="p">})</span>
</span><span id="Story.add_next_step-422"><a href="#Story.add_next_step-422"><span class="linenos">422</span></a>                
</span><span id="Story.add_next_step-423"><a href="#Story.add_next_step-423"><span class="linenos">423</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="Story.add_next_step-424"><a href="#Story.add_next_step-424"><span class="linenos">424</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Story.add_next_step-425"><a href="#Story.add_next_step-425"><span class="linenos">425</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Story.add_next_step-426"><a href="#Story.add_next_step-426"><span class="linenos">426</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-427"><a href="#Story.add_next_step-427"><span class="linenos">427</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-428"><a href="#Story.add_next_step-428"><span class="linenos">428</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-429"><a href="#Story.add_next_step-429"><span class="linenos">429</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-430"><a href="#Story.add_next_step-430"><span class="linenos">430</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story.add_next_step-431"><a href="#Story.add_next_step-431"><span class="linenos">431</span></a>                <span class="p">)</span>
</span><span id="Story.add_next_step-432"><a href="#Story.add_next_step-432"><span class="linenos">432</span></a>                
</span><span id="Story.add_next_step-433"><a href="#Story.add_next_step-433"><span class="linenos">433</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story.add_next_step-434"><a href="#Story.add_next_step-434"><span class="linenos">434</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Story.add_next_step-435"><a href="#Story.add_next_step-435"><span class="linenos">435</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story.add_next_step-436"><a href="#Story.add_next_step-436"><span class="linenos">436</span></a>                
</span><span id="Story.add_next_step-437"><a href="#Story.add_next_step-437"><span class="linenos">437</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;stair_steps&#39;</span><span class="p">:</span>
</span><span id="Story.add_next_step-438"><a href="#Story.add_next_step-438"><span class="linenos">438</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Story.add_next_step-439"><a href="#Story.add_next_step-439"><span class="linenos">439</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide a list of texts for stair_steps&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-440"><a href="#Story.add_next_step-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="Story.add_next_step-441"><a href="#Story.add_next_step-441"><span class="linenos">441</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum number of steps is 5&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-442"><a href="#Story.add_next_step-442"><span class="linenos">442</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story.add_next_step-443"><a href="#Story.add_next_step-443"><span class="linenos">443</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide at least one step&quot;</span><span class="p">)</span>
</span><span id="Story.add_next_step-444"><a href="#Story.add_next_step-444"><span class="linenos">444</span></a>                
</span><span id="Story.add_next_step-445"><a href="#Story.add_next_step-445"><span class="linenos">445</span></a>            <span class="c1"># Create DataFrame for rectangles and text</span>
</span><span id="Story.add_next_step-446"><a href="#Story.add_next_step-446"><span class="linenos">446</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
</span><span id="Story.add_next_step-447"><a href="#Story.add_next_step-447"><span class="linenos">447</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-448"><a href="#Story.add_next_step-448"><span class="linenos">448</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-449"><a href="#Story.add_next_step-449"><span class="linenos">449</span></a>            <span class="n">x2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-450"><a href="#Story.add_next_step-450"><span class="linenos">450</span></a>            <span class="n">y2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stair_steps_rect_height</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span><span id="Story.add_next_step-451"><a href="#Story.add_next_step-451"><span class="linenos">451</span></a>            
</span><span id="Story.add_next_step-452"><a href="#Story.add_next_step-452"><span class="linenos">452</span></a>            <span class="n">df_rect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>   
</span><span id="Story.add_next_step-453"><a href="#Story.add_next_step-453"><span class="linenos">453</span></a>                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span>
</span><span id="Story.add_next_step-454"><a href="#Story.add_next_step-454"><span class="linenos">454</span></a>            <span class="p">})</span>
</span><span id="Story.add_next_step-455"><a href="#Story.add_next_step-455"><span class="linenos">455</span></a>            
</span><span id="Story.add_next_step-456"><a href="#Story.add_next_step-456"><span class="linenos">456</span></a>            <span class="c1"># Create rectangles</span>
</span><span id="Story.add_next_step-457"><a href="#Story.add_next_step-457"><span class="linenos">457</span></a>            <span class="n">rect</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_rect</span><span class="p">(</span>
</span><span id="Story.add_next_step-458"><a href="#Story.add_next_step-458"><span class="linenos">458</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_color</span><span class="p">,</span>
</span><span id="Story.add_next_step-459"><a href="#Story.add_next_step-459"><span class="linenos">459</span></a>                <span class="n">opacity</span><span class="o">=</span><span class="n">stair_steps_opacity</span>
</span><span id="Story.add_next_step-460"><a href="#Story.add_next_step-460"><span class="linenos">460</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-461"><a href="#Story.add_next_step-461"><span class="linenos">461</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-462"><a href="#Story.add_next_step-462"><span class="linenos">462</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">stair_steps_rect_height</span><span class="p">])),</span>
</span><span id="Story.add_next_step-463"><a href="#Story.add_next_step-463"><span class="linenos">463</span></a>                <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-464"><a href="#Story.add_next_step-464"><span class="linenos">464</span></a>                <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story.add_next_step-465"><a href="#Story.add_next_step-465"><span class="linenos">465</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story.add_next_step-466"><a href="#Story.add_next_step-466"><span class="linenos">466</span></a>                <span class="n">width</span><span class="o">=</span><span class="n">stair_steps_chart_width</span><span class="p">,</span>
</span><span id="Story.add_next_step-467"><a href="#Story.add_next_step-467"><span class="linenos">467</span></a>                <span class="n">height</span><span class="o">=</span><span class="n">stair_steps_chart_height</span>
</span><span id="Story.add_next_step-468"><a href="#Story.add_next_step-468"><span class="linenos">468</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-469"><a href="#Story.add_next_step-469"><span class="linenos">469</span></a>            
</span><span id="Story.add_next_step-470"><a href="#Story.add_next_step-470"><span class="linenos">470</span></a>            <span class="c1"># Add text labels</span>
</span><span id="Story.add_next_step-471"><a href="#Story.add_next_step-471"><span class="linenos">471</span></a>            <span class="n">text</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_rect</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.add_next_step-472"><a href="#Story.add_next_step-472"><span class="linenos">472</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="n">stair_steps_font_size</span> <span class="ow">or</span> <span class="n">font_size</span><span class="p">,</span>
</span><span id="Story.add_next_step-473"><a href="#Story.add_next_step-473"><span class="linenos">473</span></a>                <span class="n">font</span><span class="o">=</span><span class="n">stair_steps_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story.add_next_step-474"><a href="#Story.add_next_step-474"><span class="linenos">474</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-475"><a href="#Story.add_next_step-475"><span class="linenos">475</span></a>                <span class="n">dx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="Story.add_next_step-476"><a href="#Story.add_next_step-476"><span class="linenos">476</span></a>                <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="Story.add_next_step-477"><a href="#Story.add_next_step-477"><span class="linenos">477</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">stair_steps_text_color</span>
</span><span id="Story.add_next_step-478"><a href="#Story.add_next_step-478"><span class="linenos">478</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-479"><a href="#Story.add_next_step-479"><span class="linenos">479</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span>
</span><span id="Story.add_next_step-480"><a href="#Story.add_next_step-480"><span class="linenos">480</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-481"><a href="#Story.add_next_step-481"><span class="linenos">481</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y_mid:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-482"><a href="#Story.add_next_step-482"><span class="linenos">482</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform_calculate</span><span class="p">(</span>
</span><span id="Story.add_next_step-483"><a href="#Story.add_next_step-483"><span class="linenos">483</span></a>                <span class="n">y_mid</span><span class="o">=</span><span class="s1">&#39;(datum.y + datum.y2)/2&#39;</span>
</span><span id="Story.add_next_step-484"><a href="#Story.add_next_step-484"><span class="linenos">484</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-485"><a href="#Story.add_next_step-485"><span class="linenos">485</span></a>            
</span><span id="Story.add_next_step-486"><a href="#Story.add_next_step-486"><span class="linenos">486</span></a>            <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Story.add_next_step-487"><a href="#Story.add_next_step-487"><span class="linenos">487</span></a>                <span class="n">line_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.add_next_step-488"><a href="#Story.add_next_step-488"><span class="linenos">488</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Story.add_next_step-489"><a href="#Story.add_next_step-489"><span class="linenos">489</span></a>                    <span class="n">line_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_next_step-490"><a href="#Story.add_next_step-490"><span class="linenos">490</span></a>                        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="Story.add_next_step-491"><a href="#Story.add_next_step-491"><span class="linenos">491</span></a>                        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="Story.add_next_step-492"><a href="#Story.add_next_step-492"><span class="linenos">492</span></a>                        <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Story.add_next_step-493"><a href="#Story.add_next_step-493"><span class="linenos">493</span></a>                        <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story.add_next_step-494"><a href="#Story.add_next_step-494"><span class="linenos">494</span></a>                    <span class="p">})</span>
</span><span id="Story.add_next_step-495"><a href="#Story.add_next_step-495"><span class="linenos">495</span></a>                
</span><span id="Story.add_next_step-496"><a href="#Story.add_next_step-496"><span class="linenos">496</span></a>                <span class="n">df_line</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">line_data</span><span class="p">)</span>
</span><span id="Story.add_next_step-497"><a href="#Story.add_next_step-497"><span class="linenos">497</span></a>                
</span><span id="Story.add_next_step-498"><a href="#Story.add_next_step-498"><span class="linenos">498</span></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">df_line</span><span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">(</span>
</span><span id="Story.add_next_step-499"><a href="#Story.add_next_step-499"><span class="linenos">499</span></a>                    <span class="n">point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Story.add_next_step-500"><a href="#Story.add_next_step-500"><span class="linenos">500</span></a>                    <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span>
</span><span id="Story.add_next_step-501"><a href="#Story.add_next_step-501"><span class="linenos">501</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_next_step-502"><a href="#Story.add_next_step-502"><span class="linenos">502</span></a>                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;x:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-503"><a href="#Story.add_next_step-503"><span class="linenos">503</span></a>                    <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;y:Q&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="Story.add_next_step-504"><a href="#Story.add_next_step-504"><span class="linenos">504</span></a>                    <span class="n">x2</span><span class="o">=</span><span class="s1">&#39;x2:Q&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-505"><a href="#Story.add_next_step-505"><span class="linenos">505</span></a>                    <span class="n">y2</span><span class="o">=</span><span class="s1">&#39;y2:Q&#39;</span>
</span><span id="Story.add_next_step-506"><a href="#Story.add_next_step-506"><span class="linenos">506</span></a>                <span class="p">)</span>
</span><span id="Story.add_next_step-507"><a href="#Story.add_next_step-507"><span class="linenos">507</span></a>                
</span><span id="Story.add_next_step-508"><a href="#Story.add_next_step-508"><span class="linenos">508</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story.add_next_step-509"><a href="#Story.add_next_step-509"><span class="linenos">509</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Story.add_next_step-510"><a href="#Story.add_next_step-510"><span class="linenos">510</span></a>                <span class="n">chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span id="Story.add_next_step-511"><a href="#Story.add_next_step-511"><span class="linenos">511</span></a>
</span><span id="Story.add_next_step-512"><a href="#Story.add_next_step-512"><span class="linenos">512</span></a>        <span class="c1"># Addition of title with customisable font</span>
</span><span id="Story.add_next_step-513"><a href="#Story.add_next_step-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
</span><span id="Story.add_next_step-514"><a href="#Story.add_next_step-514"><span class="linenos">514</span></a>            <span class="n">chart</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
</span><span id="Story.add_next_step-515"><a href="#Story.add_next_step-515"><span class="linenos">515</span></a>                <span class="n">title</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">TitleParams</span><span class="p">(</span>
</span><span id="Story.add_next_step-516"><a href="#Story.add_next_step-516"><span class="linenos">516</span></a>                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
</span><span id="Story.add_next_step-517"><a href="#Story.add_next_step-517"><span class="linenos">517</span></a>                    <span class="n">fontSize</span><span class="o">=</span><span class="n">title_font_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">font_size</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">),</span>
</span><span id="Story.add_next_step-518"><a href="#Story.add_next_step-518"><span class="linenos">518</span></a>                    <span class="n">font</span><span class="o">=</span><span class="n">title_font_family</span> <span class="ow">or</span> <span class="n">font_family</span><span class="p">,</span>
</span><span id="Story.add_next_step-519"><a href="#Story.add_next_step-519"><span class="linenos">519</span></a>                    <span class="n">color</span><span class="o">=</span><span class="n">title_color</span><span class="p">,</span>
</span><span id="Story.add_next_step-520"><a href="#Story.add_next_step-520"><span class="linenos">520</span></a>                    <span class="n">offset</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Story.add_next_step-521"><a href="#Story.add_next_step-521"><span class="linenos">521</span></a>                <span class="p">)</span>
</span><span id="Story.add_next_step-522"><a href="#Story.add_next_step-522"><span class="linenos">522</span></a>            <span class="p">)</span>
</span><span id="Story.add_next_step-523"><a href="#Story.add_next_step-523"><span class="linenos">523</span></a>
</span><span id="Story.add_next_step-524"><a href="#Story.add_next_step-524"><span class="linenos">524</span></a>        <span class="c1"># Addition to layer</span>
</span><span id="Story.add_next_step-525"><a href="#Story.add_next_step-525"><span class="linenos">525</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_next_step-526"><a href="#Story.add_next_step-526"><span class="linenos">526</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">,</span>
</span><span id="Story.add_next_step-527"><a href="#Story.add_next_step-527"><span class="linenos">527</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">chart</span><span class="p">,</span>
</span><span id="Story.add_next_step-528"><a href="#Story.add_next_step-528"><span class="linenos">528</span></a>            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>
</span><span id="Story.add_next_step-529"><a href="#Story.add_next_step-529"><span class="linenos">529</span></a>        <span class="p">})</span>
</span><span id="Story.add_next_step-530"><a href="#Story.add_next_step-530"><span class="linenos">530</span></a>        
</span><span id="Story.add_next_step-531"><a href="#Story.add_next_step-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Adds a next-step element to the visualisation with multiple customisation options.
Supports the use of NextStep with any parameter name via kwargs.</p>
</div>


                            </div>
                            <div id="Story.add_annotation" class="classattr">
                                        <input id="Story.add_annotation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_annotation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x_point</span>,</span><span class="param">	<span class="n">y_point</span>,</span><span class="param">	<span class="n">annotation_text</span><span class="o">=</span><span class="s1">&#39;Point of interest&#39;</span>,</span><span class="param">	<span class="n">arrow_direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span>,</span><span class="param">	<span class="n">arrow_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span>,</span><span class="param">	<span class="n">arrow_size</span><span class="o">=</span><span class="mi">40</span>,</span><span class="param">	<span class="n">label_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>,</span><span class="param">	<span class="n">label_size</span><span class="o">=</span><span class="mi">12</span>,</span><span class="param">	<span class="n">show_point</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span>,</span><span class="param">	<span class="n">point_size</span><span class="o">=</span><span class="mi">60</span>,</span><span class="param">	<span class="n">arrow_dx</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">arrow_dy</span><span class="o">=-</span><span class="mi">45</span>,</span><span class="param">	<span class="n">label_dx</span><span class="o">=</span><span class="mi">37</span>,</span><span class="param">	<span class="n">label_dy</span><span class="o">=-</span><span class="mi">37</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.add_annotation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.add_annotation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.add_annotation-533"><a href="#Story.add_annotation-533"><span class="linenos">533</span></a>    <span class="k">def</span> <span class="nf">add_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_point</span><span class="p">,</span> <span class="n">y_point</span><span class="p">,</span> <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&quot;Point of interest&quot;</span><span class="p">,</span> 
</span><span id="Story.add_annotation-534"><a href="#Story.add_annotation-534"><span class="linenos">534</span></a>                                     <span class="n">arrow_direction</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">arrow_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">arrow_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
</span><span id="Story.add_annotation-535"><a href="#Story.add_annotation-535"><span class="linenos">535</span></a>                                     <span class="n">label_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="Story.add_annotation-536"><a href="#Story.add_annotation-536"><span class="linenos">536</span></a>                                     <span class="n">show_point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="Story.add_annotation-537"><a href="#Story.add_annotation-537"><span class="linenos">537</span></a>                                     <span class="n">arrow_dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">arrow_dy</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span>
</span><span id="Story.add_annotation-538"><a href="#Story.add_annotation-538"><span class="linenos">538</span></a>                                     <span class="n">label_dx</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">label_dy</span><span class="o">=-</span><span class="mi">37</span><span class="p">):</span>
</span><span id="Story.add_annotation-539"><a href="#Story.add_annotation-539"><span class="linenos">539</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_annotation-540"><a href="#Story.add_annotation-540"><span class="linenos">540</span></a><span class="sd">        Create an arrow annotation on the graph.</span>
</span><span id="Story.add_annotation-541"><a href="#Story.add_annotation-541"><span class="linenos">541</span></a><span class="sd">        </span>
</span><span id="Story.add_annotation-542"><a href="#Story.add_annotation-542"><span class="linenos">542</span></a><span class="sd">        This method is essential for highlighting specific points in the graph and adding</span>
</span><span id="Story.add_annotation-543"><a href="#Story.add_annotation-543"><span class="linenos">543</span></a><span class="sd">        contextual explanations. It is particularly useful for data narration, allowing</span>
</span><span id="Story.add_annotation-544"><a href="#Story.add_annotation-544"><span class="linenos">544</span></a><span class="sd">        to guide the observer&#39;s attention to relevant aspects of the visualisation.</span>
</span><span id="Story.add_annotation-545"><a href="#Story.add_annotation-545"><span class="linenos">545</span></a>
</span><span id="Story.add_annotation-546"><a href="#Story.add_annotation-546"><span class="linenos">546</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.add_annotation-547"><a href="#Story.add_annotation-547"><span class="linenos">547</span></a><span class="sd">        - x_point, y_point: Coordinates of the point to be annotated</span>
</span><span id="Story.add_annotation-548"><a href="#Story.add_annotation-548"><span class="linenos">548</span></a><span class="sd">        - annotation_text: Text of the annotation (default: ‘Point of interest’)</span>
</span><span id="Story.add_annotation-549"><a href="#Story.add_annotation-549"><span class="linenos">549</span></a><span class="sd">        - arrow_direction: Direction of the arrow (default: ‘right’)</span>
</span><span id="Story.add_annotation-550"><a href="#Story.add_annotation-550"><span class="linenos">550</span></a><span class="sd">        - arrow_color, arrow_size: Arrow colour and size</span>
</span><span id="Story.add_annotation-551"><a href="#Story.add_annotation-551"><span class="linenos">551</span></a><span class="sd">        - label_colour, label_size: Colour and size of the annotation text</span>
</span><span id="Story.add_annotation-552"><a href="#Story.add_annotation-552"><span class="linenos">552</span></a><span class="sd">        - show_point: If True, shows a point at the annotation location</span>
</span><span id="Story.add_annotation-553"><a href="#Story.add_annotation-553"><span class="linenos">553</span></a><span class="sd">        - point_color, point_size: Colour and size of the point</span>
</span><span id="Story.add_annotation-554"><a href="#Story.add_annotation-554"><span class="linenos">554</span></a><span class="sd">        - arrow_dx, arrow_dy: Distances in pixels to be added to the arrow position (default:0, -45)</span>
</span><span id="Story.add_annotation-555"><a href="#Story.add_annotation-555"><span class="linenos">555</span></a><span class="sd">        - label_dx, label_dy: Distances in pixels to be added to the label position (default:37, -37)</span>
</span><span id="Story.add_annotation-556"><a href="#Story.add_annotation-556"><span class="linenos">556</span></a>
</span><span id="Story.add_annotation-557"><a href="#Story.add_annotation-557"><span class="linenos">557</span></a><span class="sd">        returns:</span>
</span><span id="Story.add_annotation-558"><a href="#Story.add_annotation-558"><span class="linenos">558</span></a><span class="sd">        - self, to allow method chaining</span>
</span><span id="Story.add_annotation-559"><a href="#Story.add_annotation-559"><span class="linenos">559</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.add_annotation-560"><a href="#Story.add_annotation-560"><span class="linenos">560</span></a>        
</span><span id="Story.add_annotation-561"><a href="#Story.add_annotation-561"><span class="linenos">561</span></a>        <span class="c1"># Dictionary that maps arrow directions to corresponding Unicode symbols</span>
</span><span id="Story.add_annotation-562"><a href="#Story.add_annotation-562"><span class="linenos">562</span></a>        <span class="n">arrow_symbols</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Story.add_annotation-563"><a href="#Story.add_annotation-563"><span class="linenos">563</span></a>            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;←&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;→&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span> <span class="s1">&#39;↓&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-564"><a href="#Story.add_annotation-564"><span class="linenos">564</span></a>            <span class="s1">&#39;upleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↖&#39;</span><span class="p">,</span> <span class="s1">&#39;upright&#39;</span><span class="p">:</span> <span class="s1">&#39;↗&#39;</span><span class="p">,</span> <span class="s1">&#39;downleft&#39;</span><span class="p">:</span> <span class="s1">&#39;↙&#39;</span><span class="p">,</span> <span class="s1">&#39;downright&#39;</span><span class="p">:</span> <span class="s1">&#39;↘&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-565"><a href="#Story.add_annotation-565"><span class="linenos">565</span></a>            <span class="s1">&#39;leftup&#39;</span><span class="p">:</span> <span class="s1">&#39;↰&#39;</span><span class="p">,</span> <span class="s1">&#39;leftdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↲&#39;</span><span class="p">,</span> <span class="s1">&#39;rightup&#39;</span><span class="p">:</span> <span class="s1">&#39;↱&#39;</span><span class="p">,</span> <span class="s1">&#39;rightdown&#39;</span><span class="p">:</span> <span class="s1">&#39;↳&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-566"><a href="#Story.add_annotation-566"><span class="linenos">566</span></a>            <span class="s1">&#39;upleftcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↺&#39;</span><span class="p">,</span> <span class="s1">&#39;uprightcurve&#39;</span><span class="p">:</span> <span class="s1">&#39;↻&#39;</span>
</span><span id="Story.add_annotation-567"><a href="#Story.add_annotation-567"><span class="linenos">567</span></a>        <span class="p">}</span>
</span><span id="Story.add_annotation-568"><a href="#Story.add_annotation-568"><span class="linenos">568</span></a>
</span><span id="Story.add_annotation-569"><a href="#Story.add_annotation-569"><span class="linenos">569</span></a>        <span class="c1"># Check that the direction of the arrow is valid</span>
</span><span id="Story.add_annotation-570"><a href="#Story.add_annotation-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="n">arrow_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrow_symbols</span><span class="p">:</span>
</span><span id="Story.add_annotation-571"><a href="#Story.add_annotation-571"><span class="linenos">571</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid arrow direction. Use one of: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arrow_symbols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Story.add_annotation-572"><a href="#Story.add_annotation-572"><span class="linenos">572</span></a>
</span><span id="Story.add_annotation-573"><a href="#Story.add_annotation-573"><span class="linenos">573</span></a>        <span class="c1"># Select the appropriate arrow symbol</span>
</span><span id="Story.add_annotation-574"><a href="#Story.add_annotation-574"><span class="linenos">574</span></a>        <span class="n">arrow_symbol</span> <span class="o">=</span> <span class="n">arrow_symbols</span><span class="p">[</span><span class="n">arrow_direction</span><span class="p">]</span>
</span><span id="Story.add_annotation-575"><a href="#Story.add_annotation-575"><span class="linenos">575</span></a>        
</span><span id="Story.add_annotation-576"><a href="#Story.add_annotation-576"><span class="linenos">576</span></a>        <span class="c1"># checks whether the encoding has already been defined</span>
</span><span id="Story.add_annotation-577"><a href="#Story.add_annotation-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">)</span><span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
</span><span id="Story.add_annotation-578"><a href="#Story.add_annotation-578"><span class="linenos">578</span></a>            <span class="c1"># If encoding is not defined use of default values</span>
</span><span id="Story.add_annotation-579"><a href="#Story.add_annotation-579"><span class="linenos">579</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="Story.add_annotation-580"><a href="#Story.add_annotation-580"><span class="linenos">580</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
</span><span id="Story.add_annotation-581"><a href="#Story.add_annotation-581"><span class="linenos">581</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Story.add_annotation-582"><a href="#Story.add_annotation-582"><span class="linenos">582</span></a>            <span class="c1"># If encoding is defined, we extract the data types for the x and y axes</span>
</span><span id="Story.add_annotation-583"><a href="#Story.add_annotation-583"><span class="linenos">583</span></a>            <span class="n">x_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story.add_annotation-584"><a href="#Story.add_annotation-584"><span class="linenos">584</span></a>            <span class="n">y_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shorthand</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Story.add_annotation-585"><a href="#Story.add_annotation-585"><span class="linenos">585</span></a>
</span><span id="Story.add_annotation-586"><a href="#Story.add_annotation-586"><span class="linenos">586</span></a>        <span class="c1"># Explanation of data type extraction:</span>
</span><span id="Story.add_annotation-587"><a href="#Story.add_annotation-587"><span class="linenos">587</span></a>        <span class="c1"># 1. We first check whether the encoding has been defined. This is important because</span>
</span><span id="Story.add_annotation-588"><a href="#Story.add_annotation-588"><span class="linenos">588</span></a>        <span class="c1"># the user may call this method before defining the encoding of the graph.</span>
</span><span id="Story.add_annotation-589"><a href="#Story.add_annotation-589"><span class="linenos">589</span></a>        <span class="c1"># (The encoding in Altair defines how the data is mapped to the visual properties of the graph).</span>
</span><span id="Story.add_annotation-590"><a href="#Story.add_annotation-590"><span class="linenos">590</span></a>        <span class="c1"># 2. If encoding is not defined, we use ‘Q’ (Quantitative) as the default data type</span>
</span><span id="Story.add_annotation-591"><a href="#Story.add_annotation-591"><span class="linenos">591</span></a>        <span class="c1"># for both axes. This allows the method to work even without a defined encoding.</span>
</span><span id="Story.add_annotation-592"><a href="#Story.add_annotation-592"><span class="linenos">592</span></a>        <span class="c1"># 3. If the encoding is defined, we proceed with the data type extraction as before:</span>
</span><span id="Story.add_annotation-593"><a href="#Story.add_annotation-593"><span class="linenos">593</span></a>        <span class="c1"># - self.chart.encoding.x.shorthand: accesses the shorthand of the x-axis</span>
</span><span id="Story.add_annotation-594"><a href="#Story.add_annotation-594"><span class="linenos">594</span></a>        <span class="c1"># .shorthand: In Altair, ‘shorthand’ is a concise notation for specifying the encoding.</span>
</span><span id="Story.add_annotation-595"><a href="#Story.add_annotation-595"><span class="linenos">595</span></a>        <span class="c1"># Example of shorthand: ‘column:Q’ where ‘column’ is the name of the data column</span>
</span><span id="Story.add_annotation-596"><a href="#Story.add_annotation-596"><span class="linenos">596</span></a>        <span class="c1"># and ‘Q’ is the data type (in this case, Quantitative).</span>
</span><span id="Story.add_annotation-597"><a href="#Story.add_annotation-597"><span class="linenos">597</span></a>        <span class="c1"># - split(‘:’)[-1]: splits the shorthand at ‘:’ and takes the last element (the data type)</span>
</span><span id="Story.add_annotation-598"><a href="#Story.add_annotation-598"><span class="linenos">598</span></a>        <span class="c1"># Example: If shorthand is ‘price:Q’, split(‘:’) will return [‘price’, ‘Q’].</span>
</span><span id="Story.add_annotation-599"><a href="#Story.add_annotation-599"><span class="linenos">599</span></a>        <span class="c1"># 4. The extracted data type will be one of:</span>
</span><span id="Story.add_annotation-600"><a href="#Story.add_annotation-600"><span class="linenos">600</span></a>        <span class="c1"># - ‘Q’: Quantitative (continuous numeric)</span>
</span><span id="Story.add_annotation-601"><a href="#Story.add_annotation-601"><span class="linenos">601</span></a>        <span class="c1"># - ‘O’: Ordinal (ordered categories)</span>
</span><span id="Story.add_annotation-602"><a href="#Story.add_annotation-602"><span class="linenos">602</span></a>        <span class="c1"># N&#39;: Nominal (unordered categories)</span>
</span><span id="Story.add_annotation-603"><a href="#Story.add_annotation-603"><span class="linenos">603</span></a>        <span class="c1"># T&#39;: Temporal (dates or times)</span>
</span><span id="Story.add_annotation-604"><a href="#Story.add_annotation-604"><span class="linenos">604</span></a>        
</span><span id="Story.add_annotation-605"><a href="#Story.add_annotation-605"><span class="linenos">605</span></a>        <span class="c1"># Important: This operation is essential to ensure that the annotations</span>
</span><span id="Story.add_annotation-606"><a href="#Story.add_annotation-606"><span class="linenos">606</span></a>        <span class="c1"># added to the graph are consistent with the original axis data types.</span>
</span><span id="Story.add_annotation-607"><a href="#Story.add_annotation-607"><span class="linenos">607</span></a>        <span class="c1"># Without this match, annotations may be positioned</span>
</span><span id="Story.add_annotation-608"><a href="#Story.add_annotation-608"><span class="linenos">608</span></a>        <span class="c1"># incorrectly or cause rendering errors.</span>
</span><span id="Story.add_annotation-609"><a href="#Story.add_annotation-609"><span class="linenos">609</span></a>
</span><span id="Story.add_annotation-610"><a href="#Story.add_annotation-610"><span class="linenos">610</span></a>        <span class="c1"># Create a DataFrame with a single point for the annotation</span>
</span><span id="Story.add_annotation-611"><a href="#Story.add_annotation-611"><span class="linenos">611</span></a>        <span class="n">annotation_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x_point</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">y_point</span><span class="p">]})</span>
</span><span id="Story.add_annotation-612"><a href="#Story.add_annotation-612"><span class="linenos">612</span></a>        
</span><span id="Story.add_annotation-613"><a href="#Story.add_annotation-613"><span class="linenos">613</span></a>        <span class="c1"># Internal function to create the correct encoding based on the data type</span>
</span><span id="Story.add_annotation-614"><a href="#Story.add_annotation-614"><span class="linenos">614</span></a>        <span class="k">def</span> <span class="nf">create_encoding</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="Story.add_annotation-615"><a href="#Story.add_annotation-615"><span class="linenos">615</span></a>            <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.add_annotation-616"><a href="#Story.add_annotation-616"><span class="linenos">616</span></a><span class="sd">            Creates the appropriate encoding for Altair based on the data type.</span>
</span><span id="Story.add_annotation-617"><a href="#Story.add_annotation-617"><span class="linenos">617</span></a><span class="sd">            This function is crucial to ensure that the annotation is</span>
</span><span id="Story.add_annotation-618"><a href="#Story.add_annotation-618"><span class="linenos">618</span></a><span class="sd">            consistent with the original chart data type.</span>
</span><span id="Story.add_annotation-619"><a href="#Story.add_annotation-619"><span class="linenos">619</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="Story.add_annotation-620"><a href="#Story.add_annotation-620"><span class="linenos">620</span></a>            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>  <span class="c1"># Ordinale</span>
</span><span id="Story.add_annotation-621"><a href="#Story.add_annotation-621"><span class="linenos">621</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:O&#39;</span><span class="p">)</span>
</span><span id="Story.add_annotation-622"><a href="#Story.add_annotation-622"><span class="linenos">622</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>  <span class="c1"># Nominale</span>
</span><span id="Story.add_annotation-623"><a href="#Story.add_annotation-623"><span class="linenos">623</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:N&#39;</span><span class="p">)</span>
</span><span id="Story.add_annotation-624"><a href="#Story.add_annotation-624"><span class="linenos">624</span></a>            <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>  <span class="c1"># Temporale</span>
</span><span id="Story.add_annotation-625"><a href="#Story.add_annotation-625"><span class="linenos">625</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:T&#39;</span><span class="p">)</span>
</span><span id="Story.add_annotation-626"><a href="#Story.add_annotation-626"><span class="linenos">626</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Quantitativo (default)</span>
</span><span id="Story.add_annotation-627"><a href="#Story.add_annotation-627"><span class="linenos">627</span></a>                <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="k">else</span> <span class="n">alt</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;:Q&#39;</span><span class="p">)</span>
</span><span id="Story.add_annotation-628"><a href="#Story.add_annotation-628"><span class="linenos">628</span></a>
</span><span id="Story.add_annotation-629"><a href="#Story.add_annotation-629"><span class="linenos">629</span></a>        <span class="c1"># Initialises the list of annotation layers</span>
</span><span id="Story.add_annotation-630"><a href="#Story.add_annotation-630"><span class="linenos">630</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.add_annotation-631"><a href="#Story.add_annotation-631"><span class="linenos">631</span></a>
</span><span id="Story.add_annotation-632"><a href="#Story.add_annotation-632"><span class="linenos">632</span></a>        <span class="c1"># Adds full stop if required</span>
</span><span id="Story.add_annotation-633"><a href="#Story.add_annotation-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="n">show_point</span><span class="p">:</span>
</span><span id="Story.add_annotation-634"><a href="#Story.add_annotation-634"><span class="linenos">634</span></a>            <span class="n">point_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_point</span><span class="p">(</span>
</span><span id="Story.add_annotation-635"><a href="#Story.add_annotation-635"><span class="linenos">635</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
</span><span id="Story.add_annotation-636"><a href="#Story.add_annotation-636"><span class="linenos">636</span></a>                <span class="n">size</span><span class="o">=</span><span class="n">point_size</span>
</span><span id="Story.add_annotation-637"><a href="#Story.add_annotation-637"><span class="linenos">637</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_annotation-638"><a href="#Story.add_annotation-638"><span class="linenos">638</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story.add_annotation-639"><a href="#Story.add_annotation-639"><span class="linenos">639</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story.add_annotation-640"><a href="#Story.add_annotation-640"><span class="linenos">640</span></a>            <span class="p">)</span>
</span><span id="Story.add_annotation-641"><a href="#Story.add_annotation-641"><span class="linenos">641</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_layer</span><span class="p">)</span>
</span><span id="Story.add_annotation-642"><a href="#Story.add_annotation-642"><span class="linenos">642</span></a>
</span><span id="Story.add_annotation-643"><a href="#Story.add_annotation-643"><span class="linenos">643</span></a>        <span class="c1"># Adds the arrow</span>
</span><span id="Story.add_annotation-644"><a href="#Story.add_annotation-644"><span class="linenos">644</span></a>        <span class="c1"># Utilizziamo mark_text per disegnare la freccia usando un carattere Unicode</span>
</span><span id="Story.add_annotation-645"><a href="#Story.add_annotation-645"><span class="linenos">645</span></a>        <span class="n">arrow_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.add_annotation-646"><a href="#Story.add_annotation-646"><span class="linenos">646</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">arrow_symbol</span><span class="p">,</span> 
</span><span id="Story.add_annotation-647"><a href="#Story.add_annotation-647"><span class="linenos">647</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">arrow_size</span><span class="p">,</span>
</span><span id="Story.add_annotation-648"><a href="#Story.add_annotation-648"><span class="linenos">648</span></a>            <span class="n">dx</span><span class="o">=</span><span class="n">arrow_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position the arrow                   was 22</span>
</span><span id="Story.add_annotation-649"><a href="#Story.add_annotation-649"><span class="linenos">649</span></a>            <span class="n">dy</span><span class="o">=</span><span class="n">arrow_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position the arrow                     was -22</span>
</span><span id="Story.add_annotation-650"><a href="#Story.add_annotation-650"><span class="linenos">650</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span>
</span><span id="Story.add_annotation-651"><a href="#Story.add_annotation-651"><span class="linenos">651</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_annotation-652"><a href="#Story.add_annotation-652"><span class="linenos">652</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story.add_annotation-653"><a href="#Story.add_annotation-653"><span class="linenos">653</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story.add_annotation-654"><a href="#Story.add_annotation-654"><span class="linenos">654</span></a>        <span class="p">)</span>
</span><span id="Story.add_annotation-655"><a href="#Story.add_annotation-655"><span class="linenos">655</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arrow_layer</span><span class="p">)</span>
</span><span id="Story.add_annotation-656"><a href="#Story.add_annotation-656"><span class="linenos">656</span></a>
</span><span id="Story.add_annotation-657"><a href="#Story.add_annotation-657"><span class="linenos">657</span></a>        <span class="c1"># Adds text label</span>
</span><span id="Story.add_annotation-658"><a href="#Story.add_annotation-658"><span class="linenos">658</span></a>        <span class="n">label_layer</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">annotation_data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.add_annotation-659"><a href="#Story.add_annotation-659"><span class="linenos">659</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-660"><a href="#Story.add_annotation-660"><span class="linenos">660</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-661"><a href="#Story.add_annotation-661"><span class="linenos">661</span></a>            <span class="n">dx</span><span class="o">=</span> <span class="n">label_dx</span><span class="p">,</span>  <span class="c1"># Horizontal offset to position text                     was 37</span>
</span><span id="Story.add_annotation-662"><a href="#Story.add_annotation-662"><span class="linenos">662</span></a>            <span class="n">dy</span><span class="o">=</span> <span class="n">label_dy</span><span class="p">,</span>  <span class="c1"># Vertical offset to position text                       was -37</span>
</span><span id="Story.add_annotation-663"><a href="#Story.add_annotation-663"><span class="linenos">663</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="n">label_size</span><span class="p">,</span>
</span><span id="Story.add_annotation-664"><a href="#Story.add_annotation-664"><span class="linenos">664</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">label_color</span><span class="p">,</span>
</span><span id="Story.add_annotation-665"><a href="#Story.add_annotation-665"><span class="linenos">665</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">annotation_text</span>
</span><span id="Story.add_annotation-666"><a href="#Story.add_annotation-666"><span class="linenos">666</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.add_annotation-667"><a href="#Story.add_annotation-667"><span class="linenos">667</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x_type</span><span class="p">),</span>
</span><span id="Story.add_annotation-668"><a href="#Story.add_annotation-668"><span class="linenos">668</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">create_encoding</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
</span><span id="Story.add_annotation-669"><a href="#Story.add_annotation-669"><span class="linenos">669</span></a>        <span class="p">)</span>
</span><span id="Story.add_annotation-670"><a href="#Story.add_annotation-670"><span class="linenos">670</span></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_layer</span><span class="p">)</span>
</span><span id="Story.add_annotation-671"><a href="#Story.add_annotation-671"><span class="linenos">671</span></a>
</span><span id="Story.add_annotation-672"><a href="#Story.add_annotation-672"><span class="linenos">672</span></a>        <span class="c1"># Combine all layers into a single annotation</span>
</span><span id="Story.add_annotation-673"><a href="#Story.add_annotation-673"><span class="linenos">673</span></a>        <span class="n">annotation</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="Story.add_annotation-674"><a href="#Story.add_annotation-674"><span class="linenos">674</span></a>
</span><span id="Story.add_annotation-675"><a href="#Story.add_annotation-675"><span class="linenos">675</span></a>        <span class="c1"># Adds annotation to history layers</span>
</span><span id="Story.add_annotation-676"><a href="#Story.add_annotation-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Story.add_annotation-677"><a href="#Story.add_annotation-677"><span class="linenos">677</span></a>            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;annotation&#39;</span><span class="p">,</span>
</span><span id="Story.add_annotation-678"><a href="#Story.add_annotation-678"><span class="linenos">678</span></a>            <span class="s1">&#39;chart&#39;</span><span class="p">:</span> <span class="n">annotation</span>
</span><span id="Story.add_annotation-679"><a href="#Story.add_annotation-679"><span class="linenos">679</span></a>        <span class="p">})</span>
</span><span id="Story.add_annotation-680"><a href="#Story.add_annotation-680"><span class="linenos">680</span></a>
</span><span id="Story.add_annotation-681"><a href="#Story.add_annotation-681"><span class="linenos">681</span></a>        <span class="c1"># Note on flexibility and robustness:</span>
</span><span id="Story.add_annotation-682"><a href="#Story.add_annotation-682"><span class="linenos">682</span></a>        <span class="c1"># This approach makes the add_annotation method more flexible,</span>
</span><span id="Story.add_annotation-683"><a href="#Story.add_annotation-683"><span class="linenos">683</span></a>        <span class="c1"># as it can automatically adapt to different types of graphs without</span>
</span><span id="Story.add_annotation-684"><a href="#Story.add_annotation-684"><span class="linenos">684</span></a>        <span class="c1"># requiring manual input on the axis data type. In addition, using</span>
</span><span id="Story.add_annotation-685"><a href="#Story.add_annotation-685"><span class="linenos">685</span></a>        <span class="c1"># the Altair shorthand, the code automatically adapts even if the user</span>
</span><span id="Story.add_annotation-686"><a href="#Story.add_annotation-686"><span class="linenos">686</span></a>        <span class="c1"># has specified the encoding in different ways (e.g., using alt.X(‘column:Q’)</span>
</span><span id="Story.add_annotation-687"><a href="#Story.add_annotation-687"><span class="linenos">687</span></a>        <span class="c1"># or alt.X(‘column’, type=‘quantitative’)).</span>
</span><span id="Story.add_annotation-688"><a href="#Story.add_annotation-688"><span class="linenos">688</span></a>
</span><span id="Story.add_annotation-689"><a href="#Story.add_annotation-689"><span class="linenos">689</span></a>
</span><span id="Story.add_annotation-690"><a href="#Story.add_annotation-690"><span class="linenos">690</span></a>        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># Return self to allow method chaining</span>
</span></pre></div>


            <div class="docstring"><p>Create an arrow annotation on the graph.</p>

<p>This method is essential for highlighting specific points in the graph and adding
contextual explanations. It is particularly useful for data narration, allowing
to guide the observer's attention to relevant aspects of the visualisation.</p>

<p>Parameters:</p>

<ul>
<li>x_point, y_point: Coordinates of the point to be annotated</li>
<li>annotation_text: Text of the annotation (default: ‘Point of interest’)</li>
<li>arrow_direction: Direction of the arrow (default: ‘right’)</li>
<li>arrow_color, arrow_size: Arrow colour and size</li>
<li>label_colour, label_size: Colour and size of the annotation text</li>
<li>show_point: If True, shows a point at the annotation location</li>
<li>point_color, point_size: Colour and size of the point</li>
<li>arrow_dx, arrow_dy: Distances in pixels to be added to the arrow position (default:0, -45)</li>
<li>label_dx, label_dy: Distances in pixels to be added to the label position (default:37, -37)</li>
</ul>

<p>returns:</p>

<ul>
<li>self, to allow method chaining</li>
</ul>
</div>


                            </div>
                            <div id="Story.em_to_px" class="classattr">
                                        <input id="Story.em_to_px-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">em_to_px</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">em</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.em_to_px-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.em_to_px"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.em_to_px-692"><a href="#Story.em_to_px-692"><span class="linenos">692</span></a>    <span class="k">def</span> <span class="nf">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">em</span><span class="p">):</span>
</span><span id="Story.em_to_px-693"><a href="#Story.em_to_px-693"><span class="linenos">693</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.em_to_px-694"><a href="#Story.em_to_px-694"><span class="linenos">694</span></a><span class="sd">        Converts a dimension from em to pixels.</span>
</span><span id="Story.em_to_px-695"><a href="#Story.em_to_px-695"><span class="linenos">695</span></a>
</span><span id="Story.em_to_px-696"><a href="#Story.em_to_px-696"><span class="linenos">696</span></a><span class="sd">        This function is essential for maintaining visual consistency</span>
</span><span id="Story.em_to_px-697"><a href="#Story.em_to_px-697"><span class="linenos">697</span></a><span class="sd">        between different textual elements and devices.</span>
</span><span id="Story.em_to_px-698"><a href="#Story.em_to_px-698"><span class="linenos">698</span></a>
</span><span id="Story.em_to_px-699"><a href="#Story.em_to_px-699"><span class="linenos">699</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.em_to_px-700"><a href="#Story.em_to_px-700"><span class="linenos">700</span></a><span class="sd">        - em: Size in em</span>
</span><span id="Story.em_to_px-701"><a href="#Story.em_to_px-701"><span class="linenos">701</span></a>
</span><span id="Story.em_to_px-702"><a href="#Story.em_to_px-702"><span class="linenos">702</span></a><span class="sd">        Returns:</span>
</span><span id="Story.em_to_px-703"><a href="#Story.em_to_px-703"><span class="linenos">703</span></a><span class="sd">        - Equivalent size in pixels (integer)</span>
</span><span id="Story.em_to_px-704"><a href="#Story.em_to_px-704"><span class="linenos">704</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.em_to_px-705"><a href="#Story.em_to_px-705"><span class="linenos">705</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">em</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_font_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts a dimension from em to pixels.</p>

<p>This function is essential for maintaining visual consistency
between different textual elements and devices.</p>

<p>Parameters:</p>

<ul>
<li>em: Size in em</li>
</ul>

<p>Returns:</p>

<ul>
<li>Equivalent size in pixels (integer)</li>
</ul>
</div>


                            </div>
                            <div id="Story.create_title_layer" class="classattr">
                                        <input id="Story.create_title_layer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_title_layer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">layer</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.create_title_layer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.create_title_layer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.create_title_layer-737"><a href="#Story.create_title_layer-737"><span class="linenos">737</span></a>    <span class="k">def</span> <span class="nf">create_title_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="Story.create_title_layer-738"><a href="#Story.create_title_layer-738"><span class="linenos">738</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.create_title_layer-739"><a href="#Story.create_title_layer-739"><span class="linenos">739</span></a><span class="sd">        Creates the title layer (and subtitle if present).</span>
</span><span id="Story.create_title_layer-740"><a href="#Story.create_title_layer-740"><span class="linenos">740</span></a>
</span><span id="Story.create_title_layer-741"><a href="#Story.create_title_layer-741"><span class="linenos">741</span></a><span class="sd">        This method is responsible for visually creating the main title</span>
</span><span id="Story.create_title_layer-742"><a href="#Story.create_title_layer-742"><span class="linenos">742</span></a><span class="sd">        and the optional subtitle of the graphic.</span>
</span><span id="Story.create_title_layer-743"><a href="#Story.create_title_layer-743"><span class="linenos">743</span></a>
</span><span id="Story.create_title_layer-744"><a href="#Story.create_title_layer-744"><span class="linenos">744</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.create_title_layer-745"><a href="#Story.create_title_layer-745"><span class="linenos">745</span></a><span class="sd">        - Layer: Dictionary containing the title information</span>
</span><span id="Story.create_title_layer-746"><a href="#Story.create_title_layer-746"><span class="linenos">746</span></a>
</span><span id="Story.create_title_layer-747"><a href="#Story.create_title_layer-747"><span class="linenos">747</span></a><span class="sd">        Returns:</span>
</span><span id="Story.create_title_layer-748"><a href="#Story.create_title_layer-748"><span class="linenos">748</span></a><span class="sd">        - Altair Chart object representing the title layer</span>
</span><span id="Story.create_title_layer-749"><a href="#Story.create_title_layer-749"><span class="linenos">749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.create_title_layer-750"><a href="#Story.create_title_layer-750"><span class="linenos">750</span></a>        <span class="n">title_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.create_title_layer-751"><a href="#Story.create_title_layer-751"><span class="linenos">751</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="Story.create_title_layer-752"><a href="#Story.create_title_layer-752"><span class="linenos">752</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]),</span>
</span><span id="Story.create_title_layer-753"><a href="#Story.create_title_layer-753"><span class="linenos">753</span></a>            <span class="n">fontWeight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
</span><span id="Story.create_title_layer-754"><a href="#Story.create_title_layer-754"><span class="linenos">754</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story.create_title_layer-755"><a href="#Story.create_title_layer-755"><span class="linenos">755</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story.create_title_layer-756"><a href="#Story.create_title_layer-756"><span class="linenos">756</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;title_color&#39;</span><span class="p">]</span>
</span><span id="Story.create_title_layer-757"><a href="#Story.create_title_layer-757"><span class="linenos">757</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.create_title_layer-758"><a href="#Story.create_title_layer-758"><span class="linenos">758</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="Story.create_title_layer-759"><a href="#Story.create_title_layer-759"><span class="linenos">759</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Position 20 pixels from above</span>
</span><span id="Story.create_title_layer-760"><a href="#Story.create_title_layer-760"><span class="linenos">760</span></a>        <span class="p">)</span>
</span><span id="Story.create_title_layer-761"><a href="#Story.create_title_layer-761"><span class="linenos">761</span></a>        
</span><span id="Story.create_title_layer-762"><a href="#Story.create_title_layer-762"><span class="linenos">762</span></a>        <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]:</span>
</span><span id="Story.create_title_layer-763"><a href="#Story.create_title_layer-763"><span class="linenos">763</span></a>            <span class="n">subtitle_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.create_title_layer-764"><a href="#Story.create_title_layer-764"><span class="linenos">764</span></a>                <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">],</span>
</span><span id="Story.create_title_layer-765"><a href="#Story.create_title_layer-765"><span class="linenos">765</span></a>                <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]),</span>
</span><span id="Story.create_title_layer-766"><a href="#Story.create_title_layer-766"><span class="linenos">766</span></a>                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story.create_title_layer-767"><a href="#Story.create_title_layer-767"><span class="linenos">767</span></a>                <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story.create_title_layer-768"><a href="#Story.create_title_layer-768"><span class="linenos">768</span></a>                <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;subtitle_color&#39;</span><span class="p">]</span>
</span><span id="Story.create_title_layer-769"><a href="#Story.create_title_layer-769"><span class="linenos">769</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.create_title_layer-770"><a href="#Story.create_title_layer-770"><span class="linenos">770</span></a>                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>  <span class="c1"># Centre horizontally</span>
</span><span id="Story.create_title_layer-771"><a href="#Story.create_title_layer-771"><span class="linenos">771</span></a>                <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Position 50 pixels from the top (below the title)</span>
</span><span id="Story.create_title_layer-772"><a href="#Story.create_title_layer-772"><span class="linenos">772</span></a>            <span class="p">)</span>
</span><span id="Story.create_title_layer-773"><a href="#Story.create_title_layer-773"><span class="linenos">773</span></a>            <span class="k">return</span> <span class="n">title_chart</span> <span class="o">+</span> <span class="n">subtitle_chart</span>
</span><span id="Story.create_title_layer-774"><a href="#Story.create_title_layer-774"><span class="linenos">774</span></a>        <span class="k">return</span> <span class="n">title_chart</span>
</span></pre></div>


            <div class="docstring"><p>Creates the title layer (and subtitle if present).</p>

<p>This method is responsible for visually creating the main title
and the optional subtitle of the graphic.</p>

<p>Parameters:</p>

<ul>
<li>Layer: Dictionary containing the title information</li>
</ul>

<p>Returns:</p>

<ul>
<li>Altair Chart object representing the title layer</li>
</ul>
</div>


                            </div>
                            <div id="Story.create_text_layer" class="classattr">
                                        <input id="Story.create_text_layer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_text_layer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">layer</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.create_text_layer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.create_text_layer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.create_text_layer-776"><a href="#Story.create_text_layer-776"><span class="linenos">776</span></a>    <span class="k">def</span> <span class="nf">create_text_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
</span><span id="Story.create_text_layer-777"><a href="#Story.create_text_layer-777"><span class="linenos">777</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.create_text_layer-778"><a href="#Story.create_text_layer-778"><span class="linenos">778</span></a><span class="sd">        Creates a generic text layer (context, call-to-action, source).</span>
</span><span id="Story.create_text_layer-779"><a href="#Story.create_text_layer-779"><span class="linenos">779</span></a>
</span><span id="Story.create_text_layer-780"><a href="#Story.create_text_layer-780"><span class="linenos">780</span></a><span class="sd">        This method is used to create text layers for various narrative purposes,</span>
</span><span id="Story.create_text_layer-781"><a href="#Story.create_text_layer-781"><span class="linenos">781</span></a><span class="sd">        such as adding context, call-to-action or data source information.</span>
</span><span id="Story.create_text_layer-782"><a href="#Story.create_text_layer-782"><span class="linenos">782</span></a>
</span><span id="Story.create_text_layer-783"><a href="#Story.create_text_layer-783"><span class="linenos">783</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.create_text_layer-784"><a href="#Story.create_text_layer-784"><span class="linenos">784</span></a><span class="sd">        - Layer: Dictionary containing the text information to be added</span>
</span><span id="Story.create_text_layer-785"><a href="#Story.create_text_layer-785"><span class="linenos">785</span></a>
</span><span id="Story.create_text_layer-786"><a href="#Story.create_text_layer-786"><span class="linenos">786</span></a><span class="sd">        Returns:</span>
</span><span id="Story.create_text_layer-787"><a href="#Story.create_text_layer-787"><span class="linenos">787</span></a><span class="sd">        - Altair Chart object representing the text layer</span>
</span><span id="Story.create_text_layer-788"><a href="#Story.create_text_layer-788"><span class="linenos">788</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.create_text_layer-789"><a href="#Story.create_text_layer-789"><span class="linenos">789</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">)</span>
</span><span id="Story.create_text_layer-790"><a href="#Story.create_text_layer-790"><span class="linenos">790</span></a>        <span class="k">return</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chart</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_text</span><span class="p">(</span>
</span><span id="Story.create_text_layer-791"><a href="#Story.create_text_layer-791"><span class="linenos">791</span></a>            <span class="n">text</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span>
</span><span id="Story.create_text_layer-792"><a href="#Story.create_text_layer-792"><span class="linenos">792</span></a>            <span class="n">fontSize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">em_to_px</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font_sizes</span><span class="p">[</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]),</span>
</span><span id="Story.create_text_layer-793"><a href="#Story.create_text_layer-793"><span class="linenos">793</span></a>            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
</span><span id="Story.create_text_layer-794"><a href="#Story.create_text_layer-794"><span class="linenos">794</span></a>            <span class="n">baseline</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
</span><span id="Story.create_text_layer-795"><a href="#Story.create_text_layer-795"><span class="linenos">795</span></a>            <span class="n">font</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">,</span>
</span><span id="Story.create_text_layer-796"><a href="#Story.create_text_layer-796"><span class="linenos">796</span></a>            <span class="n">angle</span><span class="o">=</span><span class="mi">270</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">#  Rotate text if ‘vertical’ is True</span>
</span><span id="Story.create_text_layer-797"><a href="#Story.create_text_layer-797"><span class="linenos">797</span></a>            <span class="n">color</span><span class="o">=</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
</span><span id="Story.create_text_layer-798"><a href="#Story.create_text_layer-798"><span class="linenos">798</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
</span><span id="Story.create_text_layer-799"><a href="#Story.create_text_layer-799"><span class="linenos">799</span></a>            <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
</span><span id="Story.create_text_layer-800"><a href="#Story.create_text_layer-800"><span class="linenos">800</span></a>            <span class="n">y</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Story.create_text_layer-801"><a href="#Story.create_text_layer-801"><span class="linenos">801</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a generic text layer (context, call-to-action, source).</p>

<p>This method is used to create text layers for various narrative purposes,
such as adding context, call-to-action or data source information.</p>

<p>Parameters:</p>

<ul>
<li>Layer: Dictionary containing the text information to be added</li>
</ul>

<p>Returns:</p>

<ul>
<li>Altair Chart object representing the text layer</li>
</ul>
</div>


                            </div>
                            <div id="Story.configure_view" class="classattr">
                                        <input id="Story.configure_view-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">configure_view</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.configure_view-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.configure_view"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.configure_view-803"><a href="#Story.configure_view-803"><span class="linenos">803</span></a>    <span class="k">def</span> <span class="nf">configure_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Story.configure_view-804"><a href="#Story.configure_view-804"><span class="linenos">804</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.configure_view-805"><a href="#Story.configure_view-805"><span class="linenos">805</span></a><span class="sd">        Configure aspects of the graph view using Altair&#39;s configure_view method.</span>
</span><span id="Story.configure_view-806"><a href="#Story.configure_view-806"><span class="linenos">806</span></a>
</span><span id="Story.configure_view-807"><a href="#Story.configure_view-807"><span class="linenos">807</span></a><span class="sd">        This method allows you to configure various aspects of the chart view, such as</span>
</span><span id="Story.configure_view-808"><a href="#Story.configure_view-808"><span class="linenos">808</span></a><span class="sd">        the background colour, border style, internal spacing, etc.</span>
</span><span id="Story.configure_view-809"><a href="#Story.configure_view-809"><span class="linenos">809</span></a>
</span><span id="Story.configure_view-810"><a href="#Story.configure_view-810"><span class="linenos">810</span></a><span class="sd">        Parameters:</span>
</span><span id="Story.configure_view-811"><a href="#Story.configure_view-811"><span class="linenos">811</span></a><span class="sd">        *args, **kwargs: Arguments to pass to the Altair configure_view method.</span>
</span><span id="Story.configure_view-812"><a href="#Story.configure_view-812"><span class="linenos">812</span></a>
</span><span id="Story.configure_view-813"><a href="#Story.configure_view-813"><span class="linenos">813</span></a><span class="sd">        stores the view configuration for application during rendering.</span>
</span><span id="Story.configure_view-814"><a href="#Story.configure_view-814"><span class="linenos">814</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.configure_view-815"><a href="#Story.configure_view-815"><span class="linenos">815</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="Story.configure_view-816"><a href="#Story.configure_view-816"><span class="linenos">816</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Configure aspects of the graph view using Altair's configure_view method.</p>

<p>This method allows you to configure various aspects of the chart view, such as
the background colour, border style, internal spacing, etc.</p>

<p>Parameters:
<em>args, *</em>kwargs: Arguments to pass to the Altair configure_view method.</p>

<p>stores the view configuration for application during rendering.</p>
</div>


                            </div>
                            <div id="Story.render" class="classattr">
                                        <input id="Story.render-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">render</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Story.render-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Story.render"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Story.render-819"><a href="#Story.render-819"><span class="linenos">819</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Story.render-820"><a href="#Story.render-820"><span class="linenos">820</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Story.render-821"><a href="#Story.render-821"><span class="linenos">821</span></a><span class="sd">        It renders all layers of the story in a single graphic.       </span>
</span><span id="Story.render-822"><a href="#Story.render-822"><span class="linenos">822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Story.render-823"><a href="#Story.render-823"><span class="linenos">823</span></a>        <span class="c1"># Let&#39;s start with the basic graph</span>
</span><span id="Story.render-824"><a href="#Story.render-824"><span class="linenos">824</span></a>        <span class="n">main_chart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chart</span>
</span><span id="Story.render-825"><a href="#Story.render-825"><span class="linenos">825</span></a>        
</span><span id="Story.render-826"><a href="#Story.render-826"><span class="linenos">826</span></a>        <span class="c1"># We create separate lists to place special graphics</span>
</span><span id="Story.render-827"><a href="#Story.render-827"><span class="linenos">827</span></a>        <span class="n">top_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.render-828"><a href="#Story.render-828"><span class="linenos">828</span></a>        <span class="n">bottom_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.render-829"><a href="#Story.render-829"><span class="linenos">829</span></a>        <span class="n">left_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.render-830"><a href="#Story.render-830"><span class="linenos">830</span></a>        <span class="n">right_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.render-831"><a href="#Story.render-831"><span class="linenos">831</span></a>        <span class="n">overlay_charts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Story.render-832"><a href="#Story.render-832"><span class="linenos">832</span></a>        
</span><span id="Story.render-833"><a href="#Story.render-833"><span class="linenos">833</span></a>        <span class="c1"># We organise the layers according to their position</span>
</span><span id="Story.render-834"><a href="#Story.render-834"><span class="linenos">834</span></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_layers</span><span class="p">:</span>
</span><span id="Story.render-835"><a href="#Story.render-835"><span class="linenos">835</span></a>            <span class="k">if</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;special_cta&#39;</span><span class="p">:</span>
</span><span id="Story.render-836"><a href="#Story.render-836"><span class="linenos">836</span></a>                <span class="c1"># We take the position from the layer</span>
</span><span id="Story.render-837"><a href="#Story.render-837"><span class="linenos">837</span></a>                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
</span><span id="Story.render-838"><a href="#Story.render-838"><span class="linenos">838</span></a>                    <span class="n">top_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story.render-839"><a href="#Story.render-839"><span class="linenos">839</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
</span><span id="Story.render-840"><a href="#Story.render-840"><span class="linenos">840</span></a>                    <span class="n">bottom_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story.render-841"><a href="#Story.render-841"><span class="linenos">841</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
</span><span id="Story.render-842"><a href="#Story.render-842"><span class="linenos">842</span></a>                    <span class="n">left_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story.render-843"><a href="#Story.render-843"><span class="linenos">843</span></a>                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
</span><span id="Story.render-844"><a href="#Story.render-844"><span class="linenos">844</span></a>                    <span class="n">right_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story.render-845"><a href="#Story.render-845"><span class="linenos">845</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span>
</span><span id="Story.render-846"><a href="#Story.render-846"><span class="linenos">846</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_title_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="Story.render-847"><a href="#Story.render-847"><span class="linenos">847</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;cta&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">]:</span>
</span><span id="Story.render-848"><a href="#Story.render-848"><span class="linenos">848</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_text_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
</span><span id="Story.render-849"><a href="#Story.render-849"><span class="linenos">849</span></a>            <span class="k">elif</span> <span class="n">layer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;shape_label&#39;</span><span class="p">,</span> <span class="s1">&#39;annotation&#39;</span><span class="p">]:</span>
</span><span id="Story.render-850"><a href="#Story.render-850"><span class="linenos">850</span></a>                <span class="n">overlay_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="s1">&#39;chart&#39;</span><span class="p">])</span>
</span><span id="Story.render-851"><a href="#Story.render-851"><span class="linenos">851</span></a>
</span><span id="Story.render-852"><a href="#Story.render-852"><span class="linenos">852</span></a>        <span class="c1"># Overlaying the layers on the main graph</span>
</span><span id="Story.render-853"><a href="#Story.render-853"><span class="linenos">853</span></a>        <span class="k">for</span> <span class="n">overlay</span> <span class="ow">in</span> <span class="n">overlay_charts</span><span class="p">:</span>
</span><span id="Story.render-854"><a href="#Story.render-854"><span class="linenos">854</span></a>            <span class="n">main_chart</span> <span class="o">+=</span> <span class="n">overlay</span>
</span><span id="Story.render-855"><a href="#Story.render-855"><span class="linenos">855</span></a>
</span><span id="Story.render-856"><a href="#Story.render-856"><span class="linenos">856</span></a>        <span class="c1"># We build the final layout</span>
</span><span id="Story.render-857"><a href="#Story.render-857"><span class="linenos">857</span></a>        <span class="k">if</span> <span class="n">left_charts</span><span class="p">:</span>
</span><span id="Story.render-858"><a href="#Story.render-858"><span class="linenos">858</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">left_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="Story.render-859"><a href="#Story.render-859"><span class="linenos">859</span></a>        <span class="k">if</span> <span class="n">right_charts</span><span class="p">:</span>
</span><span id="Story.render-860"><a href="#Story.render-860"><span class="linenos">860</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="o">*</span><span class="n">right_charts</span><span class="p">))</span>
</span><span id="Story.render-861"><a href="#Story.render-861"><span class="linenos">861</span></a>        <span class="k">if</span> <span class="n">top_charts</span><span class="p">:</span>
</span><span id="Story.render-862"><a href="#Story.render-862"><span class="linenos">862</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">top_charts</span><span class="p">),</span> <span class="n">main_chart</span><span class="p">)</span>
</span><span id="Story.render-863"><a href="#Story.render-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="n">bottom_charts</span><span class="p">:</span>
</span><span id="Story.render-864"><a href="#Story.render-864"><span class="linenos">864</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">vconcat</span><span class="p">(</span><span class="n">main_chart</span><span class="p">,</span> <span class="n">alt</span><span class="o">.</span><span class="n">hconcat</span><span class="p">(</span><span class="o">*</span><span class="n">bottom_charts</span><span class="p">))</span>
</span><span id="Story.render-865"><a href="#Story.render-865"><span class="linenos">865</span></a>
</span><span id="Story.render-866"><a href="#Story.render-866"><span class="linenos">866</span></a>        <span class="c1"># Apply configurations</span>
</span><span id="Story.render-867"><a href="#Story.render-867"><span class="linenos">867</span></a>        <span class="k">if</span> <span class="s1">&#39;view&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span><span id="Story.render-868"><a href="#Story.render-868"><span class="linenos">868</span></a>            <span class="n">main_chart</span> <span class="o">=</span> <span class="n">main_chart</span><span class="o">.</span><span class="n">configure_view</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">])</span>
</span><span id="Story.render-869"><a href="#Story.render-869"><span class="linenos">869</span></a>
</span><span id="Story.render-870"><a href="#Story.render-870"><span class="linenos">870</span></a>        <span class="k">return</span> <span class="n">main_chart</span>
</span></pre></div>


            <div class="docstring"><p>It renders all layers of the story in a single graphic.</p>
</div>


                            </div>
                </section>
                <section id="story">
                            <input id="story-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">story</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="story-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#story"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="story-876"><a href="#story-876"><span class="linenos">876</span></a><span class="k">def</span> <span class="nf">story</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="story-877"><a href="#story-877"><span class="linenos">877</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="story-878"><a href="#story-878"><span class="linenos">878</span></a><span class="sd">    Utility function for creating a Story instance.</span>
</span><span id="story-879"><a href="#story-879"><span class="linenos">879</span></a>
</span><span id="story-880"><a href="#story-880"><span class="linenos">880</span></a><span class="sd">    This function simplifies the creation of a Story object, allowing</span>
</span><span id="story-881"><a href="#story-881"><span class="linenos">881</span></a><span class="sd">    to initialise it in a more concise and intuitive way.</span>
</span><span id="story-882"><a href="#story-882"><span class="linenos">882</span></a>
</span><span id="story-883"><a href="#story-883"><span class="linenos">883</span></a><span class="sd">    Parameters:</span>
</span><span id="story-884"><a href="#story-884"><span class="linenos">884</span></a><span class="sd">    - data: DataFrame or URL for chart data (default: None)</span>
</span><span id="story-885"><a href="#story-885"><span class="linenos">885</span></a><span class="sd">    - **kwargs: Additional parameters to be passed to the Story constructor</span>
</span><span id="story-886"><a href="#story-886"><span class="linenos">886</span></a>
</span><span id="story-887"><a href="#story-887"><span class="linenos">887</span></a><span class="sd">    Returns:</span>
</span><span id="story-888"><a href="#story-888"><span class="linenos">888</span></a><span class="sd">    - An instance of the Story class</span>
</span><span id="story-889"><a href="#story-889"><span class="linenos">889</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="story-890"><a href="#story-890"><span class="linenos">890</span></a>    <span class="k">return</span> <span class="n">Story</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for creating a Story instance.</p>

<p>This function simplifies the creation of a Story object, allowing
to initialise it in a more concise and intuitive way.</p>

<p>Parameters:</p>

<ul>
<li>data: DataFrame or URL for chart data (default: None)</li>
<li>**kwargs: Additional parameters to be passed to the Story constructor</li>
</ul>

<p>Returns:</p>

<ul>
<li>An instance of the Story class</li>
</ul>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>